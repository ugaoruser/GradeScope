<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subject Management - GradeTracker</title>
  <link rel="icon" href="../favicon.ico" type="image/x-icon">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&display=swap" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.5.0/remixicon.min.css">
  <link rel="stylesheet" href="styles.css">
  <script src="config.js" defer></script>
  <script src="chart.js" defer></script>
  <script src="chatbot.js" defer></script>
  <script src="app.js" defer></script>
</head>
<body class="subject-page">
  <header class="header">
    <div class="header-title" id="subjectTitle">Subject Management</div>
    <div class="account-menu" style="display:flex; align-items:center; gap:10px;">
      <span id="teacherName"></span>
      <button class="account-btn" id="accountBtn"><span id="accountInitial">T</span></button>
      <div class="account-dropdown" id="accountDropdown" aria-hidden="true">
        <div class="account-info">
          <div id="userFullName">Teacher</div>
          <div id="userEmail"></div>
        </div>
        <button id="logoutBtn" class="logout-btn" onclick="logout()">Log Out</button>
      </div>
    </div>
  </header>
  
  <div class="main">
    <button class="back-btn" onclick="goBack()">‚Üê Back to Classes</button>
    
    <div class="quarter-tabs" id="quarterTabs">
      <div class="quarter-tab active" data-quarter="1">Quarter 1</div>
      <div class="quarter-tab" data-quarter="2">Quarter 2</div>
      <div class="quarter-tab" data-quarter="3">Quarter 3</div>
      <div class="quarter-tab" data-quarter="4">Quarter 4</div>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-tab="graded">Graded Components</div>
      <div class="tab" data-tab="assessment">Assessment</div>
    </div>
    
    <div class="students-section">
      <div class="section-header">
        <h2>Enrolled Students</h2>
        <div class="real-time-indicator" id="realtimeStatus">
          <div class="status-dot"></div>
          <span>Real-time updates</span>
        </div>
      </div>

      <div class="students-grid" id="studentsGrid">
        <div class="loading-placeholder" style="height:120px;border-radius:12px;"></div>
        <div class="loading-placeholder" style="height:120px;border-radius:12px;"></div>
        <div class="loading-placeholder" style="height:120px;border-radius:12px;"></div>
      </div>

      <div class="empty-state" id="emptyState" style="display:none;">
        <div class="empty-icon">üë•</div>
        <h3>No students enrolled yet</h3>
        <p>Share your class code <strong id="emptyClassCode">------</strong> with students so they can join your class.</p>
        <button class="btn btn-primary" id="copyEmptyCodeBtn">Copy Class Code</button>
      </div>
    </div>
    
    <div class="class-actions" style="margin-top: 20px;">
      <button class="btn btn-primary" id="manageGradesBtn">Manage Grades</button>
    </div>
    
    <!-- Chatbot Toggle Button -->
    <button id="chatbotToggle" style="position: fixed; right: 24px; bottom: 24px; width: 56px; height: 56px; border-radius: 50%; background:#1976d2; color:#fff; border:none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor:pointer; font-size:24px;">üí¨</button>
    <!-- Chatbot Sidebar -->
    <div id="chatbotSidebar" style="position: fixed; right: -360px; top: 0; width: 360px; height: 100%; background: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease; z-index: 1000; display:flex; flex-direction:column;">
      <div style="padding: 12px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:600;">Assistant</div>
        <button id="closeChatbot" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
      </div>
      <div id="chatLog" style="flex:1; padding: 12px; overflow:auto;">
        <div style="color:#666;">I can help you draft comments and estimate student progress. Ask me something like "Create a comment for Maria in Algebra, score 82" or "Average of 78, 85, 90".</div>
      </div>
      <div style="padding: 12px; border-top:1px solid #eee; display:flex; gap:8px;">
        <input id="chatInput" placeholder="Type a message..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;">
        <button id="sendChat" style="padding:10px 14px; background:#1976d2; color:#fff; border:none; border-radius:6px; cursor:pointer;">Send</button>
      </div>
    </div>
          <button class="btn btn-ghost" onclick="showAnnouncements()">Announcements</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Auth check
    const role = localStorage.getItem('role');
    if (role !== 'teacher') {
      window.location.href = role ? 'homepage1.html' : 'login.html';
    }

    // Get subject from URL
    const urlParams = new URLSearchParams(window.location.search);
    const subjectName = urlParams.get('subject') || urlParams.get('name') || 'Unknown Subject';
    let subjectId = urlParams.get('id');
    let accessCode = '';

    // Initialize page
    document.addEventListener('DOMContentLoaded', async () => {
      setupHeader();
      await loadSubjectDetails();
      await loadStudents();
      setupRealtimeUpdates();
    });

    function setupHeader() {
      document.getElementById('subjectTitle').textContent = subjectName;
      document.getElementById('classTitle').textContent = subjectName;
      
      // Load cached user info
      const fullName = localStorage.getItem('fullName') || 'Teacher';
      const email = localStorage.getItem('email') || '';
      const initial = fullName.charAt(0).toUpperCase();
      
      document.getElementById('accountInitial').textContent = initial;
      document.getElementById('userFullName').textContent = fullName;
      document.getElementById('userEmail').textContent = email;
    }

    async function loadSubjectDetails() {
      try {
        let subject;
        if (subjectId) {
          const res = await fetch(`${window.API_BASE}/api/subjects?id=${encodeURIComponent(subjectId)}`);
          if (!res.ok) throw new Error('Failed to load subject details');
          const subjects = await res.json();
          subject = Array.isArray(subjects) ? subjects.find(s => String(s.id) === String(subjectId)) : subjects;
        } else {
          const res = await fetch(`${window.API_BASE}/api/subjects?title=${encodeURIComponent(subjectName)}`);
          if (!res.ok) throw new Error('Failed to load subject details');
          const subjects = await res.json();
          subject = Array.isArray(subjects) ? subjects.find(s => s.title === subjectName) : subjects;
        }
        
        if (subject) {
          subjectId = subject.id;
          accessCode = subject.code || '';
          
          document.getElementById('classSection').textContent = subject.section || subject.grade_level || 'No section';
          document.getElementById('accessCode').textContent = accessCode || '------';
          document.getElementById('emptyClassCode').textContent = accessCode || '------';
          
          // Setup copy buttons
          setupCopyButtons();
          
          // Setup grade management button
          document.getElementById('manageGradesBtn').addEventListener('click', () => {
            window.location.href = `teacher-grades.html?id=${subjectId}&name=${encodeURIComponent(subjectName)}`;
          });
        }
      } catch (error) {
        console.error('Error loading subject details:', error);
      }
    }

    function setupCopyButtons() {
      const copyBtn = document.getElementById('copyCodeBtn');
      const emptyBtn = document.getElementById('copyEmptyCodeBtn');
      
      [copyBtn, emptyBtn].forEach(btn => {
        if (btn && accessCode) {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            try {
              await navigator.clipboard.writeText(accessCode);
              btn.textContent = '‚úÖ';
              setTimeout(() => btn.textContent = 'üìã', 1500);
            } catch (err) {
              alert(`Class Code: ${accessCode}`);
            }
          });
        }
      });
    }

    async function loadStudents() {
      if (!subjectId) return;
      
      const grid = document.getElementById('studentsGrid');
      const emptyState = document.getElementById('emptyState');
      
      try {
        const res = await fetch(`${window.API_BASE}/api/subjects/${subjectId}/students`);
        if (!res.ok) throw new Error('Failed to load students');
        
        const students = await res.json();
        
        if (students.length === 0) {
          grid.style.display = 'none';
          emptyState.style.display = 'block';
        } else {
          emptyState.style.display = 'none';
          grid.style.display = 'grid';
          renderStudents(students);
        }
        
        // Update student count
        document.getElementById('studentCount').textContent = `${students.length} student${students.length !== 1 ? 's' : ''}`;
        
      } catch (error) {
        console.error('Error loading students:', error);
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#ef4444; padding:20px;">Failed to load students</div>';
      }
    }

    function renderStudents(students) {
      const grid = document.getElementById('studentsGrid');
      grid.innerHTML = '';
      
      students.forEach(student => {
        const card = document.createElement('div');
        card.className = 'student-card';
        
        const initial = student.full_name.charAt(0).toUpperCase();
        const joinDate = student.enrolled_at ? new Date(student.enrolled_at).toLocaleDateString() : 'Recently';
        
        card.innerHTML = `
          <div class="student-avatar">${initial}</div>
          <div class="student-info">
            <div class="student-name">${student.full_name}</div>
            <div class="student-meta">Joined ${joinDate}</div>
          </div>
          <div class="student-actions">
            <button class="action-btn" onclick="viewStudentGrades(${student.id}, '${student.full_name}')" title="View grades">üìä</button>
            <button class="action-btn" onclick="contactStudent('${student.full_name}')" title="Contact">üí¨</button>
          </div>
        `;
        
        grid.appendChild(card);
      });
    }

    function setupRealtimeUpdates() {
      try {
        const tok = localStorage.getItem('token');
        const eventSource = new EventSource(`${window.API_BASE}/api/events${tok?`?token=${encodeURIComponent(tok)}`:''}`);
        
        eventSource.addEventListener('enrollmentUpdated', (event) => {
          const data = JSON.parse(event.data);
          if (data.subjectId == subjectId) {
            loadStudents(); // Refresh student list
            // Show notification
            showNotification('New student joined the class!', 'success');
          }
        });
        
        eventSource.addEventListener('open', () => {
          document.getElementById('realtimeStatus').classList.add('connected');
        });
        
        eventSource.addEventListener('error', () => {
          document.getElementById('realtimeStatus').classList.remove('connected');
        });
        
      } catch (error) {
        console.error('Failed to setup real-time updates:', error);
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : '#2563eb'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Navigation functions
    function goBack() {
      window.location.href = 'homepage2.html';
    }

    function goToGrades() {
      if (subjectId) {
        window.location.href = `teacher-grades.html?id=${subjectId}&name=${encodeURIComponent(subjectName)}`;
      }
    }

    function viewStudentGrades(studentId, studentName) {
      if (subjectId) {
        window.location.href = `teacher-grades.html?id=${subjectId}&name=${encodeURIComponent(subjectName)}&student_id=${studentId}`;
      }
    }

    function contactStudent(studentName) {
      alert(`Contact feature for ${studentName} would be implemented here.`);
    }

    function showAnalytics() {
      alert('Class analytics feature would be implemented here.');
    }

    function showAnnouncements() {
      alert('Announcements feature would be implemented here.');
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'login.html';
    }

    // Logout button
    document.getElementById('logoutBtn').addEventListener('click', logout);
  </script>

  <style>
    /* Additional styles for subject page */
    .back-btn {
      background: #e5e7eb;
      color: #374151;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 20px;
      transition: background 0.2s ease;
    }
    
    .back-btn:hover {
      background: #d1d5db;
    }

    .class-info-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin: 24px 0;
      padding: 24px;
      background: var(--card);
      border-radius: 16px;
      box-shadow: var(--shadow-md);
    }

    .class-details h1 {
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 8px;
    }

    .class-metadata {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .separator {
      color: var(--text-muted);
    }

    .access-code-display {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Courier New', monospace;
    }

    .access-code-display strong {
      color: var(--primary);
    }

    .class-actions {
      display: flex;
      gap: 12px;
    }

    .students-section {
      margin: 32px 0;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-header h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
    }

    .real-time-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ef4444;
      transition: background 0.3s ease;
    }

    .real-time-indicator.connected .status-dot {
      background: #10b981;
    }

    .students-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .student-card {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
      border: 1px solid #e2e8f0;
    }

    .student-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .student-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 12px;
    }

    .student-name {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .student-meta {
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-bottom: 12px;
    }

    .student-actions {
      display: flex;
      gap: 8px;
    }

    .student-actions .action-btn {
      background: #f1f5f9;
      border: none;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .student-actions .action-btn:hover {
      background: #e2e8f0;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    .empty-state h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .empty-state p {
      margin-bottom: 20px;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin: 40px 0;
    }

    .action-card {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }

    .action-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .action-icon {
      font-size: 2rem;
      margin-bottom: 16px;
    }

    .action-card h3 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .action-card p {
      color: var(--text-secondary);
      margin-bottom: 16px;
      font-size: 0.9rem;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .class-info-header {
        flex-direction: column;
        gap: 16px;
      }

      .class-actions {
        width: 100%;
      }

      .class-actions .btn {
        flex: 1;
      }

      .students-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</body>
</html>
