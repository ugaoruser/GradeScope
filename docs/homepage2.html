<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GradeTracker â€” Teacher Home</title>
  <link rel="stylesheet" href="styles.css">
  <script src="config.js" defer></script>
</head>
<body class="homepage2">
  <div class="sidebar">
    ...
  </div>
  <div class="main">
    <header class="header">
      <div class="header-title">Welcome</div>
      <div class="account-menu"> ... same as student header ... </div>
    </header>

    <h2>My Classes</h2>
    <div class="classroom-tabs" id="classroomTabs"></div>

    <div id="classActionArea" class="class-action-area"></div>

    <!-- Create Class Modal (teacher) -->
    <div id="createModal" class="modal" aria-hidden="true">
      <div class="modal-panel">
        <div class="modal-header">
          <div class="modal-title">Create Class</div>
          <button id="closeCreate" class="modal-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
          <label>Subject Name</label>
          <input id="createSubject" placeholder="e.g., Mathematics">

          <label>Class / Section</label>
          <input id="createSection" placeholder="e.g., Section A">

          <label>Access Code (auto-generated)</label>
          <input id="createCode" readonly>
        </div>
        <div class="modal-actions">
          <button id="cancelCreate" class="btn-muted">Cancel</button>
          <button id="confirmCreate" class="btn-primary">Create</button>
        </div>
      </div>
    </div>
  </div>
</body>

  <script>
    const role = localStorage.getItem('role');
    if (window.location.pathname.endsWith('homepage1.html') && role !== 'student') {
      window.location.href = 'homepage2.html';
    }
    if (window.location.pathname.endsWith('homepage2.html') && role !== 'teacher') {
      window.location.href = 'homepage1.html';
    }
    if (!role || !localStorage.getItem('token')) {
      // User not logged in, redirect
      window.location.href = 'login.html';
    }
    
    // --- Routing: Only allow teachers ---
    if (role !== 'teacher') {
      window.location.href = 'homepage1.html';
    }

    // --- Account Initial and User Info ---
    const user = JSON.parse(localStorage.getItem('user')) || { name: "Teacher", email: "teacher@example.com" };
    document.getElementById('accountInitial').textContent = (user.name && user.name[0]) || 'T';
    document.getElementById('userFullName').textContent = user.name || 'Teacher';
    document.getElementById('userEmail').textContent = user.email || 'teacher@example.com';
    
    // Fetch user data for dropdown
    fetch('${window.API_BASE}/api/me', {
      headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
    })
      .then(res => res.json())
      .then(userData => {
        // Store user data in localStorage for future use
        localStorage.setItem('fullName', userData.fullName);
        localStorage.setItem('email', userData.email);
        
        document.getElementById('userFullName').textContent = userData.fullName || user.name || 'User Name';
        document.getElementById('userEmail').textContent = userData.email || user.email || 'user@example.com';
        document.getElementById('accountInitial').textContent = (userData.fullName && userData.fullName[0]) || (user.name && user.name[0]) || 'T';
      })
      .catch(err => {
        console.error('Error fetching user data:', err);
        // Use localStorage as fallback
        document.getElementById('userFullName').textContent = localStorage.getItem('fullName') || user.name || 'User Name';
        document.getElementById('userEmail').textContent = localStorage.getItem('email') || user.email || 'user@example.com';
      });

    function goHome() { location.reload(); }
    function goSettings() { window.location.href = "settings.html"; }
    function logout() {
      // Clear all user data from localStorage
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      localStorage.removeItem('fullName');
      localStorage.removeItem('email');
      
      // Redirect to login page
      window.location.href = "login.html";
    }
    
    // About Modal Functions
    function showAbout() { 
      document.getElementById('aboutModal').style.display = 'block';
    }
    
    function closeAbout() {
      document.getElementById('aboutModal').style.display = 'none';
    }
    
    // Add Class Modal Functions
    function showAddClassModal() {
      document.getElementById('addClassModal').style.display = 'block';
    }
    
    function closeAddClassModal() {
      document.getElementById('addClassModal').style.display = 'none';
      // Clear form fields
      document.getElementById('className').value = '';
      document.getElementById('gradeLevel').value = '';
      document.getElementById('section').value = '';
    }
    
    function confirmAddClass() {
      const className = document.getElementById('className').value.trim();
      const gradeLevel = document.getElementById('gradeLevel').value.trim();
      const section = document.getElementById('section').value.trim();
      
      if (!className || !gradeLevel || !section) {
        alert('Please fill in all fields');
        return;
      }
      
      // Send data to server
      fetch('${window.API_BASE}/api/subjects', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
          title: className,
          gradeLevel: gradeLevel,
          section: section
        })
      })
      .then(res => {
        if (!res.ok) throw new Error('Failed to create class');
        return res.json();
      })
      .then(data => {
        alert('Class created successfully!');
        closeAddClassModal();
        location.reload(); // Refresh to show new class
      })
      .catch(err => {
        alert('Error creating class: ' + err.message);
      });
    }

    function toggleAccountMenu() {
      document.getElementById('accountDropdown').classList.toggle('show');
    }
    
    window.onclick = function(event) {
      if (!event.target.matches('.account-btn')) {
        document.getElementById('accountDropdown').classList.remove('show');
      }
      
      // Close modals when clicking outside
      if (event.target.id === 'aboutModal') {
        closeAbout();
      }
      if (event.target.id === 'addClassModal') {
        closeAddClassModal();
      }
    }

    // --- Fetch subjects from backend ---
    function renderSubjects(subjects) {
      const container = document.getElementById('classroomTabs');
      container.innerHTML = "";
      if (!subjects.length) {
        container.innerHTML = "<div>No subjects found.</div>";
        return;
      }
      subjects.forEach(subj => {
        const div = document.createElement('div');
        div.className = "class-tab";
        div.innerHTML = `<div class="class-title">${subj.title}</div>
                         <div class="class-section">${subj.grade_level || subj.gradeLevel || 'Grade 10'} - ${subj.section}</div>`;
        div.onclick = () => { window.location.href = "subject.html?subject=" + encodeURIComponent(subj.title); };
        container.appendChild(div);
      });
    }

     fetch('${window.API_BASE}/api/classes', {
       headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
     })
       .then(res => {
         if (!res.ok) {
           if (res.status === 401) {
             localStorage.removeItem('token');
             localStorage.removeItem('role');
             window.location.href = 'login.html';
             return;
           }
           throw new Error('Failed to load subjects');
         }
         return res.json();
       })
       .then(subjects => {
         if (subjects) renderSubjects(subjects);
       })
       .catch(err => {
         console.error('Error loading subjects:', err);
         document.getElementById('classroomTabs').innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No subjects found. Click "Add Class" to create your first subject.</div>';
       });

     // Chatbot toggle logic
     const sidebar = document.getElementById('chatbotSidebar');
     document.getElementById('chatbotToggle').addEventListener('click', () => {
       sidebar.style.right = sidebar.style.right === '0px' ? '-360px' : '0px';
     });
     document.getElementById('closeChatbot').addEventListener('click', () => {
       sidebar.style.right = '-360px';
     });
     document.getElementById('sendChat').addEventListener('click', () => {
       const input = document.getElementById('chatInput');
       const text = input.value.trim();
       if (!text) return;
       const log = document.getElementById('chatLog');
       const me = document.createElement('div');
       me.textContent = text;
       log.appendChild(me);
       input.value = '';
       // Placeholder reply
       const bot = document.createElement('div');
       bot.style.color = '#666';
       bot.textContent = 'Thanks! I will keep that in mind.';
       log.appendChild(bot);
       log.scrollTop = log.scrollHeight;
     });
   </script>
</body>
</html>