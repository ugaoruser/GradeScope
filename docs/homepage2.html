<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GradeTracker â€” Teacher Home</title>
  <link rel="stylesheet" href="styles.css">
  <script src="config.js" defer></script>
</head>
<body class="homepage2">
  <div class="sidebar">
    ...
  </div>
  <div class="main">
    <header class="header">
      <div class="header-title">Welcome</div>
      <div class="account-menu"> ... same as student header ... </div>
    </header>

    <h2>My Classes</h2>
    <div class="classroom-tabs" id="classroomTabs"></div>

    <div id="classActionArea" class="class-action-area"></div>

    <!-- Create Class Modal (teacher) -->
    <div id="createModal" class="modal" aria-hidden="true">
      <div class="modal-panel">
        <div class="modal-header">
          <div class="modal-title">Create Class</div>
          <button id="closeCreate" class="modal-close" aria-label="Close">&times;</button>
        </div>
      </div>
    </div>
    <h2>My Subjects</h2>
     <div class="classroom-tabs" id="classroomTabs">
       Loading...
     </div>
     <div style="margin-top:16px;">
       <button class="add-class-btn" onclick="showAddClassModal()">+ Create Class</button>
     </div>
     <!-- Chatbot Toggle Button -->
     <button id="chatbotToggle" style="position: fixed; right: 24px; bottom: 24px; width: 56px; height: 56px; border-radius: 50%; background:#1976d2; color:#fff; border:none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor:pointer; font-size:24px;">ðŸ’¬</button>
     <!-- Chatbot Sidebar -->
     <div id="chatbotSidebar" style="position: fixed; right: -360px; top: 0; width: 360px; height: 100%; background: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease; z-index: 1000; display:flex; flex-direction:column;">
       <div style="padding: 12px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
         <div style="font-weight:600;">Assistant</div>
         <button id="closeChatbot" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
       </div>
       <div id="chatLog" style="flex:1; padding: 12px; overflow:auto;">
         <div style="color:#666;">How can I help you plan classes and grades today?</div>
       </div>
       <div style="padding: 12px; border-top:1px solid #eee; display:flex; gap:8px;">
         <input id="chatInput" placeholder="Type a message..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;">
         <button id="sendChat" style="padding:10px 14px; background:#1976d2; color:#fff; border:none; border-radius:6px; cursor:pointer;">Send</button>
       </div>
     </div>
   </div>
  
  <!-- About Modal -->
  <div id="aboutModal" style="display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: #fff; margin: 10% auto; padding: 24px; border-radius: 8px; width: 80%; max-width: 500px; box-shadow: 0 4px 16px rgba(0,0,0,0.2);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div style="font-size: 1.5em; font-weight: bold;">About GradeScope Lite</div>
        <button style="font-size: 1.5em; cursor: pointer; background: none; border: none;" onclick="closeAbout()">&times;</button>
      </div>
      <div style="line-height: 1.6;">
        <p>This website acts as a Grade Tracker to track the quizzes and scores of students in a more faster way. It can be used by students, teachers, and parents.</p>
        <p><strong>Version:</strong> V1.0</p>
        <p><strong>Developed by:</strong> Group 4 Practical Research Group [12-Lovelace]</p>
        <p><strong>Main Dev:</strong> Jack Dylan Gallentes</p>
      </div>
    </div>
  </div>
  
  <!-- Add Class Modal -->
  <div id="addClassModal" style="display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: #fff; margin: 10% auto; padding: 24px; border-radius: 8px; width: 80%; max-width: 500px; box-shadow: 0 4px 16px rgba(0,0,0,0.2);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div style="font-size: 1.5em; font-weight: bold;">Add New Class</div>
        <button style="font-size: 1.5em; cursor: pointer; background: none; border: none;" onclick="closeAddClassModal()">&times;</button>
      </div>
      <div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: bold;">Name of Subject</label>
          <input type="text" id="className" placeholder="Enter subject name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
        </div>
        <div class="modal-actions">
          <button id="cancelCreate" class="btn-muted">Cancel</button>
          <button id="confirmCreate" class="btn-primary">Create</button>
        </div>
      </div>
    </div>
  </div>
</body>

  <script>
    const role = localStorage.getItem('role');
    if (window.location.pathname.endsWith('homepage1.html') && role !== 'student') {
      window.location.href = 'homepage2.html';
    }
    if (window.location.pathname.endsWith('homepage2.html') && role !== 'teacher') {
      window.location.href = 'homepage1.html';
    }
    if (!role || !localStorage.getItem('token')) {
      // User not logged in, redirect
      window.location.href = 'login.html';
    }
    
    // --- Routing: Only allow teachers ---
    if (role !== 'teacher') {
      window.location.href = 'homepage1.html';
    }

    // --- Account Initial and User Info ---
    const user = JSON.parse(localStorage.getItem('user')) || { name: "Teacher", email: "teacher@example.com" };
    document.getElementById('accountInitial').textContent = (user.name && user.name[0]) || 'T';
    document.getElementById('userFullName').textContent = user.name || 'Teacher';
    document.getElementById('userEmail').textContent = user.email || 'teacher@example.com';
    
    // Fetch user data for dropdown
    fetch('${window.API_BASE}/api/me', {
      headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
    })
      .then(res => res.json())
      .then(userData => {
        // Store user data in localStorage for future use
        localStorage.setItem('fullName', userData.fullName);
        localStorage.setItem('email', userData.email);
        
        document.getElementById('userFullName').textContent = userData.fullName || user.name || 'User Name';
        document.getElementById('userEmail').textContent = userData.email || user.email || 'user@example.com';
        document.getElementById('accountInitial').textContent = (userData.fullName && userData.fullName[0]) || (user.name && user.name[0]) || 'T';
      })
      .catch(err => {
        console.error('Error fetching user data:', err);
        // Use localStorage as fallback
        document.getElementById('userFullName').textContent = localStorage.getItem('fullName') || user.name || 'User Name';
        document.getElementById('userEmail').textContent = localStorage.getItem('email') || user.email || 'user@example.com';
      });

    function goHome() { location.reload(); }
    function goSettings() { window.location.href = "settings.html"; }
    function logout() {
      // Clear all user data from localStorage
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      localStorage.removeItem('fullName');
      localStorage.removeItem('email');
      
      // Redirect to login page
      window.location.href = "login.html";
    }
    
    // About Modal Functions
    function showAbout() { 
      document.getElementById('aboutModal').style.display = 'block';
    }
    
    function closeAbout() {
      document.getElementById('aboutModal').style.display = 'none';
    }
    
    // Add Class Modal Functions
    function showAddClassModal() {
      document.getElementById('addClassModal').style.display = 'block';
    }
    
    function closeAddClassModal() {
      document.getElementById('addClassModal').style.display = 'none';
      // Clear form fields
      document.getElementById('className').value = '';
      document.getElementById('gradeLevel').value = '';
      document.getElementById('section').value = '';
    }
    
    function confirmAddClass() {
      const className = document.getElementById('className').value.trim();
      const gradeLevel = document.getElementById('gradeLevel').value.trim();
      const section = document.getElementById('section').value.trim();
      
      if (!className || !gradeLevel || !section) {
        alert('Please fill in all fields');
        return;
      }
      
      // Send data to server
      fetch('${window.API_BASE}/api/subjects', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        body: JSON.stringify({
          title: className,
          gradeLevel: gradeLevel,
          section: section
        })
      })
      .then(res => {
        if (!res.ok) throw new Error('Failed to create class');
        return res.json();
      })
      .then(data => {
        alert('Class created successfully!');
        closeAddClassModal();
        location.reload(); // Refresh to show new class
      })
      .catch(err => {
        alert('Error creating class: ' + err.message);
      });
    }

    function toggleAccountMenu() {
      document.getElementById('accountDropdown').classList.toggle('show');
    }
    
    window.onclick = function(event) {
      if (!event.target.matches('.account-btn')) {
        document.getElementById('accountDropdown').classList.remove('show');
      }
      
      // Close modals when clicking outside
      if (event.target.id === 'aboutModal') {
        closeAbout();
      }
      if (event.target.id === 'addClassModal') {
        closeAddClassModal();
      }
    }

    // --- Fetch subjects from backend ---
    function renderSubjects(subjects) {
      const container = document.getElementById('classroomTabs');
      container.innerHTML = "";
      if (!subjects.length) {
        container.innerHTML = "<div>No subjects found.</div>";
        return;
      }
      subjects.forEach(subj => {
        const div = document.createElement('div');
        div.className = "class-tab";
        div.innerHTML = `<div class="class-title">${subj.title}</div>
                         <div class="class-section">${subj.grade_level || subj.gradeLevel || 'Grade 10'} - ${subj.section}</div>`;
        div.onclick = () => { window.location.href = "subject.html?subject=" + encodeURIComponent(subj.title); };
        container.appendChild(div);
      });
    }

     fetch('${window.API_BASE}/api/classes', {
       headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
     })
       .then(res => {
         if (!res.ok) {
           if (res.status === 401) {
             localStorage.removeItem('token');
             localStorage.removeItem('role');
             window.location.href = 'login.html';
             return;
           }
           throw new Error('Failed to load subjects');
         }
         return res.json();
       })
       .then(subjects => {
         if (subjects) renderSubjects(subjects);
       })
       .catch(err => {
         console.error('Error loading subjects:', err);
         document.getElementById('classroomTabs').innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No subjects found. Click "Add Class" to create your first subject.</div>';
       });

     // Chatbot toggle logic
     const sidebar = document.getElementById('chatbotSidebar');
     document.getElementById('chatbotToggle').addEventListener('click', () => {
       sidebar.style.right = sidebar.style.right === '0px' ? '-360px' : '0px';
     });
     document.getElementById('closeChatbot').addEventListener('click', () => {
       sidebar.style.right = '-360px';
     });
     document.getElementById('sendChat').addEventListener('click', () => {
       const input = document.getElementById('chatInput');
       const text = input.value.trim();
       if (!text) return;
       const log = document.getElementById('chatLog');
       const me = document.createElement('div');
       me.textContent = text;
       log.appendChild(me);
       input.value = '';
       // Placeholder reply
       const bot = document.createElement('div');
       bot.style.color = '#666';
       bot.textContent = 'Thanks! I will keep that in mind.';
       log.appendChild(bot);
       log.scrollTop = log.scrollHeight;
     });
   </script>
</body>
</html>