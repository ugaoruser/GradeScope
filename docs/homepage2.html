<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GradeTracker â€” Teacher Home</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.5.0/remixicon.min.css">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="theme.css">
  <script src="config.js" defer></script>
  <script src="chatbot.js" defer></script>
</head>
 <body class="homepage2">
  <div class="sidebar">
    <div class="top">
      <ul class="nav">
        <li class="active" onclick="location.href='homepage2.html'">Home</li>
        <li onclick="location.href='settings.html'">Settings</li>
        <li id="aboutBtn">About</li>
      </ul>
    </div>
    <div class="bottom">
      <div class="app-version">Grade Tracker v1.0</div>
    </div>
  </div>
  <div class="main">
    <header class="header">
      <div class="header-title">Welcome</div>
      <div class="account-menu">
        <button class="account-btn" onclick="toggleAccountMenu()">
          <span id="accountInitial">T</span>
        </button>
        <div class="account-dropdown" id="accountDropdown" aria-hidden="true">
          <div class="account-info">
            <div id="userFullName">User Name</div>
            <div id="userEmail"></div>
          </div>
          <button onclick="logout()">Log Out</button>
        </div>
      </div>
    </header>

    <div class="header-actions" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <h2 style="margin:0;">Classes</h2>
      <button class="add-class-btn" onclick="showAddClassModal()">+ Create Class</button>
    </div>

    <div class="classroom-tabs" id="classroomTabs">Loading...</div>

    <!-- Chatbot Toggle Button -->
    <button id="chatbotToggle" style="position: fixed; right: 24px; bottom: 24px; width: 56px; height: 56px; border-radius: 50%; background:#1976d2; color:#fff; border:none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor:pointer; font-size:24px;">ðŸ’¬</button>
    <!-- Chatbot Sidebar -->
    <div id="chatbotSidebar" style="position: fixed; right: -360px; top: 0; width: 360px; height: 100%; background: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease; z-index: 1000; display:flex; flex-direction:column;">
      <div style="padding: 12px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:600;">Assistant</div>
        <button id="closeChatbot" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
      </div>
      <div id="chatLog" style="flex:1; padding: 12px; overflow:auto;">
        <div style="color:#666;">I can help you draft comments and estimate student progress. Ask me something like "Create a comment for Maria in Algebra, score 82" or "Average of 78, 85, 90".</div>
      </div>
      <div style="padding: 12px; border-top:1px solid #eee; display:flex; gap:8px;">
        <input id="chatInput" placeholder="Type a message..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;">
        <button id="sendChat" style="padding:10px 14px; background:#1976d2; color:#fff; border:none; border-radius:6px; cursor:pointer;">Send</button>
      </div>
    </div>
  </div>
  
  <!-- About Modal (unified with homepage format + transition) -->
  <div id="aboutModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-panel">
      <div class="modal-header">
        <div class="modal-title">About GradeScope Lite</div>
        <button class="modal-close" onclick="closeAbout()" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="settings-section-title">Profile Information</div>
        <div class="form-row">
          <div class="col">
            <label>First Name</label>
            <div id="aboutFirstName" class="field-display"></div>
          </div>
          <div class="col">
            <label>Last Name</label>
            <div id="aboutLastName" class="field-display"></div>
          </div>
        </div>
        <div class="form-row">
          <div class="col">
            <label>Email</label>
            <div id="aboutEmail" class="field-display"></div>
          </div>
        </div>
        <hr style="margin:12px 0; border:none; border-top:1px solid #eef2f7;">
        <p>This website acts as a Grade Tracker to track the quizzes and scores of students in a more faster way. It can be used by students, teachers, and parents.</p>
        <p><strong>Version:</strong> V1.0</p>
        <p><strong>Developed by:</strong> Group 4 Practical Research Group [12-Lovelace]</p>
        <p><strong>Main Dev:</strong> Jack Dylan Gallentes</p>
      </div>
    </div>
  </div>
  
  <!-- Add Class Modal -->
  <div id="addClassModal" style="display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: #fff; margin: 10% auto; padding: 24px; border-radius: 8px; width: 80%; max-width: 500px; box-shadow: 0 4px 16px rgba(0,0,0,0.2);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div style="font-size: 1.5em; font-weight: bold;">Create Class</div>
        <button style="font-size: 1.5em; cursor: pointer; background: none; border: none;" onclick="closeAddClassModal()">&times;</button>
      </div>
      <div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: bold;">Name of Class</label>
          <input type="text" id="className" placeholder="Enter class name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: bold;">Grade Level</label>
          <input type="text" id="gradeLevel" placeholder="e.g., Grade 10" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: bold;">Section</label>
          <input type="text" id="section" placeholder="Enter section" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
        </div>
        <div class="modal-actions">
          <button id="cancelCreate" class="btn-muted" onclick="closeAddClassModal()">Cancel</button>
          <button id="confirmCreate" class="btn-primary" onclick="confirmAddClass()">Create</button>
        </div>
      </div>
    </div>
  </div>
</body>

<script>
  const role = localStorage.getItem('role');
  if (window.location.pathname.endsWith('homepage1.html') && role !== 'student') {
      window.location.href = 'homepage2.html';
    }
    if (window.location.pathname.endsWith('homepage2.html') && role !== 'teacher') {
      window.location.href = 'homepage1.html';
    }
    if (!role || !localStorage.getItem('token')) {
      // User not logged in, redirect
      window.location.href = 'login.html';
    }
    
    // --- Routing: Only allow teachers ---
    if (role !== 'teacher') {
      window.location.href = 'homepage1.html';
    }

    // --- Account Initial and User Info ---
    const user = JSON.parse(localStorage.getItem('user')) || { name: "Teacher", email: localStorage.getItem('email') || "" };
    document.getElementById('accountInitial').textContent = (user.name && user.name[0]) || 'T';
    document.getElementById('userFullName').textContent = user.name || 'Teacher';
    document.getElementById('userEmail').textContent = localStorage.getItem('email') || user.email || '';
    
    // Fetch user data for dropdown
    fetch(`${window.API_BASE}/api/me`, {
      headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
    })
      .then(res => res.json())
      .then(userData => {
        // Store user data in localStorage for future use
        localStorage.setItem('firstName', userData.firstName || '');
        localStorage.setItem('lastName', userData.lastName || '');
        localStorage.setItem('fullName', userData.fullName || `${userData.firstName || ''} ${userData.lastName || ''}`.trim());
        if (userData.email) localStorage.setItem('email', userData.email);
        
        const nameLine = `${userData.firstName || ''}${userData.lastName ? ', ' + userData.lastName : ''}`.trim() || userData.fullName || user.name || 'User Name';
        document.getElementById('userFullName').textContent = nameLine;
        document.getElementById('userEmail').textContent = userData.email || localStorage.getItem('email') || '';
        document.getElementById('accountInitial').textContent = (nameLine && nameLine[0]) || 'T';
        // Fill About modal profile fields
        const aFn = document.getElementById('aboutFirstName'); if (aFn) aFn.textContent = userData.firstName || '';
        const aLn = document.getElementById('aboutLastName'); if (aLn) aLn.textContent = userData.lastName || '';
        const aEm = document.getElementById('aboutEmail'); if (aEm) aEm.textContent = userData.email || localStorage.getItem('email') || '';
      })
      .catch(err => {
        console.error('Error fetching user data:', err);
        // Use localStorage as fallback
        const nameLine = `${localStorage.getItem('firstName') || ''}${localStorage.getItem('lastName') ? ', ' + localStorage.getItem('lastName') : ''}`.trim() || localStorage.getItem('fullName') || user.name || 'User Name';
        document.getElementById('userFullName').textContent = nameLine;
        document.getElementById('userEmail').textContent = localStorage.getItem('email') || user.email || '';
        const aFn = document.getElementById('aboutFirstName'); if (aFn) aFn.textContent = localStorage.getItem('firstName') || '';
        const aLn = document.getElementById('aboutLastName'); if (aLn) aLn.textContent = localStorage.getItem('lastName') || '';
        const aEm = document.getElementById('aboutEmail'); if (aEm) aEm.textContent = localStorage.getItem('email') || '';
      });

    function goHome() { location.reload(); }
    function goSettings() { window.location.href = "settings.html"; }
    function logout() {
      // Clear all user data from localStorage
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      localStorage.removeItem('fullName');
      localStorage.removeItem('email');
      
      // Redirect to login page
      window.location.href = "login.html";
    }
    
    // About Modal Functions
    function showAbout() { 
      const m = document.getElementById('aboutModal');
      m.style.display = 'flex';
      requestAnimationFrame(() => m.classList.add('show'));
    }
    
    function closeAbout() {
      const m = document.getElementById('aboutModal');
      m.classList.remove('show');
      setTimeout(()=>{ m.style.display = 'none'; }, 180);
    }
    
    // Add Class Modal Functions
    function showAddClassModal() {
      document.getElementById('addClassModal').style.display = 'block';
    }
    
    function closeAddClassModal() {
      document.getElementById('addClassModal').style.display = 'none';
      // Clear form fields
      document.getElementById('className').value = '';
      document.getElementById('section').value = '';
    }
    
    async function confirmAddClass() {
      const className = document.getElementById('className').value.trim();
      const gradeLevel = document.getElementById('gradeLevel').value.trim();
      const section = document.getElementById('section').value.trim();
      
      if (!className || !gradeLevel || !section) {
        alert('Please fill in all fields');
        return;
      }
      const btn = document.getElementById('confirmCreate');
      const prev = btn.textContent; btn.disabled = true; btn.textContent = 'Creating...';
      try {
        const res = await fetch(`${window.API_BASE}/api/subjects`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({ title: className, gradeLevel, section })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Failed to create class');
        alert('Class created successfully!');
        closeAddClassModal();
        // Append to list without full reload
        const container = document.getElementById('classroomTabs');
        const div = document.createElement('div');
        div.className = 'class-tab';
        div.innerHTML = `<div class=\"class-title\">${data.title || className}</div>
                         <div class=\"class-section\">${data.section || section}</div>`;
        div.onclick = () => { window.location.href = "subject.html?subject=" + encodeURIComponent(data.title || className); };
        container.appendChild(div);
      } catch (err) {
        alert('Error creating class: ' + err.message);
      } finally {
        btn.disabled = false; btn.textContent = prev;
      }
    }

    function toggleAccountMenu(event) {
      event && event.stopPropagation();
      document.getElementById('accountDropdown').classList.toggle('show');
    }
    
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('accountDropdown');
      const btn = document.querySelector('.account-btn');
      if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
        dropdown.classList.remove('show');
      }
      if (e.target.id === 'aboutModal') closeAbout();
      if (e.target.id === 'addClassModal') closeAddClassModal();
    });
    document.querySelector('.account-btn').addEventListener('click', (e) => e.stopPropagation());
    document.getElementById('accountDropdown').addEventListener('click', (e) => e.stopPropagation());
    document.getElementById('aboutBtn').addEventListener('click', showAbout);

    // --- Fetch classes from backend ---
    function renderSubjects(subjects) {
      const container = document.getElementById('classroomTabs');
      container.innerHTML = "";
      if (!subjects.length) {
        container.innerHTML = "<div>No classes found. Click \"+ Create Class\" to add your first class.</div>";
        return;
      }
      subjects.forEach(subj => {
        const div = document.createElement('div');
        div.className = "class-tab";
        div.innerHTML = `<div class=\"class-title\">${subj.title}</div>
                         <div class=\"class-section\">${subj.section || ''}</div>`;
        div.onclick = () => { window.location.href = "subject.html?subject=" + encodeURIComponent(subj.title); };
        container.appendChild(div);
      });
    }

     // Try subjects endpoint first, fall back to classes for compatibility
     fetch(`${window.API_BASE}/api/subjects`, {
       headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
     })
       .then(async res => {
         if (res.ok) return res.json();
         // fallback
         const res2 = await fetch(`${window.API_BASE}/api/classes`, { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }});
         if (!res2.ok) throw new Error('Failed to load classes');
         return res2.json();
       })
       .then(list => {
         if (list) renderSubjects(list);
       })
       .catch(err => {
         console.error('Error loading classes:', err);
         document.getElementById('classroomTabs').innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No classes found. Click "+ Create Class" to create your first class.</div>';
       });

     // Chatbot toggle logic
     const sidebar = document.getElementById('chatbotSidebar');
     document.getElementById('chatbotToggle').addEventListener('click', () => {
       sidebar.style.right = sidebar.style.right === '0px' ? '-360px' : '0px';
     });
     document.getElementById('closeChatbot').addEventListener('click', () => {
       sidebar.style.right = '-360px';
     });

     function appendChat(text, who = 'bot'){
       const log = document.getElementById('chatLog');
       const line = document.createElement('div');
       line.style.margin = '6px 0';
       if (who === 'bot') { line.style.color = '#444'; }
       else { line.style.fontWeight = '600'; }
       line.textContent = text;
       log.appendChild(line);
       log.scrollTop = log.scrollHeight;
     }

     function containsProfanity(text){
       const bad = [
         'fuck','shit','bitch','asshole','bastard','dick','piss','cunt','motherfucker','slut','whore'
       ];
       const lower = text.toLowerCase();
       return bad.some(w => lower.includes(w));
     }

     function parseNumbers(text){
       const nums = (text.match(/\b\d{1,3}(?:\.\d+)?\b/g) || []).map(n => parseFloat(n)).filter(n => n<=100);
       return nums;
     }

     function handleProgressQuery(text){
       const nums = parseNumbers(text);
       if (nums.length === 0) return 'Please provide scores (0-100). Example: Average of 78, 85, 90.';
       const avg = nums.reduce((a,b)=>a+b,0)/nums.length;
       return `Approximate progress based on ${nums.length} score(s): ${avg.toFixed(1)}%.`;
     }

     function handleCommentQuery(text){
       // Try to extract name, subject/topic, and score
       const score = parseNumbers(text)[0] ?? 85;
       const nameMatch = text.match(/for\s+([A-Z][a-zA-Z]+(?:\s+[A-Z][a-zA-Z]+)?)/i);
       const topicMatch = text.match(/in\s+([A-Za-z ]+)/i) || text.match(/on\s+([A-Za-z ]+)/i);
       const name = nameMatch ? nameMatch[1].trim() : 'The student';
       const topic = topicMatch ? topicMatch[1].trim() : 'this topic';
       const subject = topic; // basic heuristic
       const bot = new FeedbackChatbot();
       const { feedback, suggestions } = bot.generateCompleteFeedback(score, subject, topic, name);
       return `${feedback}\nSuggestions: ${suggestions.slice(0,2).join('; ')}`;
     }

     function inScope(text){
       const t = text.toLowerCase();
       return t.includes('comment') || t.includes('feedback') || t.includes('progress') || t.includes('average') || /\d/.test(t);
     }

     function processMessage(text){
       if (containsProfanity(text)){
         return 'Please avoid using offensive language. Let\'s keep this respectful.';
       }
       const t = text.toLowerCase();
       if (t.includes('progress') || t.includes('average') || t.includes('mean')){
         return handleProgressQuery(text);
       }
       if (t.includes('comment') || t.includes('feedback')){
         return handleCommentQuery(text);
       }
       if (!inScope(text)){
         return 'I can help with: (1) drafting teacher comments, (2) approximate progress calculations. I can\'t perform other tasks, but you can try asking: "Create a comment for Ana in Science, score 88" or "Average of 76, 81, 90".';
       }
       // Fallback within scope
       return 'Try specifying scores or the student/topic. For example: "Create a comment for John in Algebra, score 84" or "Average of 75, 82, 91".';
     }

     document.getElementById('sendChat').addEventListener('click', () => {
       const input = document.getElementById('chatInput');
       const text = input.value.trim();
       if (!text) return;
       appendChat(text, 'me');
       input.value = '';
       const reply = processMessage(text);
       appendChat(reply, 'bot');
     });

     document.getElementById('chatInput').addEventListener('keydown', (e)=>{
       if (e.key === 'Enter') document.getElementById('sendChat').click();
     });
    </script>
</html>
