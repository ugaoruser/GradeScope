<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subject Grades - GradeTracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.5.0/remixicon.min.css">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="theme.css">
  <script src="config.js" defer></script>
</head>
<body class="student-grades-page">
  <div class="header">
    <h2 id="subjectTitle">Subject Grades</h2>
    <div>
      <span id="studentName"></span>
      <select id="childSelect" style="display:none; margin-left:8px;"></select>
      <button class="logout-btn" onclick="logout()">Log Out</button>
    </div>
  </div>
  
  <div class="main">
    <button class="back-btn" onclick="goBack()">‚Üê Back to Subjects</button>
    
    <div class="quarter-tabs" id="quarterTabs">
      <div class="quarter-tab active" data-quarter="1">Quarter 1</div>
      <div class="quarter-tab" data-quarter="2">Quarter 2</div>
      <div class="quarter-tab" data-quarter="3">Quarter 3</div>
      <div class="quarter-tab" data-quarter="4">Quarter 4</div>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-tab="graded">Graded Components</div>
      <div class="tab" data-tab="assessment">Assessment</div>
    </div>
    
    <div id="gradedContent" class="tab-content active">
      <!-- Performance Tasks Section -->
      <div class="category-header">
        <span>Performance Tasks (<span id="ptWeight">0</span>%)</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Index No.</th>
            <th>Name of Performance Task</th>
            <th>Topic(s) Involved</th>
            <th>Score</th>
            <th>Highest Possible Score</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody id="ptTable">
          <tr><td colspan="6">No data available</td></tr>
        </tbody>
      </table>
      
      <!-- Written Works Section -->
      <div class="category-header">
        <span>Written Works (<span id="wwWeight">0</span>%)</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Index No.</th>
            <th>Status</th>
            <th>Topic(s)</th>
            <th>Score</th>
            <th>Highest Possible Score</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody id="wwTable">
          <tr><td colspan="6">No data available</td></tr>
        </tbody>
      </table>
      
      <!-- Periodical Exam Section -->
      <div class="category-header">
        <span>Periodical Exam (<span id="peWeight">0</span>%)</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Topics</th>
            <th>Score</th>
            <th>Highest Possible Score</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody id="peTable">
          <tr><td colspan="4">No data available</td></tr>
        </tbody>
      </table>
      
      <div class="grade-summary">
        Grade of Student: <span id="finalGrade">N/A</span>
        <p><em>This grade is not final unless all data of all tasks is taken into account.</em></p>
      </div>
    </div>
    
    <div id="assessmentContent" class="tab-content">
      <table>
        <thead>
          <tr>
            <th>Index No.</th>
            <th>Topic(s) of Task</th>
            <th>Score</th>
            <th>Highest Possible Score</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody id="assessmentTable">
          <tr><td colspan="5">No data available</td></tr>
        </tbody>
      </table>
    </div> 
  </div>

  <script>
    // Check if user is logged in
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    const userObj = JSON.parse(localStorage.getItem('user') || '{}');
    
    if (!token || (role !== 'student' && role !== 'parent')) {
      window.location.href = 'login.html';
    }
    
    // student name will be set below based on role
    
    // Get subject ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const subjectId = urlParams.get('id');
    const subjectTitle = urlParams.get('title');
    const initialChildId = urlParams.get('childId');
    
    if (!subjectId) {
      window.location.href = 'homepage1.html';
    }
    
    document.getElementById('subjectTitle').textContent = subjectTitle || 'Subject Grades';
    
    // Tab switching
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => content.classList.remove('active'));
        
        const tabName = tab.getAttribute('data-tab');
        document.getElementById(tabName + 'Content').classList.add('active');
      });
    });
    
    // Quarter switching
    const quarterTabs = document.querySelectorAll('.quarter-tab');
    let currentQuarter = 1;
    
    quarterTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        quarterTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentQuarter = tab.getAttribute('data-quarter');
        loadGradeData(currentQuarter);
      });
    });
    
    // Load grade data for the selected quarter
    function loadGradeData(quarter) {
      // Fetch categories to get weights
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/categories?quarter=${quarter}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(categories => {
        // Set weights for each category
        categories.forEach(category => {
          if (category.name === 'Performance Task') {
            document.getElementById('ptWeight').textContent = category.weight;
          } else if (category.name === 'Written Works') {
            document.getElementById('wwWeight').textContent = category.weight;
          } else if (category.name === 'Periodical Exam') {
            document.getElementById('peWeight').textContent = category.weight;
          }
        });
        
        // Fetch grade items (include childId for parents)
        const childParam = (role === 'parent' && window.selectedChildId) ? `&childId=${encodeURIComponent(window.selectedChildId)}` : '';
        return fetch(`${window.API_BASE}/api/subjects/${subjectId}/items?quarter=${quarter}${childParam}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
      })
      .then(res => res.json())
      .then(items => {
        // Group items by category
        const ptItems = items.filter(item => item.category_name === 'Performance Task');
        const wwItems = items.filter(item => item.category_name === 'Written Works');
        const peItems = items.filter(item => item.category_name === 'Periodical Exam');
        const assessmentItems = items.filter(item => !item.included_in_final);
        
        // Populate tables
        populateTable('ptTable', ptItems, renderPTRow);
        populateTable('wwTable', wwItems, renderWWRow);
        populateTable('peTable', peItems, renderPERow);
        populateTable('assessmentTable', assessmentItems, renderAssessmentRow);
        
        // Calculate final grade
        calculateFinalGrade(ptItems, wwItems, peItems);
      })
      .catch(error => {
        console.error('Error loading grade data:', error);
      });
    }
    
    function populateTable(tableId, items, renderRowFunc) {
      const tableBody = document.getElementById(tableId);
      if (items.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6">No data available</td></tr>';
        return;
      }
      
      tableBody.innerHTML = '';
      items.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = renderRowFunc(item, index + 1);
        tableBody.appendChild(row);
      });
    }
    
    function renderPTRow(item, index) {
      return `
        <td>${index}</td>
        <td>${item.title}</td>
        <td>${item.topic || 'N/A'}</td>
        <td>${item.score || 'N/A'}</td>
        <td>${item.max_score}</td>
        <td>${item.comments || ''}</td>
      `;
    }
    
    function renderWWRow(item, index) {
      return `
        <td>${index}</td>
        <td>${item.item_type || 'N/A'}</td>
        <td>${item.topic || 'N/A'}</td>
        <td>${item.score || 'N/A'}</td>
        <td>${item.max_score}</td>
        <td>${item.comments || ''}</td>
      `;
    }
    
    function renderPERow(item) {
      return `
        <td>${item.topic || 'N/A'}</td>
        <td>${item.score || 'N/A'}</td>
        <td>${item.max_score}</td>
        <td>${item.comments || ''}</td>
      `;
    }
    
    function renderAssessmentRow(item, index) {
      return `
        <td>${index}</td>
        <td>${item.topic || 'N/A'}</td>
        <td>${item.score || 'N/A'}</td>
        <td>${item.max_score}</td>
        <td>${item.comments || ''}</td>
      `;
    }
    
    function calculateFinalGrade(ptItems, wwItems, peItems) {
      const ptWeight = parseFloat(document.getElementById('ptWeight').textContent) / 100;
      const wwWeight = parseFloat(document.getElementById('wwWeight').textContent) / 100;
      const peWeight = parseFloat(document.getElementById('peWeight').textContent) / 100;
      
      let ptTotal = 0, ptMax = 0;
      let wwTotal = 0, wwMax = 0;
      let peTotal = 0, peMax = 0;
      
      ptItems.forEach(item => {
        if (item.score) {
          ptTotal += parseFloat(item.score);
          ptMax += parseFloat(item.max_score);
        }
      });
      
      wwItems.forEach(item => {
        if (item.score) {
          wwTotal += parseFloat(item.score);
          wwMax += parseFloat(item.max_score);
        }
      });
      
      peItems.forEach(item => {
        if (item.score) {
          peTotal += parseFloat(item.score);
          peMax += parseFloat(item.max_score);
        }
      });
      
      let finalGrade = 0;
      
      if (ptMax > 0) finalGrade += (ptTotal / ptMax) * ptWeight * 100;
      if (wwMax > 0) finalGrade += (wwTotal / wwMax) * wwWeight * 100;
      if (peMax > 0) finalGrade += (peTotal / peMax) * peWeight * 100;
      
      document.getElementById('finalGrade').textContent = finalGrade.toFixed(2);
    }
    
    // Navigation functions
    function goBack() {
      window.location.href = 'homepage1.html';
    }
    
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      localStorage.removeItem('name');
      window.location.href = 'login.html';
    }
    
    // Initialize based on role
    const isParent = role === 'parent';
    if (isParent) {
      const childSelect = document.getElementById('childSelect');
      fetch(`${window.API_BASE}/api/children`, { headers: { 'Authorization': `Bearer ${token}` } })
        .then(res => res.json())
        .then(children => {
          if (!children || children.length === 0) return;
          childSelect.style.display = 'inline-block';
          childSelect.innerHTML = '';
          children.forEach(ch => {
            const opt = document.createElement('option');
            opt.value = ch.id;
            opt.textContent = ch.full_name;
            childSelect.appendChild(opt);
          });
          // pick initial child
          window.selectedChildId = initialChildId || String(children[0].id);
          childSelect.value = window.selectedChildId;
          document.getElementById('studentName').textContent = children.find(c => String(c.id) === String(window.selectedChildId))?.full_name || '';
          childSelect.addEventListener('change', () => {
            window.selectedChildId = childSelect.value;
            const chosen = children.find(c => String(c.id) === String(window.selectedChildId));
            document.getElementById('studentName').textContent = chosen?.full_name || '';
            loadGradeData(currentQuarter);
          });
          loadGradeData(1);
        })
        .catch(err => console.error('Failed to load children', err));
    } else {
      // student
      const displayName = localStorage.getItem('fullName') || userObj.name || 'Student';
      document.getElementById('studentName').textContent = displayName;
      loadGradeData(1);
    }
  </script>
</body>
</html>