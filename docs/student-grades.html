<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subject Grades - GradeTracker</title>
  <link rel="icon" href="../favicon.ico" type="image/x-icon" sizes="any">
  <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&display=swap" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.5.0/remixicon.min.css">
  <link rel="stylesheet" href="styles.css">
  <script src="config.js" defer></script>
  <script src="app.js" defer></script>
</head>
<body class="student-grades-page">
  <header class="header">
    <div class="header-title" id="subjectTitle">Subject Grades</div>
    <div class="account-menu" style="display:flex; align-items:center; gap:10px;">
      <span id="studentName"></span>
      <select id="childSelect" style="display:none; margin-left:8px;"></select>
      <button class="account-btn" id="accountBtn"><span id="accountInitial"><i class="ri-user-3-fill"></i></span></button>
      <div class="account-dropdown" id="accountDropdown" aria-hidden="true">
        <div class="account-info">
          <div id="userFullName">User Name</div>
          <div id="userEmail"></div>
        </div>
<button id="logoutBtn" class="logout-btn" onclick="logout()">Log Out</button>
      </div>
    </div>
  </header>
  
  <div class="main">
    <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 0 0 20px 0;">
    <button class="back-btn" onclick="goBack()">← Back to Subjects</button>
    
    <div class="quarter-tabs" id="quarterTabs">
      <div class="quarter-tab active" data-quarter="1">Quarter 1</div>
      <div class="quarter-tab" data-quarter="2">Quarter 2</div>
      <div class="quarter-tab" data-quarter="3">Quarter 3</div>
      <div class="quarter-tab" data-quarter="4">Quarter 4</div>
    </div>
    
    <div id="gradedContent" class="tab-content active">
      <!-- Performance Tasks Section -->
      <div class="category-header">
        <span>Performance Tasks (<span id="ptWeight">0</span>%)</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Index No.</th>
            <th>Task</th>
            <th>Score</th>
            <th>Highest Possible Score</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody id="ptTable">
          <tr><td colspan="5">No data available</td></tr>
        </tbody>
      </table>
      
      <!-- Written Works Section -->
      <div class="category-header">
        <span>Written Works (<span id="wwWeight">0</span>%)</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Index No.</th>
            <th>Task</th>
            <th>Score</th>
            <th>Highest Possible Score</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody id="wwTable">
          <tr><td colspan="5">No data available</td></tr>
        </tbody>
      </table>
      
      <!-- Periodical Exam Section -->
      <div class="category-header">
        <span>Periodical Exam (<span id="peWeight">0</span>%)</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Score</th>
            <th>Highest Possible Score</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody id="peTable">
          <tr><td colspan="4">No data available</td></tr>
        </tbody>
      </table>
      
      <div class="grade-summary">
        <div class="grade-display">
          <div class="grade-label">Quarterly Grade:</div>
          <div class="grade-value" id="finalGrade">N/A</div>
        </div>
        <div class="grade-disclaimer">
          <div class="disclaimer-icon">⚠️</div>
          <div class="disclaimer-text">
            <strong>Important:</strong> This is an estimated grade based on currently entered scores.
          </div>
        </div>
      </div>
      
    </div>
  </div>

  <script>
    // DepEd-style transmutation table (for converting initial grade to quarterly grade)
    const transmutationTable = {
      100: 100, 99: 99, 98: 98, 97: 97, 96: 96, 95: 95,
      94: 94, 93: 93, 92: 92, 91: 91, 90: 90,
      89: 89, 88: 88, 87: 87, 86: 86, 85: 85,
      84: 84, 83: 83, 82: 82, 81: 81, 80: 80,
      79: 79, 78: 78, 77: 77, 76: 76, 75: 75,
      74: 74, 73: 73, 72: 72, 71: 71, 70: 70,
      69: 69, 68: 68, 67: 67, 66: 66, 65: 65,
      64: 64, 63: 63, 62: 62, 61: 61, 60: 60,
      59: 59, 58: 58, 57: 57, 56: 56, 55: 55,
      54: 54, 53: 53, 52: 52, 51: 51, 50: 50,
      49: 49, 48: 48, 47: 47, 46: 46, 45: 45,
      44: 44, 43: 43, 42: 42, 41: 41, 40: 40,
      39: 39, 38: 38, 37: 37, 36: 36, 35: 35,
      34: 34, 33: 33, 32: 32, 31: 31, 30: 30,
      29: 29, 28: 28, 27: 27, 26: 26, 25: 25,
      24: 24, 23: 23, 22: 22, 21: 21, 20: 20,
      19: 75, 18: 74, 17: 73, 16: 72, 15: 71,
      14: 70, 13: 69, 12: 68, 11: 67, 10: 66,
      9: 65, 8: 64, 7: 63, 6: 62, 5: 61,
      4: 60, 3: 60, 2: 60, 1: 60, 0: 60
    };
    function transmute(initial){
      const r = Math.round(Math.max(0, Math.min(100, Number(initial)||0)));
      return transmutationTable[r] || 60;
    }

    // Initialize student grades page only after DOM is ready and config.js has run
    window.addEventListener('DOMContentLoaded', () => {

    // Populate account dropdown from cache (fast) and backfill from /api/me if missing
    (async function(){
      try{
        let full = localStorage.getItem('fullName') || JSON.parse(localStorage.getItem('user')||'{}').name || '';
        let email = localStorage.getItem('email') || '';
        if (!full){
          try{ const r = await fetch(`${window.API_BASE}/api/me`); if (r.ok){ const me = await r.json(); full = me.fullName || `${me.firstName||''} ${me.lastName||''}`.trim(); email = me.email || email; if (full) localStorage.setItem('fullName', full); if (email) localStorage.setItem('email', email); } }catch{}
        }
        const init = (full?.charAt(0)||'U').toUpperCase();
        const iEl = document.getElementById('accountInitial'); if (iEl) iEl.textContent = init;
        const nEl = document.getElementById('userFullName'); if (nEl) nEl.textContent = full || 'User';
        const eEl = document.getElementById('userEmail'); if (eEl) eEl.textContent = email;
      }catch{}
    })();

    // Check session/role via cookie or localStorage
    let role = localStorage.getItem('role');
    const userObj = JSON.parse(localStorage.getItem('user') || '{}');
    async function ensureRole(){
      if (role === 'student' || role === 'parent') return true;
      try{ const r = await fetch(`${window.API_BASE}/api/me`); if (r.ok){ const me=await r.json(); role = me.role; localStorage.setItem('role', role); return (role==='student'||role==='parent'); } }catch{}
      return false;
    }
    (async()=>{ const ok = await ensureRole(); if (!ok) location.href='login.html'; })();
    
    // student name will be set below based on role
    
    // Get subject ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const subjectId = urlParams.get('id');
    const subjectTitle = urlParams.get('title');
    const initialChildId = urlParams.get('childId');
    
    if (!subjectId) {
      window.location.href = 'homepage1.html';
    }
    
    document.getElementById('subjectTitle').textContent = subjectTitle || 'Subject Grades';
    
    // Quarter switching
    const quarterTabs = document.querySelectorAll('.quarter-tab');
    let currentQuarter = 1;
    
    quarterTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        quarterTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentQuarter = tab.getAttribute('data-quarter');
        loadGradeData(currentQuarter);
      });
    });
    
    // Load grade data for the selected quarter
    function cacheKey(q){
      const child = (role === 'parent' && (window.selectedChildId || initialChildId)) ? `:${window.selectedChildId || initialChildId}` : '';
      return `grades:${subjectId}:q${q}${child}`;
    }
    function renderFromCache(q){
      try{
        const raw = localStorage.getItem(cacheKey(q));
        if (!raw) return false;
        const cached = JSON.parse(raw);
        if (!cached || !Array.isArray(cached.items) || !Array.isArray(cached.categories)) return false;
        // Set weights
        cached.categories.forEach(category => {
          if (category.name === 'Performance Task') document.getElementById('ptWeight').textContent = category.weight;
          else if (category.name === 'Written Works') document.getElementById('wwWeight').textContent = category.weight;
          else if (category.name === 'Periodical Exam') document.getElementById('peWeight').textContent = category.weight;
        });
        // Group and render
        const items = cached.items;
        const ptItems = items.filter(i=> i.category_name === 'Performance Task');
        const wwItems = items.filter(i=> i.category_name === 'Written Works');
        const peItems = items.filter(i=> i.category_name === 'Periodical Exam');
        populateTable('ptTable', ptItems, renderPTRow);
        populateTable('wwTable', wwItems, renderWWRow);
        populateTable('peTable', peItems, renderPERow);
        if (cached.summary){
          updateGradeSummary(cached.summary);
        }
        return true;
      }catch{ return false; }
    }

    function loadGradeData(quarter) {
      let lastCategories = [];
      let lastItems = [];
      // Try cached render first (fast UI); otherwise keep current content (including initial 'No data available')
      renderFromCache(quarter);

      const childParam = (role === 'parent' && window.selectedChildId) ? `&childId=${encodeURIComponent(window.selectedChildId)}` : '';
      const categoriesReq = fetch(`${window.API_BASE}/api/subjects/${subjectId}/categories?quarter=${quarter}`).then(r=>r.json());
      const itemsReq = fetch(`${window.API_BASE}/api/subjects/${subjectId}/items?quarter=${quarter}${childParam}`).then(r=>r.json());
      const summaryReq = fetch(`${window.API_BASE}/api/subjects/${subjectId}/grade-summary?quarter=${quarter}${role==='parent' && window.selectedChildId?`&childId=${encodeURIComponent(window.selectedChildId)}`:''}`).then(r=> r.ok ? r.json() : null).catch(()=>null);

      Promise.all([categoriesReq, itemsReq, summaryReq]).then(([categories, items, summary])=>{
        lastCategories = categories || [];
        lastItems = items || [];
        // Set weights for each category
        (categories||[]).forEach(category => {
          if (category.name === 'Performance Task') document.getElementById('ptWeight').textContent = category.weight;
          else if (category.name === 'Written Works') document.getElementById('wwWeight').textContent = category.weight;
          else if (category.name === 'Periodical Exam') document.getElementById('peWeight').textContent = category.weight;
        });

        // Group items by category
        const ptItems = lastItems.filter(item => item.category_name === 'Performance Task');
        const wwItems = lastItems.filter(item => item.category_name === 'Written Works');
        const peItems = lastItems.filter(item => item.category_name === 'Periodical Exam');

        // Populate tables (display-only)
        populateTable('ptTable', ptItems, renderPTRow);
        populateTable('wwTable', wwItems, renderWWRow);
        populateTable('peTable', peItems, renderPERow);

        // Quarterly Grade: use ONLY backend summary (WS) + DepEd transmutation
        if (summary) updateGradeSummary(summary);
        // Cache fresh payload
        try{ localStorage.setItem(cacheKey(quarter), JSON.stringify({ categories: lastCategories, items: lastItems, summary, ts: Date.now() })); }catch{}
      }).catch((error)=>{ console.error('Error loading grade data:', error); });
    }
    
    function populateTable(tableId, items, renderRowFunc) {
      const tableBody = document.getElementById(tableId);
      if (items.length === 0) {
        let colspan = 4;
        if (tableId === 'ptTable' || tableId === 'wwTable') colspan = 5;
        else if (tableId === 'peTable') colspan = 3;
        tableBody.innerHTML = `<tr><td colspan="${colspan}">No data available</td></tr>`;
        return;
      }
      
      tableBody.innerHTML = '';
      items.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = renderRowFunc(item, index + 1);
        tableBody.appendChild(row);
      });
    }
    
    function renderPTRow(item, index) {
      const task = item.title || item.topic || `Task ${index}`;
      const score = (item.score != null) ? item.score : 'N/A';
      const maxScore = (item.max_score != null) ? item.max_score : 'N/A';
      const comments = item.comments || '';
      return `
        <td>${index}</td>
        <td>${task}</td>
        <td>${score}</td>
        <td>${maxScore}</td>
        <td>${comments}</td>
      `;
    }
    
    function renderWWRow(item, index) {
      const task = item.title || item.topic || `Task ${index}`;
      const score = (item.score != null) ? item.score : 'N/A';
      const maxScore = (item.max_score != null) ? item.max_score : 'N/A';
      const comments = item.comments || '';
      return `
        <td>${index}</td>
        <td>${task}</td>
        <td>${score}</td>
        <td>${maxScore}</td>
        <td>${comments}</td>
      `;
    }
    
    function renderPERow(item) {
      const score = (item.score != null) ? item.score : 'N/A';
      const maxScore = (item.max_score != null) ? item.max_score : 'N/A';
      const comments = item.comments || '';
      return `
        <td>${score}</td>
        <td>${maxScore}</td>
        <td>${comments}</td>
      `;
    }
    
    
    // Enhanced grade summary update function
    function updateGradeSummary(summary) {
      const initial = Number(summary.final || 0);
      const quarterly = transmute(initial);
      const finalGradeInt = Math.round(Number(quarterly));
      const completion = Number(summary.completion || 0);
      
      // Update grade value (show transmuted integer grade)
      document.getElementById('finalGrade').textContent = String(finalGradeInt);
      
      // Update progress bar and text
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      if (progressFill) {
        progressFill.style.width = completion + '%';
      }
      
      if (progressText) {
        progressText.textContent = `${completion}% Complete`;
      }
      
      // Update completion note
      const completionNote = document.getElementById('completionNote');
      if (completionNote) {
        if (completion < 100) {
          completionNote.textContent = `Current completion: ${completion}%. This grade will change as more assignments are added and graded.`;
          completionNote.style.color = '#dc2626';
        } else {
          completionNote.textContent = `All assignments for this quarter are complete (${completion}%). This is your final grade for the quarter.`;
          completionNote.style.color = '#059669';
        }
      }
      
      // Add grade interpretation
      const gradeValue = document.getElementById('finalGrade');
      if (gradeValue && finalGrade !== 'N/A') {
        const grade = parseFloat(finalGrade);
        let gradeColor = '#059669'; // Default green
        if (grade < 75) gradeColor = '#dc2626'; // Red for failing
        else if (grade < 85) gradeColor = '#f59e0b'; // Orange for needs improvement
        
        gradeValue.style.color = gradeColor;
      }
    }

    function calculateFinalGrade(ptItems, wwItems, peItems) {
      const ptWeight = parseFloat(document.getElementById('ptWeight').textContent) / 100;
      const wwWeight = parseFloat(document.getElementById('wwWeight').textContent) / 100;
      const peWeight = parseFloat(document.getElementById('peWeight').textContent) / 100;
      
      let ptTotal = 0, ptMax = 0;
      let wwTotal = 0, wwMax = 0;
      let peTotal = 0, peMax = 0;
      
      ptItems.forEach(item => {
        if (item.score != null) {
          ptTotal += parseFloat(item.score);
          ptMax += parseFloat(item.max_score);
        }
      });
      
      wwItems.forEach(item => {
        if (item.score != null) {
          wwTotal += parseFloat(item.score);
          wwMax += parseFloat(item.max_score);
        }
      });
      
      peItems.forEach(item => {
        if (item.score != null) {
          peTotal += parseFloat(item.score);
          peMax += parseFloat(item.max_score);
        }
      });
      
      let initial = 0;
      if (ptMax > 0) initial += (ptTotal / ptMax) * ptWeight * 100;
      if (wwMax > 0) initial += (wwTotal / wwMax) * wwWeight * 100;
      if (peMax > 0) initial += (peTotal / peMax) * peWeight * 100;

      const quarterly = transmute(initial);
      const quarterlyInt = Math.round(Number(quarterly));
      document.getElementById('finalGrade').textContent = String(quarterlyInt);
    }

    
    
    // Navigation functions
    function goBack() {
      window.location.href = 'homepage1.html';
    }
    
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      localStorage.removeItem('name');
      window.location.href = 'login.html';
    }
    
    // Real-time reload via SSE for this subject
    (function(){
      try{
        const tok = localStorage.getItem('token');
        const es = new EventSource(`${window.API_BASE}/api/events${tok?`?token=${encodeURIComponent(tok)}`:''}`);
        es.addEventListener('scoreUpdated', (ev)=>{
          try{
            const p = JSON.parse(ev.data||'{}');
            if (String(p.subjectId) === String(subjectId)) {
              // If parent, ensure it's the selected child
              if (role === 'parent') {
                const sel = window.selectedChildId || localStorage.getItem('selectedChildId');
                if (sel && String(p.student_id) !== String(sel)) return;
              }
              loadGradeData(currentQuarter);
            }
          }catch{}
        });
        es.onerror = ()=>{ try{ es.close(); }catch{} };
      }catch{}
    })();

    // Initialize based on role
    const isParent = role === 'parent';
    if (isParent) {
      const childSelect = document.getElementById('childSelect');
      fetch(`${window.API_BASE}/api/children`)
        .then(res => res.json())
        .then(children => {
          if (!children || children.length === 0) return;
          childSelect.style.display = 'inline-block';
          childSelect.innerHTML = '';
          children.forEach(ch => {
            const opt = document.createElement('option');
            opt.value = ch.id;
            opt.textContent = ch.full_name;
            childSelect.appendChild(opt);
          });
          // pick initial child
          window.selectedChildId = initialChildId || String(children[0].id);
          childSelect.value = window.selectedChildId;
          document.getElementById('studentName').textContent = children.find(c => String(c.id) === String(window.selectedChildId))?.full_name || '';
          childSelect.addEventListener('change', () => {
            window.selectedChildId = childSelect.value;
            const chosen = children.find(c => String(c.id) === String(window.selectedChildId));
            document.getElementById('studentName').textContent = chosen?.full_name || '';
            loadGradeData(currentQuarter);
          });
          loadGradeData(1);
        })
        .catch(err => console.error('Failed to load children', err));
    } else {
      // student
      const displayName = localStorage.getItem('fullName') || userObj.name || 'Student';
      document.getElementById('studentName').textContent = displayName;
      loadGradeData(1);
    }

    });
  </script>
</body>
</html>
