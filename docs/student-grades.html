<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subject Grades - GradeTracker</title>
  <link rel="icon" href="../favicon.ico" type="image/x-icon" sizes="any">
  <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&display=swap" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.5.0/remixicon.min.css">
  <link rel="stylesheet" href="styles.css">
  <script src="config.js" defer></script>
  <script src="chart.js" defer></script>
  <script src="app.js" defer></script>
</head>
<body class="student-grades-page">
  <header class="header">
    <div class="header-title" id="subjectTitle">Subject Grades</div>
    <div class="account-menu" style="display:flex; align-items:center; gap:10px;">
      <span id="studentName"></span>
      <select id="childSelect" style="display:none; margin-left:8px;"></select>
      <button class="account-btn" id="accountBtn"><span id="accountInitial">A</span></button>
      <div class="account-dropdown" id="accountDropdown" aria-hidden="true">
        <div class="account-info">
          <div id="userFullName">User Name</div>
          <div id="userEmail"></div>
        </div>
<button id="logoutBtn" class="logout-btn" onclick="logout()">Log Out</button>
      </div>
    </div>
  </header>
  
  <div class="main">
    <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 0 0 20px 0;">
    <button class="back-btn" onclick="goBack()">← Back to Subjects</button>
    
    <div class="quarter-tabs" id="quarterTabs">
      <div class="quarter-tab active" data-quarter="1">Quarter 1</div>
      <div class="quarter-tab" data-quarter="2">Quarter 2</div>
      <div class="quarter-tab" data-quarter="3">Quarter 3</div>
      <div class="quarter-tab" data-quarter="4">Quarter 4</div>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-tab="graded">Graded Components</div>
      <div class="tab" data-tab="assessment">Assessment</div>
    </div>
    
    <div id="gradedContent" class="tab-content active">
      <!-- Performance Tasks Section -->
      <div class="category-header">
        <span>Performance Tasks (<span id="ptWeight">0</span>%)</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Index No.</th>
            <th>Name of Performance Task</th>
            <th>Topic(s) Involved</th>
            <th>Score</th>
            <th>Highest Possible Score</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody id="ptTable">
          <tr><td colspan="6">No data available</td></tr>
        </tbody>
      </table>
      
      <!-- Written Works Section -->
      <div class="category-header">
        <span>Written Works (<span id="wwWeight">0</span>%)</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Index No.</th>
            <th>Status</th>
            <th>Topic(s)</th>
            <th>Score</th>
            <th>Highest Possible Score</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody id="wwTable">
          <tr><td colspan="6">No data available</td></tr>
        </tbody>
      </table>
      
      <!-- Periodical Exam Section -->
      <div class="category-header">
        <span>Periodical Exam (<span id="peWeight">0</span>%)</span>
      </div>
      <table>
        <thead>
          <tr>
            <th>Topics</th>
            <th>Score</th>
            <th>Highest Possible Score</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody id="peTable">
          <tr><td colspan="4">No data available</td></tr>
        </tbody>
      </table>
      
      <div class="grade-summary">
        <div class="grade-display">
          <div class="grade-label">Estimated Final Grade:</div>
          <div class="grade-value" id="finalGrade">N/A</div>
        </div>
        <div class="grade-progress">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text" id="progressText">0% Complete</div>
        </div>
        <div class="grade-disclaimer">
          <div class="disclaimer-icon">⚠️</div>
          <div class="disclaimer-text">
            <strong>Important:</strong> This is an estimated grade based on currently entered scores. 
            The final grade will be calculated when all assignments for this quarter are completed and graded.
            <span class="completion-note" id="completionNote"></span>
          </div>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="progressChart"></canvas>
      </div>
    </div>
    
    <div id="assessmentContent" class="tab-content">
      <table>
        <thead>
          <tr>
            <th>Index No.</th>
            <th>Topic(s) of Task</th>
            <th>Score</th>
            <th>Highest Possible Score</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody id="assessmentTable">
          <tr><td colspan="5">No data available</td></tr>
        </tbody>
      </table>
    </div> 
  </div>

  <script>
    // Populate account dropdown from cache (fast) and backfill from /api/me if missing
    (async function(){
      try{
        let full = localStorage.getItem('fullName') || JSON.parse(localStorage.getItem('user')||'{}').name || '';
        let email = localStorage.getItem('email') || '';
        if (!full){
          try{ const r = await fetch(`${window.API_BASE}/api/me`); if (r.ok){ const me = await r.json(); full = me.fullName || `${me.firstName||''} ${me.lastName||''}`.trim(); email = me.email || email; if (full) localStorage.setItem('fullName', full); if (email) localStorage.setItem('email', email); } }catch{}
        }
        const init = (full?.charAt(0)||'U').toUpperCase();
        const iEl = document.getElementById('accountInitial'); if (iEl) iEl.textContent = init;
        const nEl = document.getElementById('userFullName'); if (nEl) nEl.textContent = full || 'User';
        const eEl = document.getElementById('userEmail'); if (eEl) eEl.textContent = email;
      }catch{}
    })();

    // Check session/role via cookie or localStorage
    let role = localStorage.getItem('role');
    const userObj = JSON.parse(localStorage.getItem('user') || '{}');
    async function ensureRole(){
      if (role === 'student' || role === 'parent') return true;
      try{ const r = await fetch(`${window.API_BASE}/api/me`); if (r.ok){ const me=await r.json(); role = me.role; localStorage.setItem('role', role); return (role==='student'||role==='parent'); } }catch{}
      return false;
    }
    (async()=>{ const ok = await ensureRole(); if (!ok) location.href='login.html'; })();
    
    // student name will be set below based on role
    
    // Get subject ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const subjectId = urlParams.get('id');
    const subjectTitle = urlParams.get('title');
    const initialChildId = urlParams.get('childId');
    
    if (!subjectId) {
      window.location.href = 'homepage1.html';
    }
    
    document.getElementById('subjectTitle').textContent = subjectTitle || 'Subject Grades';
    
    // Tab switching
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => content.classList.remove('active'));
        
        const tabName = tab.getAttribute('data-tab');
        document.getElementById(tabName + 'Content').classList.add('active');
      });
    });
    
    // Quarter switching
    const quarterTabs = document.querySelectorAll('.quarter-tab');
    let currentQuarter = 1;
    
    quarterTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        quarterTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentQuarter = tab.getAttribute('data-quarter');
        loadGradeData(currentQuarter);
      });
    });
    
    // Load grade data for the selected quarter
    function cacheKey(q){
      const child = (role === 'parent' && (window.selectedChildId || initialChildId)) ? `:${window.selectedChildId || initialChildId}` : '';
      return `grades:${subjectId}:q${q}${child}`;
    }
    function renderFromCache(q){
      try{
        const raw = localStorage.getItem(cacheKey(q));
        if (!raw) return false;
        const cached = JSON.parse(raw);
        if (!cached || !Array.isArray(cached.items) || !Array.isArray(cached.categories)) return false;
        // Set weights
        cached.categories.forEach(category => {
          if (category.name === 'Performance Task') document.getElementById('ptWeight').textContent = category.weight;
          else if (category.name === 'Written Works') document.getElementById('wwWeight').textContent = category.weight;
          else if (category.name === 'Periodical Exam') document.getElementById('peWeight').textContent = category.weight;
        });
        // Group and render
        const items = cached.items;
        const ptItems = items.filter(i=> i.category_name === 'Performance Task');
        const wwItems = items.filter(i=> i.category_name === 'Written Works');
        const peItems = items.filter(i=> i.category_name === 'Periodical Exam');
        const assessmentItems = items.filter(i=> !i.included_in_final);
        populateTable('ptTable', ptItems, renderPTRow);
        populateTable('wwTable', wwItems, renderWWRow);
        populateTable('peTable', peItems, renderPERow);
        populateTable('assessmentTable', assessmentItems, renderAssessmentRow);
        if (cached.summary){
          updateGradeSummary(cached.summary);
        }
        updateChart(items.filter(i=> i.included_in_final));
        return true;
      }catch{ return false; }
    }

    function loadGradeData(quarter) {
      let lastCategories = [];
      let lastItems = [];
      // Try cached render first (fast UI), then fetch fresh in parallel
      if (!renderFromCache(quarter)){
        document.getElementById('ptTable').innerHTML = '<tr><td colspan="6"><div class="loading-placeholder" style="height:16px"></div></td></tr>';
        document.getElementById('wwTable').innerHTML = '<tr><td colspan="6"><div class="loading-placeholder" style="height:16px"></div></td></tr>';
        document.getElementById('peTable').innerHTML = '<tr><td colspan="4"><div class="loading-placeholder" style="height:16px"></div></td></tr>';
        document.getElementById('assessmentTable').innerHTML = '<tr><td colspan="5"><div class="loading-placeholder" style="height:16px"></div></td></tr>';
      }

      const childParam = (role === 'parent' && window.selectedChildId) ? `&childId=${encodeURIComponent(window.selectedChildId)}` : '';
      const categoriesReq = fetch(`${window.API_BASE}/api/subjects/${subjectId}/categories?quarter=${quarter}`).then(r=>r.json());
      const itemsReq = fetch(`${window.API_BASE}/api/subjects/${subjectId}/items?quarter=${quarter}${childParam}`).then(r=>r.json());
      const summaryReq = fetch(`${window.API_BASE}/api/subjects/${subjectId}/grade-summary?quarter=${quarter}${role==='parent' && window.selectedChildId?`&childId=${encodeURIComponent(window.selectedChildId)}`:''}`).then(r=> r.ok ? r.json() : null).catch(()=>null);

      Promise.all([categoriesReq, itemsReq, summaryReq]).then(([categories, items, summary])=>{
        lastCategories = categories || [];
        lastItems = items || [];
        // Set weights for each category
        (categories||[]).forEach(category => {
          if (category.name === 'Performance Task') document.getElementById('ptWeight').textContent = category.weight;
          else if (category.name === 'Written Works') document.getElementById('wwWeight').textContent = category.weight;
          else if (category.name === 'Periodical Exam') document.getElementById('peWeight').textContent = category.weight;
        });

        // Group items by category
        const ptItems = lastItems.filter(item => item.category_name === 'Performance Task');
        const wwItems = lastItems.filter(item => item.category_name === 'Written Works');
        const peItems = lastItems.filter(item => item.category_name === 'Periodical Exam');
        const assessmentItems = lastItems.filter(item => !item.included_in_final);

        // Populate tables
        populateTable('ptTable', ptItems, renderPTRow);
        populateTable('wwTable', wwItems, renderWWRow);
        populateTable('peTable', peItems, renderPERow);
        populateTable('assessmentTable', assessmentItems, renderAssessmentRow);

        // Calculate final grade and update chart
        calculateFinalGrade(ptItems, wwItems, peItems);
        updateChart(lastItems.filter(i => i.included_in_final));

        if (summary) updateGradeSummary(summary);
        // Cache fresh payload
        try{ localStorage.setItem(cacheKey(quarter), JSON.stringify({ categories: lastCategories, items: lastItems, summary, ts: Date.now() })); }catch{}
      }).catch((error)=>{ console.error('Error loading grade data:', error); });
    }
    
    function populateTable(tableId, items, renderRowFunc) {
      const tableBody = document.getElementById(tableId);
      if (items.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6">No data available</td></tr>';
        return;
      }
      
      tableBody.innerHTML = '';
      items.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = renderRowFunc(item, index + 1);
        tableBody.appendChild(row);
      });
    }
    
    function renderPTRow(item, index) {
      return `
        <td>${index}</td>
        <td>${item.title}</td>
        <td>${item.topic || 'N/A'}</td>
        <td>${item.score || 'N/A'}</td>
        <td>${item.max_score}</td>
        <td>${item.comments || ''}</td>
      `;
    }
    
    function renderWWRow(item, index) {
      return `
        <td>${index}</td>
        <td>${item.item_type || 'N/A'}</td>
        <td>${item.topic || 'N/A'}</td>
        <td>${item.score || 'N/A'}</td>
        <td>${item.max_score}</td>
        <td>${item.comments || ''}</td>
      `;
    }
    
    function renderPERow(item) {
      return `
        <td>${item.topic || 'N/A'}</td>
        <td>${item.score || 'N/A'}</td>
        <td>${item.max_score}</td>
        <td>${item.comments || ''}</td>
      `;
    }
    
    function renderAssessmentRow(item, index) {
      return `
        <td>${index}</td>
        <td>${item.topic || 'N/A'}</td>
        <td>${item.score || 'N/A'}</td>
        <td>${item.max_score}</td>
        <td>${item.comments || ''}</td>
      `;
    }
    
    // Enhanced grade summary update function
    function updateGradeSummary(summary) {
      const finalGrade = Number(summary.final || 0).toFixed(2);
      const completion = Number(summary.completion || 0);
      
      // Update grade value
      document.getElementById('finalGrade').textContent = finalGrade;
      
      // Update progress bar and text
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      if (progressFill) {
        progressFill.style.width = completion + '%';
      }
      
      if (progressText) {
        progressText.textContent = `${completion}% Complete`;
      }
      
      // Update completion note
      const completionNote = document.getElementById('completionNote');
      if (completionNote) {
        if (completion < 100) {
          completionNote.textContent = `Current completion: ${completion}%. This grade will change as more assignments are added and graded.`;
          completionNote.style.color = '#dc2626';
        } else {
          completionNote.textContent = `All assignments for this quarter are complete (${completion}%). This is your final grade for the quarter.`;
          completionNote.style.color = '#059669';
        }
      }
      
      // Add grade interpretation
      const gradeValue = document.getElementById('finalGrade');
      if (gradeValue && finalGrade !== 'N/A') {
        const grade = parseFloat(finalGrade);
        let gradeColor = '#059669'; // Default green
        if (grade < 75) gradeColor = '#dc2626'; // Red for failing
        else if (grade < 85) gradeColor = '#f59e0b'; // Orange for needs improvement
        
        gradeValue.style.color = gradeColor;
      }
    }

    let progressChart;
    function calculateFinalGrade(ptItems, wwItems, peItems) {
      const ptWeight = parseFloat(document.getElementById('ptWeight').textContent) / 100;
      const wwWeight = parseFloat(document.getElementById('wwWeight').textContent) / 100;
      const peWeight = parseFloat(document.getElementById('peWeight').textContent) / 100;
      
      let ptTotal = 0, ptMax = 0;
      let wwTotal = 0, wwMax = 0;
      let peTotal = 0, peMax = 0;
      
      ptItems.forEach(item => {
        if (item.score != null) {
          ptTotal += parseFloat(item.score);
          ptMax += parseFloat(item.max_score);
        }
      });
      
      wwItems.forEach(item => {
        if (item.score != null) {
          wwTotal += parseFloat(item.score);
          wwMax += parseFloat(item.max_score);
        }
      });
      
      peItems.forEach(item => {
        if (item.score != null) {
          peTotal += parseFloat(item.score);
          peMax += parseFloat(item.max_score);
        }
      });
      
      let finalGrade = 0;
      
      if (ptMax > 0) finalGrade += (ptTotal / ptMax) * ptWeight * 100;
      if (wwMax > 0) finalGrade += (wwTotal / wwMax) * wwWeight * 100;
      if (peMax > 0) finalGrade += (peTotal / peMax) * peWeight * 100;
      
      document.getElementById('finalGrade').textContent = finalGrade.toFixed(2);
    }

    async function updateChart(allItems) {
      try{
        await ensureChartLib();
        const ctx = document.getElementById('progressChart').getContext('2d');
        const points = [];
        let total = 0, totalMax = 0;
        const sorted = [...allItems].sort((a,b)=>{
          const da = a.date_assigned ? new Date(a.date_assigned).getTime() : 0;
          const db = b.date_assigned ? new Date(b.date_assigned).getTime() : 0;
          return da - db;
        });
        sorted.forEach((it, idx)=>{
          if (it.score != null && it.max_score) {
            total += Number(it.score);
            totalMax += Number(it.max_score);
            const pct = totalMax > 0 ? (total/totalMax)*100 : 0;
            points.push({ x: idx+1, y: Number(pct.toFixed(2)) });
          }
        });
        const data = {
          datasets: [{
            label: 'Progress %',
            data: points,
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37,99,235,0.2)',
            tension: 0.25,
            fill: true,
          }]
        };
        const options = { scales: { x: { title: { display:true, text:'Task #'} }, y: { min:0, max:100, title:{ display:true, text:'%'} } } };
        if (progressChart) { progressChart.data = data; progressChart.options = options; progressChart.update(); }
        else { progressChart = new Chart(ctx, { type:'line', data, options }); }
      }catch(e){ /* no-op */ }
    }

    function ensureChartLib(){
      return new Promise((resolve)=>{
        if (window.Chart) return resolve();
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
        s.onload = ()=> resolve();
        s.onerror = ()=> resolve();
        document.head.appendChild(s);
      });
    }
    
    // Navigation functions
    function goBack() {
      window.location.href = 'homepage1.html';
    }
    
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      localStorage.removeItem('name');
      window.location.href = 'login.html';
    }
    
    // Real-time reload via SSE for this subject
    (function(){
      try{
        const tok = localStorage.getItem('token');
        const es = new EventSource(`${window.API_BASE}/api/events${tok?`?token=${encodeURIComponent(tok)}`:''}`);
        es.addEventListener('scoreUpdated', (ev)=>{
          try{
            const p = JSON.parse(ev.data||'{}');
            if (String(p.subjectId) === String(subjectId)) {
              // If parent, ensure it's the selected child
              if (role === 'parent') {
                const sel = window.selectedChildId || localStorage.getItem('selectedChildId');
                if (sel && String(p.student_id) !== String(sel)) return;
              }
              loadGradeData(currentQuarter);
            }
          }catch{}
        });
        es.onerror = ()=>{ try{ es.close(); }catch{} };
      }catch{}
    })();

    // Initialize based on role
    const isParent = role === 'parent';
    if (isParent) {
      const childSelect = document.getElementById('childSelect');
      fetch(`${window.API_BASE}/api/children`)
        .then(res => res.json())
        .then(children => {
          if (!children || children.length === 0) return;
          childSelect.style.display = 'inline-block';
          childSelect.innerHTML = '';
          children.forEach(ch => {
            const opt = document.createElement('option');
            opt.value = ch.id;
            opt.textContent = ch.full_name;
            childSelect.appendChild(opt);
          });
          // pick initial child
          window.selectedChildId = initialChildId || String(children[0].id);
          childSelect.value = window.selectedChildId;
          document.getElementById('studentName').textContent = children.find(c => String(c.id) === String(window.selectedChildId))?.full_name || '';
          childSelect.addEventListener('change', () => {
            window.selectedChildId = childSelect.value;
            const chosen = children.find(c => String(c.id) === String(window.selectedChildId));
            document.getElementById('studentName').textContent = chosen?.full_name || '';
            loadGradeData(currentQuarter);
          });
          loadGradeData(1);
        })
        .catch(err => console.error('Failed to load children', err));
    } else {
      // student
      const displayName = localStorage.getItem('fullName') || userObj.name || 'Student';
      document.getElementById('studentName').textContent = displayName;
      loadGradeData(1);
    }
  </script>
</body>
</html>
