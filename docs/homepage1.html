<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GradeTracker ‚Äî Student Home</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.5.0/remixicon.min.css">
  <link rel="stylesheet" href="styles.css">
  <script src="config.js" defer></script>
</head>
<body class="homepage1">
  <div class="sidebar">
    <div class="top">
      <ul class="nav">
        <li class="active" onclick="location.href='homepage1.html'">Home</li>
        <li onclick="location.href='settings.html'">Settings</li>
        <li id="aboutBtn">About</li>
      </ul>
    </div>
    <div class="bottom">
      <div class="app-version">Grade Tracker v1.0</div>
    </div>
  </div>

  <div class="main">
    <header class="header">
      <div class="header-title">Welcome</div>

      <div class="account-menu">
        <button class="account-btn" onclick="toggleAccountMenu()">
          <span id="accountInitial">A</span>
        </button>
        <div class="account-dropdown" id="accountDropdown" aria-hidden="true">
          <div class="account-info">
            <div id="userFullName">User Name</div>
            <div id="userEmail"></div>
          </div>
          <button onclick="logout()">Log Out</button>
        </div>
      </div>
    </header>

    <div class="header-actions" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <h2 style="margin:0;" id="classesHeader">Classes</h2>
      <button class="join-btn" id="joinBtn">+ Join Class</button>
    </div>
    
    <!-- Parent context indicator -->
    <div id="parentContext" style="display: none; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 12px; margin-bottom: 16px; color: #0369a1;">
      <div style="display: flex; align-items: center; gap: 8px;">
        <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
        <span>Viewing <strong id="childNameDisplay"></strong>'s classes and grades</span>
        <button onclick="switchChild()" style="margin-left: auto; background: #0ea5e9; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">Switch Child</button>
      </div>
    </div>

    <div class="classroom-tabs" id="classroomTabs">
      <!-- if no classes, JS will insert .no-classes with the button below -->
    </div>

    <!-- Place Add/Join area after classes -->
    <div id="classActionArea" class="class-action-area">
      <!-- JS will render the correct button(s) here -->
    </div>

    <!-- Join Class Modal (kept but styled via styles.css) -->
    <div id="joinModal" class="modal" aria-hidden="true">
      <div class="modal-panel">
        <div class="modal-header">
          <div class="modal-title">Join Class</div>
          <button id="closeJoin" class="modal-close" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body">
          <label>Subject Name</label>
          <input id="joinSubject" placeholder="e.g., Mathematics">

          <label>Class / Section</label>
          <input id="joinSection" placeholder="e.g., Section A">

          <label>Access Code</label>
          <input id="joinCode" placeholder="Paste the 8-char access code">
        </div>
        <div class="modal-actions">
          <button id="cancelJoin" class="btn-muted">Cancel</button>
          <button id="confirmJoin" class="btn-primary">Join</button>
        </div>
      </div>
    </div>
  </div>

  <!-- About modal (no profile info) -->
  <div id="aboutModal" class="modal" aria-hidden="true" style="display:none;">
    <div class="modal-panel">
      <div class="modal-header">
        <div class="modal-title">About GradeScope Lite</div>
        <button class="modal-close" onclick="closeAbout()" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <p>This website acts as a Grade Tracker to track the quizzes and scores of students in a faster way. It can be used by students, teachers, and parents.</p>
        <p><strong>Version:</strong> V1.0</p>
        <p><strong>Developed by:</strong> Group 4 Practical Research Group [12-Lovelace]</p>
        <p><strong>Main Dev:</strong> Jack Dylan Gallentes</p>
      </div>
    </div>
  </div>
  
  <script>
    const role = localStorage.getItem('role');
    if (!role || !localStorage.getItem('token')) {
      window.location.href = 'login.html';
    }
    // Only redirect teachers to their homepage; allow students and parents here
    if (role === 'teacher') {
      window.location.href = 'homepage2.html';
    }
    
    // Set role-based theme immediately
    document.body.dataset.role = role;

    // --- Account Initial ---
    const user = JSON.parse(localStorage.getItem('user')) || { name: "Student" };
    const isParent = role === 'parent';
    const selectedChildName = localStorage.getItem('selectedChildName');
    
    // Show appropriate name in header
    let displayName = user.name;
    if (isParent && selectedChildName) {
      displayName = selectedChildName; // Show child's name for parents
    }
    
    document.getElementById('accountInitial').textContent = (displayName && displayName[0]) || 'A';
    
    // Update header title based on role
    const headerTitle = document.querySelector('.header-title');
    if (isParent) {
      headerTitle.textContent = `${selectedChildName || "Child"}'s Dashboard`;
      headerTitle.style.fontSize = '1.2rem';
    } else {
      headerTitle.textContent = 'Welcome';
    }

    // Fetch user data for dropdown
    fetch(`${window.API_BASE}/api/me`, {
      headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
    })
      .then(res => res.json())
      .then(userData => {
        // Store user data in localStorage for future use
        localStorage.setItem('firstName', userData.firstName || '');
        localStorage.setItem('lastName', userData.lastName || '');
        localStorage.setItem('fullName', userData.fullName || `${userData.firstName || ''} ${userData.lastName || ''}`.trim());
        if (userData.email) localStorage.setItem('email', userData.email);
        
        let displayName = `${userData.firstName || ''}${userData.lastName ? ', ' + userData.lastName : ''}`.trim() || userData.fullName || user.name || 'User Name';
        
        // For parents, show child name in account dropdown but keep parent info
        if (isParent && selectedChildName) {
          document.getElementById('userFullName').innerHTML = `
            <div style="font-weight: 600;">${displayName} (Parent)</div>
            <div style="font-size: 0.85em; color: #666; margin-top: 2px;">Viewing: ${selectedChildName}</div>
          `;
          document.getElementById('accountInitial').textContent = (selectedChildName && selectedChildName[0]) || 'A';
        } else {
          document.getElementById('userFullName').textContent = displayName;
          document.getElementById('accountInitial').textContent = (displayName && displayName[0]) || 'A';
        }
        
        document.getElementById('userEmail').textContent = userData.email || localStorage.getItem('email') || '';
      })
      .catch(err => {
        console.error('Error fetching user data:', err);
        // Use localStorage as fallback
        let displayName = `${localStorage.getItem('firstName') || ''}${localStorage.getItem('lastName') ? ', ' + localStorage.getItem('lastName') : ''}`.trim() || localStorage.getItem('fullName') || user.name || 'User Name';
        
        // For parents, show child name in account dropdown but keep parent info
        if (isParent && selectedChildName) {
          document.getElementById('userFullName').innerHTML = `
            <div style="font-weight: 600;">${displayName} (Parent)</div>
            <div style="font-size: 0.85em; color: #666; margin-top: 2px;">Viewing: ${selectedChildName}</div>
          `;
        } else {
          document.getElementById('userFullName').textContent = displayName;
        }
        
        document.getElementById('userEmail').textContent = localStorage.getItem('email') || user.email || '';
      });

    function goHome() { location.reload(); }
    function goSettings() { 
      window.location.href = "settings.html";
    }

    function toggleAccountMenu(event) {
      event && event.stopPropagation();
      document.getElementById('accountDropdown').classList.toggle('show');
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      localStorage.removeItem('user');
      localStorage.removeItem('fullName');
      localStorage.removeItem('email');
      localStorage.removeItem('selectedChildId');
      localStorage.removeItem('selectedChildName');
      window.location.href = 'login.html';
    }
    
    // Parent context functions
    function showParentContext() {
      if (isParent && selectedChildName) {
        document.getElementById('parentContext').style.display = 'block';
        document.getElementById('childNameDisplay').textContent = selectedChildName;
        document.getElementById('classesHeader').textContent = `${selectedChildName}'s Classes`;
      }
    }
    
    async function switchChild() {
      if (!isParent) return;
      
      try {
        const response = await fetch(`${window.API_BASE}/api/children`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        
        if (!response.ok) throw new Error('Failed to load children');
        
        const children = await response.json();
        
        if (children.length <= 1) {
          alert('Only one child found in your account.');
          return;
        }
        
        // Create simple child selection UI
        const selectedId = await showChildSwitchModal(children);
        if (selectedId) {
          const selectedChild = children.find(c => c.id === selectedId);
          localStorage.setItem('selectedChildId', selectedId.toString());
          localStorage.setItem('selectedChildName', selectedChild.full_name);
          location.reload(); // Refresh to show new child's data
        }
        
      } catch (error) {
        console.error('Error switching child:', error);
        alert('Failed to switch child. Please try again.');
      }
    }
    
    function showChildSwitchModal(children) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:200;';
        
        const content = document.createElement('div');
        content.style.cssText = 'background:#fff;border-radius:12px;padding:2rem;max-width:400px;width:90%;';
        
        content.innerHTML = `
          <h3 style="margin-bottom: 1rem;">Switch Child</h3>
          <div id="childOptions" style="display:flex;flex-direction:column;gap:0.5rem;margin-bottom:1rem;"></div>
          <div style="display:flex;justify-content:flex-end;gap:0.5rem;">
            <button onclick="this.closest('[style*=fixed]').remove()" style="padding:0.5rem 1rem;background:#e5e7eb;border:none;border-radius:6px;cursor:pointer;">Cancel</button>
          </div>
        `;
        
        const optionsContainer = content.querySelector('#childOptions');
        
        children.forEach(child => {
          const option = document.createElement('button');
          option.style.cssText = 'padding:1rem;background:#f8fafc;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer;text-align:left;transition:all 0.15s;';
          option.textContent = child.full_name;
          
          if (child.id.toString() === localStorage.getItem('selectedChildId')) {
            option.style.borderColor = '#2563eb';
            option.style.background = '#eff6ff';
            option.innerHTML += ' <span style="color:#2563eb;font-weight:600;">(Current)</span>';
          }
          
          option.onclick = () => {
            modal.remove();
            resolve(child.id);
          };
          
          optionsContainer.appendChild(option);
        });
        
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        modal.onclick = (e) => {
          if (e.target === modal) {
            modal.remove();
            resolve(null);
          }
        };
      });
    }
    
    // Initialize parent context if applicable
    showParentContext();

    function showAbout() {
      const m = document.getElementById('aboutModal');
      m.style.display = 'flex';
      requestAnimationFrame(() => m.classList.add('show'));
    }

    function closeAbout() {
      const m = document.getElementById('aboutModal');
      m.classList.remove('show');
      setTimeout(() => { m.style.display = 'none'; }, 180);
    }

    // Improve dropdown reliability
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('accountDropdown');
      const btn = document.querySelector('.account-btn');
      if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
        dropdown.classList.remove('show');
      }
    });
    document.querySelector('.account-btn').addEventListener('click', (e) => e.stopPropagation());
    document.getElementById('accountDropdown').addEventListener('click', (e) => e.stopPropagation());
    // About open/close
    document.getElementById('aboutBtn').addEventListener('click', (e) => {
      e.stopPropagation();
      showAbout();
    });
    window.addEventListener('click', (event) => {
      if (event.target === document.getElementById('aboutModal')) {
        closeAbout();
      }
    });

    // --- Fetch classes from backend ---
    function renderClasses(classes) {
      const container = document.getElementById('classroomTabs');
      container.innerHTML = "";
      if (!classes.length) {
        container.innerHTML = "<div>No classes found.</div>";
        return;
      }
      classes.forEach(cls => {
        const div = document.createElement('div');
        div.className = "class-tab";
        let meta = `${cls.grade_level || cls.gradeLevel || 'Grade 10'} - ${cls.section}`;
        if (role === 'parent' && cls.student_name) {
          meta = `${meta} ‚Ä¢ ${cls.student_name}`;
        }
        div.innerHTML = `<div class="class-title">${cls.title}</div><div class="class-section">${meta}</div>`;
        const url = (role === 'parent' && cls.student_id)
          ? `student-grades.html?id=${encodeURIComponent(cls.id)}&title=${encodeURIComponent(cls.title)}&childId=${encodeURIComponent(cls.student_id)}`
          : `student-grades.html?id=${encodeURIComponent(cls.id)}&title=${encodeURIComponent(cls.title)}`;
        div.onclick = () => { window.location.href = url; };
        container.appendChild(div);
      });
    }

    // Performance-optimized class loading with caching
    class FastClassLoader {
      constructor() {
        this.cache = new Map();
        this.cacheExpiry = 5 * 60 * 1000; // 5 minutes
        this.loadClasses();
      }
      
      async loadClasses() {
        const container = document.getElementById('classroomTabs');
        
        // Show loading placeholder
        container.innerHTML = this.getLoadingHTML();
        
        try {
          const isParent = localStorage.getItem('role') === 'parent';
          const selectedChildId = localStorage.getItem('selectedChildId');
          const cacheKey = isParent ? `parent-classes-${selectedChildId}` : 'user-classes';
          
          const cached = this.cache.get(cacheKey);
          
          if (cached && Date.now() - cached.timestamp < this.cacheExpiry) {
            console.log('Loading classes from cache');
            this.renderClasses(cached.data);
            return;
          }
          
          const startTime = performance.now();
          let apiUrl = `${window.API_BASE}/api/classes`;
          
          // For parents, we need to get their child's classes
          if (isParent && selectedChildId) {
            apiUrl += `?childId=${selectedChildId}`;
          }
          
          const response = await fetch(apiUrl, {
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
          });
          
          if (!response.ok) {
            if (response.status === 401) {
              localStorage.clear();
              window.location.replace('login.html');
              return;
            }
            throw new Error('Failed to load classes');
          }
          
          const classes = await response.json();
          const loadTime = performance.now() - startTime;
          
          // Cache the results
          this.cache.set(cacheKey, {
            data: classes,
            timestamp: Date.now()
          });
          
          const context = isParent ? `(for ${localStorage.getItem('selectedChildName') || 'child'})` : '';
          console.log(`Classes loaded in ${loadTime.toFixed(2)}ms ${context}`);
          this.renderClasses(classes);
          
        } catch (error) {
          console.error('Error loading classes:', error);
          container.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 20px;">Failed to load classes. <button onclick="location.reload()" style="background: none; border: 1px solid #ef4444; color: #ef4444; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;">Retry</button></div>';
        }
      }
      
      getLoadingHTML() {
        return `
          <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
            ${Array(3).fill().map(() => `
              <div class="loading-placeholder" style="height: 140px; background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 37%, #f0f0f0 63%); background-size: 400% 100%; animation: skeleton-loading 1.5s ease-in-out infinite; border-radius: 12px;"></div>
            `).join('')}
          </div>
          <style>
            @keyframes skeleton-loading {
              0% { background-position: 100% 50%; }
              100% { background-position: -100% 50%; }
            }
          </style>
        `;
      }
      
      renderClasses(classes) {
        const container = document.getElementById('classroomTabs');
        
        if (!classes || classes.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No classes found. Click "+ Add Class" to join a class.</div>';
          return;
        }
        
        // Use document fragment for better performance
        const fragment = document.createDocumentFragment();
        
        classes.forEach((cls, index) => {
          const div = document.createElement('div');
          div.className = 'class-tab fade-in';
          div.style.animationDelay = `${index * 0.1}s`;
          
          const isParent = localStorage.getItem('role') === 'parent';
          const selectedChildId = localStorage.getItem('selectedChildId');
          
          let meta = `${cls.grade_level || cls.gradeLevel || 'Grade 10'} - ${cls.section}`;
          
          div.innerHTML = `
            <div class="class-title">${cls.title}</div>
            <div class="class-section">${meta}</div>
          `;
          
          // For parents, always use the selected child context
          const url = isParent && selectedChildId
            ? `student-grades.html?id=${encodeURIComponent(cls.id)}&title=${encodeURIComponent(cls.title)}&childId=${encodeURIComponent(selectedChildId)}`
            : `student-grades.html?id=${encodeURIComponent(cls.id)}&title=${encodeURIComponent(cls.title)}`;
            
          div.onclick = () => window.location.href = url;
          
          // Add lazy loading for class details
          this.setupLazyLoading(div, cls.id);
          
          fragment.appendChild(div);
        });
        
        container.innerHTML = '';
        container.appendChild(fragment);
        
        // Add CSS animation
        if (!document.querySelector('#fade-in-styles')) {
          const style = document.createElement('style');
          style.id = 'fade-in-styles';
          style.textContent = `
            .fade-in {
              opacity: 0;
              transform: translateY(20px);
              animation: fadeInUp 0.6s ease forwards;
            }
            @keyframes fadeInUp {
              to {
                opacity: 1;
                transform: translateY(0);
              }
            }
          `;
          document.head.appendChild(style);
        }
      }
      
      setupLazyLoading(element, classId) {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('in-viewport');
              // Preload class data when visible
              this.preloadClassData(classId);
              observer.unobserve(entry.target);
            }
          });
        });
        
        observer.observe(element);
      }
      
      async preloadClassData(classId) {
        try {
          const cacheKey = `class-${classId}`;
          if (!this.cache.has(cacheKey)) {
            const response = await fetch(`${window.API_BASE}/api/classes/${classId}`, {
              headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
            });
            
            if (response.ok) {
              const data = await response.json();
              this.cache.set(cacheKey, { data, timestamp: Date.now() });
            }
          }
        } catch (error) {
          console.error('Error preloading class data:', error);
        }
      }
    }
    
    // Initialize fast class loader
    new FastClassLoader();

    // Join Class interactions
    document.getElementById('joinBtn').addEventListener('click', () => {
      document.getElementById('joinModal').style.display = 'block';
    });
    document.getElementById('closeJoin').addEventListener('click', () => {
      document.getElementById('joinModal').style.display = 'none';
    });
    document.getElementById('cancelJoin').addEventListener('click', () => {
      document.getElementById('joinModal').style.display = 'none';
    });
    document.getElementById('confirmJoin').addEventListener('click', async () => {
      const accessCode = document.getElementById('joinCode').value.trim();
      if (!accessCode) { alert('Access code is required'); return; }
      try {
        const resp = await fetch(`${window.API_BASE}/api/subjects/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('token') },
          body: JSON.stringify({ accessCode })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.message || 'Failed to join');
        alert('Joined successfully');
        document.getElementById('joinModal').style.display = 'none';
        location.reload();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    });

    // Add hint for access code
    document.getElementById('joinCode').addEventListener('focus', () => {
      if (!document.getElementById('joinCode').value) {
        document.getElementById('joinCode').placeholder = 'Enter 8-character access code from teacher';
      }
    });
  </script>
</body>
</html>
