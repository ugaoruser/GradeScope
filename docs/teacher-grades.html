<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Grade Management — GradeTracker</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&display=swap" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.5.0/remixicon.min.css">
  <link rel="stylesheet" href="styles.css">
  <script src="config.js" defer></script>
  <script src="chart.js" defer></script>
  <script src="app.js" defer></script>
</head>
<body class="teacher-grades-page">
  <header class="header">
    <div class="header-title">Welcome</div>
    <div class="account-menu">
      <button class="account-btn" id="accountBtnT"><span id="accountInitial">T</span></button>
      <div class="account-dropdown" id="accountDropdown" aria-hidden="true">
        <div class="account-info">
          <div id="userFullName">User Name</div>
          <div id="userEmail"></div>
        </div>
        <button id="logoutBtnT">Log Out</button>
      </div>
    </div>
  </header>
  
  <div class="container">
    <button class="back-button" onclick="goBack()">← Back to Subjects</button>
    
    <div class="class-header">
      <h2 id="subjectTitle">Subject Name</h2>
      <div class="class-code" id="sectionCode">Section: </div>
    </div>
    
    <div class="student-selector">
      <label for="studentSelect">Select Student:</label>
      <select id="studentSelect" onchange="loadStudentGrades()">
        <option value="">All Students</option>
      </select>
    </div>
    
    <div class="quarter-tabs">
      <button class="tab-button active" data-quarter="1" onclick="switchQuarter(1)">Quarter 1</button>
      <button class="tab-button" data-quarter="2" onclick="switchQuarter(2)">Quarter 2</button>
      <button class="tab-button" data-quarter="3" onclick="switchQuarter(3)">Quarter 3</button>
      <button class="tab-button" data-quarter="4" onclick="switchQuarter(4)">Quarter 4</button>
    </div>
    
    <!-- AI Chatbot Assistant -->
    <div class="chatbot-assistant">
      <div class="chatbot-header">
        <h3>AI Feedback Assistant</h3>
        <button id="toggleChatbot" class="toggle-chatbot">Show</button>
      </div>
      <div class="chatbot-content" style="display: none;">
        <div class="feedback-form">
          <h4>Generate Feedback</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="feedbackScore">Score</label>
              <input type="number" id="feedbackScore" min="0" max="100" value="85">
            </div>
            <div class="form-group">
              <label for="feedbackTopic">Topic</label>
              <input type="text" id="feedbackTopic" placeholder="e.g., Algebra, Essay Writing">
            </div>
            <div class="form-group">
              <button id="generateFeedback" class="btn-primary">Generate</button>
            </div>
          </div>
        </div>
        <div class="feedback-results">
          <div class="feedback-message">
            <h4>Personalized Feedback</h4>
            <p id="personalizedFeedback">Generate feedback to see results</p>
          </div>
          <div class="feedback-suggestions">
            <h4>Teaching Suggestions</h4>
            <ul id="improvementSuggestions">
              <li>Generate feedback to see suggestions</li>
            </ul>
          </div>
          <button id="copyFeedback" class="btn-secondary">Copy to Comments</button>
        </div>
      </div>
    </div>
    
    <!-- Performance Visualization Section -->
    <div class="performance-visualization">
      <div class="visualization-header">
        <h3>Student Performance Trends</h3>
        <div class="visualization-controls">
          <select id="chartType">
            <option value="line">Line Chart</option>
            <option value="bar">Bar Chart</option>
            <option value="radar">Radar Chart</option>
          </select>
          <select id="timeRange">
            <option value="quarter">Current Quarter</option>
            <option value="year">Full Year</option>
          </select>
          <button id="exportReport" class="btn-primary">Export Report</button>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="performanceChart"></canvas>
      </div>
      <div class="chart-legend">
        <div class="legend-item">
          <div class="legend-color" style="background-color: rgba(54, 162, 235, 0.8);"></div>
          <div class="legend-label">Selected Student</div>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background-color: rgba(255, 99, 132, 0.8);"></div>
          <div class="legend-label">Class Average</div>
        </div>
      </div>
    </div>
    
    <div class="weights-container">
      <div class="weights-title">Grade Category Weights</div>
      <div id="categoryWeights">
        <div class="category-weight">
          <label>Performance Task:</label>
          <input type="number" id="weightPT" min="0" max="100" value="50">%
        </div>
        <div class="category-weight">
          <label>Written Works:</label>
          <input type="number" id="weightWW" min="0" max="100" value="30">%
        </div>
        <div class="category-weight">
          <label>Periodical Exam:</label>
          <input type="number" id="weightPE" min="0" max="100" value="20">%
        </div>
        <button class="btn-submit" onclick="saveWeights()" id="saveWeightsBtn">Save Weights</button>
      </div>
    </div>
    
    <div class="category-tabs">
      <button class="tab-button active" data-category="pt" onclick="switchCategory('pt')">Performance Tasks</button>
      <button class="tab-button" data-category="ww" onclick="switchCategory('ww')">Written Works</button>
      <button class="tab-button" data-category="pe" onclick="switchCategory('pe')">Periodical Exam</button>
    </div>
    
    <div class="add-grade-form" id="addGradeForm">
      <h3>Add New Grade Item</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="itemTitle">Title</label>
          <input type="text" id="itemTitle" placeholder="e.g. Quiz 1">
        </div>
        <div class="form-group">
          <label for="itemTopic">Topic</label>
          <input type="text" id="itemTopic" placeholder="e.g. Algebra">
        </div>
        <div class="form-group">
          <label for="itemType">Type</label>
          <select id="itemType">
            <option value="Quiz">Quiz</option>
            <option value="Project">Project</option>
            <option value="Homework">Homework</option>
            <option value="Exam">Exam</option>
            <option value="Assessment">Assessment</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="maxScore">Maximum Score</label>
          <input type="number" id="maxScore" value="100">
        </div>
        <div class="form-group">
          <label for="dateAssigned">Date Assigned</label>
          <input type="date" id="dateAssigned">
        </div>
        <div class="form-group">
          <label for="includedInFinal">Include in Final Grade</label>
          <select id="includedInFinal">
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn-cancel" onclick="toggleAddForm(false)">Cancel</button>
        <button class="btn-submit" onclick="saveGradeItem()">Save Grade Item</button>
      </div>
    </div>
    
    <button class="action-btn" onclick="toggleAddForm(true)" id="addItemBtn">Add New Grade Item</button>
    
    <div id="ptContent" class="category-content">
      <h3>Performance Tasks</h3>
      <table class="grade-table" id="ptTable">
        <thead>
          <tr>
            <th>Title</th>
            <th>Topic</th>
            <th>Max Score</th>
            <th>Date Assigned</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Will be populated by JavaScript -->
        </tbody>
      </table>
    </div>
    
    <div id="wwContent" class="category-content hidden">
      <h3>Written Works</h3>
      <table class="grade-table" id="wwTable">
        <thead>
          <tr>
            <th>Title</th>
            <th>Topic</th>
            <th>Max Score</th>
            <th>Date Assigned</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Will be populated by JavaScript -->
        </tbody>
      </table>
    </div>
    
    <div id="peContent" class="category-content hidden">
      <h3>Periodical Exam</h3>
      <table class="grade-table" id="peTable">
        <thead>
          <tr>
            <th>Title</th>
            <th>Topic</th>
            <th>Max Score</th>
            <th>Date Assigned</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Will be populated by JavaScript -->
        </tbody>
      </table>
    </div>
    
    <div id="studentGradesSection" class="hidden">
      <h3>Student Grades</h3>
      <table class="grade-table" id="studentGradesTable">
        <thead>
          <tr>
            <th>Grade Item</th>
            <th>Score</th>
            <th>Max Score</th>
            <th>Percentage</th>
            <th>Comments</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Will be populated by JavaScript -->
        </tbody>
      </table>
      
      <div class="add-grade-form" id="addScoreForm" style="display: none;">
        <h3>Add/Edit Student Score</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="gradeItemSelect">Grade Item</label>
            <select id="gradeItemSelect">
              <!-- Will be populated by JavaScript -->
            </select>
          </div>
          <div class="form-group">
            <label for="scoreValue">Score</label>
            <input type="number" id="scoreValue">
          </div>
          <div class="form-group">
            <label for="scoreMaxValue">Max Score</label>
            <input type="number" id="scoreMaxValue" disabled>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="scoreComments">Comments</label>
            <textarea id="scoreComments" rows="3"></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn-cancel" onclick="toggleScoreForm(false)">Cancel</button>
          <button class="btn-submit" onclick="saveStudentScore()">Save Score</button>
        </div>
      </div>
      
      <button class="action-btn" onclick="toggleScoreForm(true)" id="addScoreBtn">Add New Score</button>
    </div>
  </div>
  
  <script>
    // --- Routing: Only allow logged-in teachers ---
    const role = localStorage.getItem('role');
    const token = localStorage.getItem('token');
    const userName = localStorage.getItem('userName');
    const urlParamsAll = new URLSearchParams(window.location.search);
    const readOnlyMode = urlParamsAll.get('readonly') === '1';
    
    if (!role || role !== 'teacher') {
      window.location.href = 'login.html';
    }
    
    // Populate account dropdown with latest cached values
    (function(){
      try{
        const full = localStorage.getItem('fullName') || localStorage.getItem('userName') || 'Teacher';
        const email = localStorage.getItem('email') || '';
        const init = (full.charAt(0)||'T').toUpperCase();
        const iEl = document.getElementById('accountInitial'); if (iEl) iEl.textContent = init;
        const nEl = document.getElementById('userFullName'); if (nEl) nEl.textContent = full;
        const eEl = document.getElementById('userEmail'); if (eEl) eEl.textContent = email;
      }catch{}
    })();
    
    // --- Get subject from URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const subjectId = urlParams.get('id');
    const subjectName = urlParams.get('name') || "Subject";
document.getElementById('subjectTitle').textContent = subjectName;
    // Fetch subject details to show section/grade level
    (function fetchSubjectMeta(){
      fetch(`${window.API_BASE}/api/subjects?title=${encodeURIComponent(subjectName)}`)
        .then(r=>r.json())
        .then(list=>{
          const subj = Array.isArray(list) ? list.find(s=> (s.title||'')===subjectName) : null;
          if (subj){
            const sec = subj.section || subj.grade_level || '';
            if (sec){ const el=document.getElementById('sectionCode'); if (el) el.textContent = `Section: ${sec}`; }
          }
        }).catch(()=>{});
    })();
    
    // Global variables
    let currentQuarter = 1;
    let currentCategory = 'pt';
    let gradeCategories = [];
    let gradeItems = [];
    let students = [];
    let selectedStudentId = '';
    let editingItemId = null;
    let editingScoreId = null;
    const initialStudentId = urlParams.get('student_id') || '';
    const viewMode = urlParams.get('view') === 'assessment' ? 'assessment' : 'final';
    
    // --- Initialize page ---
    function init() {
      loadStudents();
      loadGradeCategories();
      loadGradeItems();
      
      // Set today's date as default for new items
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateAssigned').value = today;
    }
    
    // --- Navigation functions ---
    function goBack() {
      const role = localStorage.getItem('role');
      window.location.href = role === 'teacher' ? 'homepage2.html' : 'homepage1.html';
    }
    
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      localStorage.removeItem('userId');
      localStorage.removeItem('userName');
      window.location.href = 'login.html';
    }
    
    // --- Tab switching functions ---
    function switchQuarter(quarter) {
      currentQuarter = quarter;
      
      // Update active tab
      document.querySelectorAll('.quarter-tabs .tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.quarter-tabs .tab-button[data-quarter="${quarter}"]`).classList.add('active');
      
      // Reload data for the new quarter
      loadGradeCategories();
      loadGradeItems();
      
      if (selectedStudentId) {
        loadStudentGrades();
      }
    }
    
    function switchCategory(category) {
      currentCategory = category;
      
      // Update active tab
      document.querySelectorAll('.category-tabs .tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.category-tabs .tab-button[data-category="${category}"]`).classList.add('active');
      
      // Show/hide content
      document.querySelectorAll('.category-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`${category}Content`).classList.remove('hidden');
    }
    
    // --- Data loading functions ---
    function loadStudents() {
      const select = document.getElementById('studentSelect');
      while (select.options.length > 1) { select.remove(1); }
      const placeholder = document.createElement('option'); placeholder.disabled = true; placeholder.text='Loading...'; select.appendChild(placeholder);
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/students`)
      .then(res => {
        if (!res.ok) throw new Error('Failed to load students');
        return res.json();
      })
      .then(data => {
        students = data;
        const select = document.getElementById('studentSelect');
        
        // Clear existing options except the first one
        while (select.options.length > 1) {
          select.remove(1);
        }
        
        // Add student options
        students.forEach(student => {
          const option = document.createElement('option');
          option.value = student.id;
          option.textContent = student.full_name;
          select.appendChild(option);
        });
        // Preselect from URL and load
        if (initialStudentId) {
          select.value = initialStudentId;
          loadStudentGrades();
        }
      })
      .catch(err => {
        console.error('Error loading students:', err);
        alert('Failed to load students. Please try again.');
      });
    }
    
    function loadGradeCategories() {
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/categories?quarter=${currentQuarter}`)
      .then(res => {
        if (!res.ok) throw new Error('Failed to load grade categories');
        return res.json();
      })
      .then(data => {
        gradeCategories = data;
        
        // Update weight inputs
        const ptCategory = gradeCategories.find(cat => cat.name === 'Performance Task');
        const wwCategory = gradeCategories.find(cat => cat.name === 'Written Works');
        const peCategory = gradeCategories.find(cat => cat.name === 'Periodical Exam');
        
        if (ptCategory) document.getElementById('weightPT').value = ptCategory.weight;
        if (wwCategory) document.getElementById('weightWW').value = wwCategory.weight;
        if (peCategory) document.getElementById('weightPE').value = peCategory.weight;
      })
      .catch(err => {
        console.error('Error loading grade categories:', err);
      });
    }
    
    function loadGradeItems() {
      document.querySelector('#ptTable tbody').innerHTML = '<tr><td colspan="5"><div class="loading-placeholder" style="height:16px"></div></td></tr>';
      document.querySelector('#wwTable tbody').innerHTML = '<tr><td colspan="5"><div class="loading-placeholder" style="height:16px"></div></td></tr>';
      document.querySelector('#peTable tbody').innerHTML = '<tr><td colspan="5"><div class="loading-placeholder" style="height:16px"></div></td></tr>';
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/items?quarter=${currentQuarter}`)
      .then(res => {
        if (!res.ok) throw new Error('Failed to load grade items');
        return res.json();
      })
      .then(data => {
        gradeItems = data;
        
        // Clear tables
        document.querySelector('#ptTable tbody').innerHTML = '';
        document.querySelector('#wwTable tbody').innerHTML = '';
        document.querySelector('#peTable tbody').innerHTML = '';
        
        // Populate tables
        gradeItems.forEach(item => {
          const categoryName = gradeCategories.find(cat => cat.id === item.category_id)?.name;
          let tableId;
          
          if (categoryName === 'Performance Task') tableId = 'ptTable';
          else if (categoryName === 'Written Works') tableId = 'wwTable';
          else if (categoryName === 'Periodical Exam') tableId = 'peTable';
          else return;
          
          const tbody = document.querySelector(`#${tableId} tbody`);
          const row = document.createElement('tr');
          
          const dateAssigned = item.date_assigned ? new Date(item.date_assigned).toLocaleDateString() : 'N/A';
          
          row.innerHTML = `
            <td>${item.title}</td>
            <td>${item.topic || 'N/A'}</td>
            <td>${item.max_score}</td>
            <td>${dateAssigned}</td>
            <td class="action-buttons">
              <button class="btn-edit" onclick="editGradeItem(${item.id})">Edit</button>
              <button class="btn-delete" onclick="deleteGradeItem(${item.id})">Delete</button>
            </td>
          `;
          
          tbody.appendChild(row);
        });
        
        // Update grade item select in score form
        updateGradeItemSelect();
      })
      .catch(err => {
        console.error('Error loading grade items:', err);
        alert('Failed to load grade items. Please try again.');
      });
    }
    
    function loadStudentGrades() {
      selectedStudentId = document.getElementById('studentSelect').value;
      
      const tbody = document.querySelector('#studentGradesTable tbody');
      if (tbody) tbody.innerHTML = '<tr><td colspan="6"><div class="loading-placeholder" style="height:16px"></div><div class="loading-placeholder" style="height:16px"></div><div class="loading-placeholder" style="height:16px"></div></td></tr>';

      if (!selectedStudentId) {
        document.getElementById('studentGradesSection').classList.add('hidden');
        return;
      }
      
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/scores?student_id=${selectedStudentId}&quarter=${currentQuarter}`)
      .then(res => {
        if (!res.ok) throw new Error('Failed to load student grades');
        return res.json();
      })
      .then(data => {
        const tbody = document.querySelector('#studentGradesTable tbody');
        tbody.innerHTML = '';
        
        data.forEach(score => {
          const item = gradeItems.find(item => item.id === score.grade_item_id);
          if (!item) return;
          // filter by view mode
          const included = !!item.included_in_final;
          if (viewMode === 'final' && !included) return;
          if (viewMode === 'assessment' && included) return;
          
          const row = document.createElement('tr');
          const percentage = ((score.score / item.max_score) * 100).toFixed(1);
          
          row.innerHTML = `
            <td>${item.title}</td>
            <td>${score.score}</td>
            <td>${item.max_score}</td>
            <td>${percentage}%</td>
            <td>${score.comments || ''}</td>
            <td class="action-buttons">
              <button class="btn-edit" onclick="editStudentScore(${score.id}, ${score.grade_item_id}, ${score.score}, \`${score.comments || ''}\`)">Edit</button>
              <button class="btn-delete" onclick="deleteStudentScore(${score.id})">Delete</button>
            </td>
          `;
          
          tbody.appendChild(row);
        });
        
        document.getElementById('studentGradesSection').classList.remove('hidden');
        document.dispatchEvent(new Event('grades:loaded'));
      })
      .catch(err => {
        console.error('Error loading student grades:', err);
        alert('Failed to load student grades. Please try again.');
      });
    }
    
    // --- Form handling functions ---
    function toggleAddForm(show) {
      const form = document.getElementById('addGradeForm');
      if (show) {
        form.style.display = 'block';
        editingItemId = null;
        
        // Reset form
        document.getElementById('itemTitle').value = '';
        document.getElementById('itemTopic').value = '';
        document.getElementById('itemType').value = 'Quiz';
        document.getElementById('maxScore').value = '100';
        document.getElementById('includedInFinal').value = 'true';
        
        // Set today's date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateAssigned').value = today;
      } else {
        form.style.display = 'none';
      }
    }
    
    function toggleScoreForm(show) {
      const form = document.getElementById('addScoreForm');
      if (show) {
        form.style.display = 'block';
        editingScoreId = null;
        
        // Reset form
        document.getElementById('scoreValue').value = '';
        document.getElementById('scoreComments').value = '';
        
        // Update max score based on selected item
        updateMaxScore();
      } else {
        form.style.display = 'none';
      }
    }
    
    function updateGradeItemSelect() {
      const select = document.getElementById('gradeItemSelect');
      select.innerHTML = '';
      
      gradeItems.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.title;
        option.dataset.maxScore = item.max_score;
        select.appendChild(option);
      });
      
      updateMaxScore();
    }
    
    function updateMaxScore() {
      const select = document.getElementById('gradeItemSelect');
      const maxScoreInput = document.getElementById('scoreMaxValue');
      
      if (select.options.length > 0) {
        const selectedOption = select.options[select.selectedIndex];
        maxScoreInput.value = selectedOption.dataset.maxScore;
      }
    }
    
    // --- Save/update functions ---
    function saveWeights() {
      const ptWeight = parseFloat(document.getElementById('weightPT').value);
      const wwWeight = parseFloat(document.getElementById('weightWW').value);
      const peWeight = parseFloat(document.getElementById('weightPE').value);
      
      // Validate weights add up to 100%
      const totalWeight = ptWeight + wwWeight + peWeight;
      if (Math.abs(totalWeight - 100) > 0.01) {
        alert('Weights must add up to 100%');
        return;
      }
      
      const categories = [
        { name: 'Performance Task', weight: ptWeight, quarter: currentQuarter },
        { name: 'Written Works', weight: wwWeight, quarter: currentQuarter },
        { name: 'Periodical Exam', weight: peWeight, quarter: currentQuarter }
      ];
      
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/categories`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ categories })
      })
      .then(res => {
        if (!res.ok) throw new Error('Failed to save weights');
        return res.json();
      })
      .then(() => {
        alert('Grade weights saved successfully');
        loadGradeCategories();
      })
      .catch(err => {
        console.error('Error saving weights:', err);
        alert('Failed to save weights. Please try again.');
      });
    }
    
    function saveGradeItem() {
      const title = document.getElementById('itemTitle').value.trim();
      const topic = document.getElementById('itemTopic').value.trim();
      const itemType = document.getElementById('itemType').value;
      const maxScore = parseFloat(document.getElementById('maxScore').value);
      const dateAssigned = document.getElementById('dateAssigned').value;
      const includedInFinal = document.getElementById('includedInFinal').value === 'true';
      
      if (!title) {
        alert('Title is required');
        return;
      }
      
      if (isNaN(maxScore) || maxScore <= 0) {
        alert('Max score must be a positive number');
        return;
      }
      
      // Determine category ID based on current tab
      let categoryId;
      if (currentCategory === 'pt') {
        categoryId = gradeCategories.find(cat => cat.name === 'Performance Task')?.id;
      } else if (currentCategory === 'ww') {
        categoryId = gradeCategories.find(cat => cat.name === 'Written Works')?.id;
      } else if (currentCategory === 'pe') {
        categoryId = gradeCategories.find(cat => cat.name === 'Periodical Exam')?.id;
      }
      
      if (!categoryId) {
        alert('Please set up grade categories first');
        return;
      }
      
      const item = {
        title,
        topic,
        item_type: itemType,
        max_score: maxScore,
        date_assigned: dateAssigned,
        included_in_final: includedInFinal,
        category_id: categoryId
      };
      
      const items = [item];
      
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/items`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items })
      })
      .then(res => {
        if (!res.ok) throw new Error('Failed to save grade item');
        return res.json();
      })
      .then(() => {
        alert('Grade item saved successfully');
        toggleAddForm(false);
        loadGradeItems();
      })
      .catch(err => {
        console.error('Error saving grade item:', err);
        alert('Failed to save grade item. Please try again.');
      });
    }
    
    function saveStudentScore() {
      const gradeItemId = document.getElementById('gradeItemSelect').value;
      const score = parseFloat(document.getElementById('scoreValue').value);
      const maxScore = parseFloat(document.getElementById('scoreMaxValue').value);
      const comments = document.getElementById('scoreComments').value.trim();
      
      if (isNaN(score)) {
        alert('Score is required and must be a number');
        return;
      }
      
      if (score < 0 || score > maxScore) {
        alert(`Score must be between 0 and ${maxScore}`);
        return;
      }
      
      const scoreData = {
        grade_item_id: gradeItemId,
        student_id: selectedStudentId,
        score,
        comments
      };
      
      if (!confirm('Save this score?')) return;
      
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/scores`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(scoreData)
      })
      .then(res => {
        if (!res.ok) throw new Error('Failed to save score');
        return res.json();
      })
      .then(() => {
        alert('Score saved successfully');
        toggleScoreForm(false);
        loadStudentGrades();
      })
      .catch(err => {
        console.error('Error saving score:', err);
        alert('Failed to save score. Please try again.');
      });
    }
    
    // --- Edit/delete functions ---
    function editGradeItem(id) {
      const item = gradeItems.find(item => item.id === id);
      if (!item) return;
      
      editingItemId = id;
      
      document.getElementById('itemTitle').value = item.title;
      document.getElementById('itemTopic').value = item.topic || '';
      document.getElementById('itemType').value = item.item_type || 'Quiz';
      document.getElementById('maxScore').value = item.max_score;
      document.getElementById('includedInFinal').value = item.included_in_final ? 'true' : 'false';
      
      if (item.date_assigned) {
        document.getElementById('dateAssigned').value = item.date_assigned.split('T')[0];
      }
      
      toggleAddForm(true);
    }
    
    function deleteGradeItem(id) {
      if (!confirm('Are you sure you want to delete this grade item? This will also delete all associated scores.')) {
        return;
      }
      
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/items/${id}`, { method: 'DELETE' })
      .then(res => {
        if (!res.ok) throw new Error('Failed to delete grade item');
        return res.json();
      })
      .then(() => {
        alert('Grade item deleted successfully');
        loadGradeItems();
      })
      .catch(err => {
        console.error('Error deleting grade item:', err);
        alert('Failed to delete grade item. Please try again.');
      });
    }
    
    function editStudentScore(id, gradeItemId, scoreValue, comments) {
      editingScoreId = id;
      
      document.getElementById('gradeItemSelect').value = gradeItemId;
      document.getElementById('scoreValue').value = scoreValue;
      document.getElementById('scoreComments').value = comments;
      
      updateMaxScore();
      toggleScoreForm(true);
    }
    
    function deleteStudentScore(id) {
      if (!confirm('Are you sure you want to delete this score?')) {
        return;
      }
      
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/scores/${id}`, { method: 'DELETE' })
      .then(res => {
        if (!res.ok) throw new Error('Failed to delete score');
        return res.json();
      })
      .then(() => {
        alert('Score deleted successfully');
        loadStudentGrades();
      })
      .catch(err => {
        console.error('Error deleting score:', err);
        alert('Failed to delete score. Please try again.');
      });
    }
    
    // Initialize the page
    document.getElementById('gradeItemSelect').addEventListener('change', updateMaxScore);
    // Apply read-only mode if requested
    if (readOnlyMode) {
      document.querySelectorAll('.action-buttons').forEach(el => el.style.display = 'none');
      const addItemBtn = document.getElementById('addItemBtn'); if (addItemBtn) addItemBtn.style.display = 'none';
      const addScoreBtn = document.getElementById('addScoreBtn'); if (addScoreBtn) addScoreBtn.style.display = 'none';
      const saveWeightsBtn = document.getElementById('saveWeightsBtn'); if (saveWeightsBtn) saveWeightsBtn.style.display = 'none';
      document.getElementById('weightPT').readOnly = true;
      document.getElementById('weightWW').readOnly = true;
      document.getElementById('weightPE').readOnly = true;
    }
    init();
  </script>
  <script>
    // Lazy-load Chart.js and render based on table data
    (function(){
      const canvas = document.getElementById('performanceChart');
      if (!canvas) return;
      let loaded = false;
      async function loadLib(){
        if (loaded) return; loaded = true;
        await new Promise(res=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js'; s.onload=res; s.onerror=res; document.head.appendChild(s); });
        try { renderChartFromState(); } catch {}
      }
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{ if (e.isIntersecting) { loadLib(); io.disconnect(); } });
      }, { root: null, threshold: 0.1 });
      io.observe(canvas);

      let chart;
      window.renderChartFromState = function(){
        try{
          if (!window.Chart) return;
          const tbody = document.querySelector('#studentGradesTable tbody');
          if (!tbody) return;
          const labels = [];
          const series = [];
          document.querySelectorAll('#studentGradesTable tbody tr').forEach((tr)=>{
            const tds = tr.querySelectorAll('td');
            if (tds.length >= 4){
              labels.push(tds[0].textContent.trim());
              const pct = (tds[3].textContent||'0').replace('%','').trim();
              const v = Number(pct) || 0; series.push(v);
            }
          });
          const ctx = canvas.getContext('2d');
          const data = { labels, datasets: [{ label:'Student Score %', data: series, borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,0.2)', tension:0.25, fill:true }] };
          const options = { scales: { y: { min:0, max:100, title:{ display:true, text:'%' } } } };
          if (chart){ chart.data=data; chart.options=options; chart.update(); }
          else { chart = new Chart(ctx, { type:'line', data, options }); }
          const avgLegend = document.querySelector('.chart-legend .legend-item:nth-child(2)');
          if (avgLegend) avgLegend.style.display='none';
        }catch{}
      }

      document.addEventListener('grades:loaded', ()=>{ try{ renderChartFromState(); }catch{} });
    })();
  </script>
</body>
</html>
