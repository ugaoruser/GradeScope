<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Grade Management ‚Äî GradeTracker</title>
  <link rel="icon" href="../favicon.ico" type="image/x-icon">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&display=swap" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.5.0/remixicon.min.css">
  <link rel="stylesheet" href="styles.css">
  <script src="config.js" defer></script>
  <script src="chart.js" defer></script>
  <script src="chatbot.js" defer></script>
  <script src="app.js" defer></script>
</head>
<body class="teacher-grades-page">
  <header class="header">
    <div class="header-title" id="subjectTitle">Subject Grades</div>
    <div class="account-menu" style="display:flex; align-items:center; gap:10px;">
      <span id="teacherName"></span>
      <button class="account-btn" id="accountBtnT"><span id="accountInitial">T</span></button>
      <div class="account-dropdown" id="accountDropdown" aria-hidden="true">
        <div class="account-info">
          <div id="userFullName">User Name</div>
          <div id="userEmail"></div>
        </div>
        <button id="logoutBtnT" class="logout-btn">Log Out</button>
      </div>
    </div>
  </header>
  
  <div class="main" style="padding: 20px; max-width: 1200px; margin: 0 auto;">
    <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 0 0 24px 0;">
    <button class="back-btn" onclick="goBack()">‚Üê Back to Subjects</button>
    
    <!-- Student Selection Card -->
    <div class="control-card">
      <h3 class="control-card-title">Student Selection</h3>
      <div class="student-selector">
        <label for="studentSelect" class="selector-label">Select Student:</label>
        <select id="studentSelect" onchange="loadStudentGrades()" class="student-select">
          <option value="">Loading students...</option>
        </select>
      </div>
    </div>
    
    <!-- Quarter Selection Card -->
    <div class="control-card">
      <h3 class="control-card-title">Academic Quarter</h3>
      <div class="quarter-tabs" id="quarterTabs">
        <div class="quarter-tab active" data-quarter="1">Quarter 1</div>
        <div class="quarter-tab" data-quarter="2">Quarter 2</div>
        <div class="quarter-tab" data-quarter="3">Quarter 3</div>
        <div class="quarter-tab" data-quarter="4">Quarter 4</div>
      </div>
    </div>
    
    <!-- Content Type Selection -->
    <div class="control-card">
      <h3 class="control-card-title">Grade Categories</h3>
      <div class="tabs">
        <div class="tab active" data-tab="graded">Graded Components</div>
        <div class="tab" data-tab="assessment">Assessment</div>
      </div>
    </div>
    
    <div id="gradedContent" class="tab-content active">
      <!-- Performance Tasks Section -->
      <div class="grade-section">
        <div class="category-header">
          <h4 class="category-title">Performance Tasks (<span id="ptWeight">0</span>%)</h4>
        </div>
        <div class="table-container">
          <table class="grades-table">
            <thead>
              <tr>
                <th>Index No.</th>
                <th>Name of Performance Task</th>
                <th>Topic(s) Involved</th>
                <th>Score</th>
                <th>Highest Possible Score</th>
              </tr>
            </thead>
            <tbody id="ptTable">
              <tr><td colspan="5">No data available</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Written Works Section -->
      <div class="grade-section">
        <div class="category-header">
          <h4 class="category-title">Written Works (<span id="wwWeight">0</span>%)</h4>
        </div>
        <div class="table-container">
          <table class="grades-table">
            <thead>
              <tr>
                <th>Index No.</th>
                <th>Status</th>
                <th>Topic(s)</th>
                <th>Score</th>
                <th>Highest Possible Score</th>
              </tr>
            </thead>
            <tbody id="wwTable">
              <tr><td colspan="5">No data available</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Periodical Exam Section -->
      <div class="grade-section">
        <div class="category-header">
          <h4 class="category-title">Periodical Exam (<span id="peWeight">0</span>%)</h4>
        </div>
        <div class="table-container">
          <table class="grades-table">
            <thead>
              <tr>
                <th>Topics</th>
                <th>Score</th>
                <th>Highest Possible Score</th>
              </tr>
            </thead>
            <tbody id="peTable">
              <tr><td colspan="3">No data available</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div id="assessmentContent" class="tab-content">
      <div class="grade-section">
        <div class="category-header">
          <h4 class="category-title">Assessment Tasks</h4>
        </div>
        <div class="table-container">
          <table class="grades-table">
            <thead>
              <tr>
                <th>Index No.</th>
                <th>Topic(s) of Task</th>
                <th>Score</th>
                <th>Highest Possible Score</th>
              </tr>
            </thead>
            <tbody id="assessmentTable">
              <tr><td colspan="4">No data available</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Chatbot Toggle Button -->
    <button id="chatbotToggle" style="position: fixed; right: 24px; bottom: 24px; width: 56px; height: 56px; border-radius: 50%; background:#1976d2; color:#fff; border:none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor:pointer; font-size:24px; display: flex; align-items: center; justify-content: center;">üí¨</button>
    <!-- Chatbot Sidebar -->
    <div id="chatbotSidebar" style="position: fixed; right: -360px; top: 0; width: 360px; height: 100%; background: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease; z-index: 1000; display:flex; flex-direction:column;">
      <div style="padding: 12px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:600;">Assistant</div>
        <button id="closeChatbot" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
      </div>
      <div id="chatLog" style="flex:1; padding: 12px; overflow:auto;">
        <div style="color:#666;">I can help you draft comments and estimate student progress. Ask me something like "Create a comment for Maria in Algebra, score 82" or "Average of 78, 85, 90".</div>
      </div>
      <div style="padding: 12px; border-top:1px solid #eee; display:flex; gap:8px;">
        <input id="chatInput" placeholder="Type a message..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;">
        <button id="sendChat" style="padding:10px 14px; background:#1976d2; color:#fff; border:none; border-radius:6px; cursor:pointer;">Send</button>
      </div>
    </div>
          </div>
          
          <div class="quarter-tabs">
            <button class="tab-button active" data-quarter="1" onclick="switchQuarter(1)">Quarter 1</button>
            <button class="tab-button" data-quarter="2" onclick="switchQuarter(2)">Quarter 2</button>
            <button class="tab-button" data-quarter="3" onclick="switchQuarter(3)">Quarter 3</button>
            <button class="tab-button" data-quarter="4" onclick="switchQuarter(4)">Quarter 4</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Student Dashboard Section -->
    <div class="student-dashboard-card">
      <div class="dashboard-header">
        <h2>Student Dashboard</h2>
        <button id="exportReport" class="btn-primary">Export Report</button>
      </div>
      
      <div class="dashboard-content">
        <div class="selected-student-info">
          <div class="student-display">
            <span id="selectedStudentName">Select a student to view details</span>
          </div>
        </div>
        
        <div class="ai-feedback-section">
          <h3>AI Feedback Assistant</h3>
          <div class="feedback-form">
            <div class="form-row">
              <div class="form-group">
                <label for="feedbackScore">Score</label>
                <input type="number" id="feedbackScore" min="0" max="100" value="85">
              </div>
              <div class="form-group">
                <label for="feedbackTopic">Topic</label>
                <input type="text" id="feedbackTopic" placeholder="e.g., Algebra, Essay Writing">
              </div>
              <div class="form-group">
                <button id="generateFeedback" class="btn-primary">Generate</button>
              </div>
            </div>
            <div class="feedback-results">
              <div class="feedback-message">
                <h4>Personalized Feedback</h4>
                <p id="personalizedFeedback">Generate feedback to see results</p>
              </div>
              <div class="feedback-suggestions">
                <h4>Teaching Suggestions</h4>
                <ul id="improvementSuggestions">
                  <li>Generate feedback to see suggestions</li>
                </ul>
              </div>
              <button id="copyFeedback" class="btn-secondary">Copy to Comments</button>
            </div>
          </div>
        </div>
        
        <div class="performance-trends">
          <h3>Performance Trend per Quarter</h3>
          <div class="chart-container">
            <canvas id="performanceChart"></canvas>
          </div>
          <div class="chart-legend">
            <div class="legend-item">
              <div class="legend-color" style="background-color: rgba(54, 162, 235, 0.8);"></div>
              <div class="legend-label">Selected Student</div>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: rgba(255, 99, 132, 0.8);"></div>
              <div class="legend-label">Class Average</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Grade Category Weights Section -->
    <div class="grade-weights-card">
      <h2>Grade Category Weights</h2>
      <div class="weights-grid">
        <div class="weight-input-group">
          <label for="weightPT">Performance Task (%):</label>
          <input type="number" id="weightPT" min="0" max="100" value="50">
        </div>
        <div class="weight-input-group">
          <label for="weightWW">Written Works (%):</label>
          <input type="number" id="weightWW" min="0" max="100" value="30">
        </div>
        <div class="weight-input-group">
          <label for="weightPE">Periodical Exam (%):</label>
          <input type="number" id="weightPE" min="0" max="100" value="20">
        </div>
      </div>
      <div class="weights-footer">
        <div class="total-weight">
          <span>Total: <strong id="totalWeight">100%</strong></span>
        </div>
        <button class="btn-primary save-weights" onclick="saveWeights()" id="saveWeightsBtn">Save Weights</button>
      </div>
    </div>
    
    <!-- Grade Tables Section -->
    <div class="grade-tables-section">
      <h2>Grade Items</h2>
      
      <!-- Add New Grade Item Form -->
      <div class="add-grade-form-card" id="addGradeForm" style="display: none;">
        <h3>Add New Grade Item</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="itemTitle">Title</label>
            <input type="text" id="itemTitle" placeholder="e.g. Quiz 1">
          </div>
          <div class="form-group">
            <label for="itemTopic">Topic</label>
            <input type="text" id="itemTopic" placeholder="e.g. Algebra">
          </div>
          <div class="form-group">
            <label for="itemType">Type</label>
            <select id="itemType">
              <option value="Quiz">Quiz</option>
              <option value="Project">Project</option>
              <option value="Homework">Homework</option>
              <option value="Exam">Exam</option>
              <option value="Assessment">Assessment</option>
            </select>
          </div>
          <div class="form-group">
            <label for="maxScore">Max Score</label>
            <input type="number" id="maxScore" value="100">
          </div>
          <div class="form-group">
            <label for="dateAssigned">Date Assigned</label>
            <input type="date" id="dateAssigned">
          </div>
          <div class="form-group">
            <label for="includedInFinal">Include in Final Grade</label>
            <select id="includedInFinal">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn-cancel" onclick="toggleAddForm(false)">Cancel</button>
          <button class="btn-primary" onclick="saveGradeItem()">Save Grade Item</button>
        </div>
      </div>
      
      <div class="add-item-controls">
        <button class="btn-primary" onclick="toggleAddForm(true)" id="addItemBtn">+ Add New Grade Item</button>
      </div>
      

    </div>
    
    <div id="studentGradesSection" class="hidden">
      <h3>Student Grades</h3>
      <table class="grade-table" id="studentGradesTable">
        <thead>
          <tr>
            <th>Grade Item</th>
            <th>Score</th>
            <th>Max Score</th>
            <th>Percentage</th>
            <th>Comments</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Will be populated by JavaScript -->
        </tbody>
      </table>
      
      <div class="add-grade-form" id="addScoreForm" style="display: none;">
        <h3>Add/Edit Student Score</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="gradeItemSelect">Grade Item</label>
            <select id="gradeItemSelect">
              <!-- Will be populated by JavaScript -->
            </select>
          </div>
          <div class="form-group">
            <label for="scoreValue">Score</label>
            <input type="number" id="scoreValue">
          </div>
          <div class="form-group">
            <label for="scoreMaxValue">Max Score</label>
            <input type="number" id="scoreMaxValue" disabled>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="scoreComments">Comments</label>
            <textarea id="scoreComments" rows="3"></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn-cancel" onclick="toggleScoreForm(false)">Cancel</button>
          <button class="btn-submit" onclick="saveStudentScore()">Save Score</button>
        </div>
      </div>
      
      <button class="action-btn" onclick="toggleScoreForm(true)" id="addScoreBtn">Add New Score</button>
    </div>
  </div>
  
  <script>
    // --- Routing: Only allow logged-in teachers ---
    const role = localStorage.getItem('role');
    const token = localStorage.getItem('token');
    const userName = localStorage.getItem('userName');
    const urlParamsAll = new URLSearchParams(window.location.search);
    const readOnlyMode = urlParamsAll.get('readonly') === '1';
    
    if (!role || role !== 'teacher') {
      window.location.href = 'login.html';
    }
    
    // Populate account dropdown with latest cached values
    (function(){
      try{
        const full = localStorage.getItem('fullName') || localStorage.getItem('userName') || 'Teacher';
        const email = localStorage.getItem('email') || '';
        const init = (full.charAt(0)||'T').toUpperCase();
        const iEl = document.getElementById('accountInitial'); if (iEl) iEl.textContent = init;
        const nEl = document.getElementById('userFullName'); if (nEl) nEl.textContent = full;
        const eEl = document.getElementById('userEmail'); if (eEl) eEl.textContent = email;
      }catch{}
    })();
    
    // --- Get subject from URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const subjectId = urlParams.get('id');
    const subjectName = urlParams.get('name') || "Subject";
document.getElementById('subjectTitle').textContent = subjectName;
    // Fetch subject details to show section/grade level
    (function fetchSubjectMeta(){
      fetch(`${window.API_BASE}/api/subjects?title=${encodeURIComponent(subjectName)}`)
        .then(r=>r.json())
        .then(list=>{
          const subj = Array.isArray(list) ? list.find(s=> (s.title||'')===subjectName) : null;
          if (subj){
            const sec = subj.section || subj.grade_level || '';
            if (sec){ const el=document.getElementById('sectionCode'); if (el) el.textContent = `Section: ${sec}`; }
          }
        }).catch(()=>{});
    })();
    
    // Global variables
    let currentQuarter = 1;
    let currentCategory = 'pt';
    let gradeCategories = [];
    let gradeItems = [];
    let students = [];
    let selectedStudentId = '';
    let editingItemId = null;
    let editingScoreId = null;
    const initialStudentId = urlParams.get('student_id') || '';
    const viewMode = urlParams.get('view') === 'assessment' ? 'assessment' : 'final';
    
    // --- Initialize page ---
    function init() {
      loadStudents();
      loadGradeCategories();
      loadGradeItems();
      
      // Set today's date as default for new items
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateAssigned').value = today;
    }
    
    // --- Navigation functions ---
    function goBack() {
      const role = localStorage.getItem('role');
      window.location.href = role === 'teacher' ? 'homepage2.html' : 'homepage1.html';
    }
    
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      localStorage.removeItem('userId');
      localStorage.removeItem('userName');
      window.location.href = 'login.html';
    }
    
    // --- Tab switching functions ---
    function switchQuarter(quarter) {
      currentQuarter = quarter;
      
      // Update active tab
      document.querySelectorAll('.quarter-tabs .tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.quarter-tabs .tab-button[data-quarter="${quarter}"]`).classList.add('active');
      
      // Reload data for the new quarter
      loadGradeCategories();
      loadGradeItems();
      
      if (selectedStudentId) {
        loadStudentGrades();
      }
    }
    
    // Helper functions for the new layout
    function showErrorMessage(message) {
      // Create or update error banner
      let errorBanner = document.getElementById('errorBanner');
      if (!errorBanner) {
        errorBanner = document.createElement('div');
        errorBanner.id = 'errorBanner';
        errorBanner.className = 'error-banner';
        errorBanner.style.cssText = 'background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px; border-radius: 8px; margin: 16px 0; display: flex; align-items: center; justify-content: space-between;';
        document.querySelector('.container').insertBefore(errorBanner, document.querySelector('.student-dashboard-card'));
      }
      
      errorBanner.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.style.display='none'" style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 18px;">&times;</button>
      `;
      errorBanner.style.display = 'flex';
    }
    
    function updateSelectedStudentDisplay() {
      const selectedStudentName = document.getElementById('selectedStudentName');
      const select = document.getElementById('studentSelect');
      if (selectedStudentName && select) {
        const selectedOption = select.options[select.selectedIndex];
        if (select.value && selectedOption) {
          selectedStudentName.textContent = selectedOption.textContent;
        } else {
          selectedStudentName.textContent = 'Select a student to view details';
        }
      }
    }
    
    function showAddFormForCategory(category) {
      currentCategory = category;
      toggleAddForm(true);
    }
    
    function updateTotalWeight() {
      const ptWeight = parseFloat(document.getElementById('weightPT').value) || 0;
      const wwWeight = parseFloat(document.getElementById('weightWW').value) || 0;
      const peWeight = parseFloat(document.getElementById('weightPE').value) || 0;
      const total = ptWeight + wwWeight + peWeight;
      
      const totalElement = document.getElementById('totalWeight');
      if (totalElement) {
        totalElement.textContent = `${total}%`;
        totalElement.style.color = total === 100 ? '#059669' : '#dc2626';
      }
    }
    
    // --- Data loading functions ---
    function loadStudents() {
      const select = document.getElementById('studentSelect');
      // Clear all options first
      select.innerHTML = '<option value="">Loading students...</option>';
      
      // Use fallback URLs if primary fails
      const urls = [
        `${window.API_BASE}/api/subjects/${subjectId}/students`,
        `${window.API_BASE}/api/classes/${subjectId}/students`,
        `${window.API_BASE}/api/enrollments?subject_id=${subjectId}`
      ];
      
      async function tryLoadStudents() {
        let lastError;
        
        for (const url of urls) {
          try {
            const res = await fetch(url);
            if (res.ok) {
              const data = await res.json();
              students = Array.isArray(data) ? data : data.students || [];
              
              // Clear and populate select
              select.innerHTML = '<option value="">All Students</option>';
              
              if (students.length === 0) {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = 'No students enrolled';
                select.appendChild(option);
              } else {
                students.forEach(student => {
                  const option = document.createElement('option');
                  option.value = student.id;
                  option.textContent = student.full_name || student.name || 'Unknown Student';
                  select.appendChild(option);
                });
                
                // Preselect from URL if provided
                if (initialStudentId) {
                  select.value = initialStudentId;
                  loadStudentGrades();
                }
              }
              
              updateSelectedStudentDisplay();
              return; // Success, exit
            }
          } catch (err) {
            lastError = err;
            console.warn(`Failed to load from ${url}:`, err);
          }
        }
        
        // All URLs failed
        throw lastError || new Error('All student loading endpoints failed');
      }
      
      tryLoadStudents().catch(err => {
        console.error('Error loading students:', err);
        select.innerHTML = '<option value="">Failed to load students</option>';
        showErrorMessage('Unable to load students. Please refresh the page or contact support.');
      });
    }
    
    function loadGradeCategories() {
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/categories?quarter=${currentQuarter}`)
      .then(res => {
        if (!res.ok) throw new Error('Failed to load grade categories');
        return res.json();
      })
      .then(data => {
        gradeCategories = data;
        
        // Update weight inputs
        const ptCategory = gradeCategories.find(cat => cat.name === 'Performance Task');
        const wwCategory = gradeCategories.find(cat => cat.name === 'Written Works');
        const peCategory = gradeCategories.find(cat => cat.name === 'Periodical Exam');
        
        if (ptCategory) document.getElementById('weightPT').value = ptCategory.weight;
        if (wwCategory) document.getElementById('weightWW').value = wwCategory.weight;
        if (peCategory) document.getElementById('weightPE').value = peCategory.weight;
      })
      .catch(err => {
        console.error('Error loading grade categories:', err);
      });
    }
    
    function loadGradeItems() {
      // Show loading state in all tables
      const tables = ['ptTable', 'wwTable', 'peTable'];
      tables.forEach(tableId => {
        const tbody = document.querySelector(`#${tableId} tbody`);
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="6" class="loading-text">Loading grade items...</td></tr>';
        }
      });
      
      // Try multiple endpoints
      const urls = [
        `${window.API_BASE}/api/subjects/${subjectId}/items?quarter=${currentQuarter}`,
        `${window.API_BASE}/api/classes/${subjectId}/items?quarter=${currentQuarter}`,
        `${window.API_BASE}/api/grade-items?subject_id=${subjectId}&quarter=${currentQuarter}`
      ];
      
      async function tryLoadGradeItems() {
        let lastError;
        
        for (const url of urls) {
          try {
            const res = await fetch(url);
            if (res.ok) {
              const data = await res.json();
              gradeItems = Array.isArray(data) ? data : data.items || [];
              
              // Clear all tables first
              tables.forEach(tableId => {
                const tbody = document.querySelector(`#${tableId} tbody`);
                if (tbody) tbody.innerHTML = '';
              });
              
              if (gradeItems.length === 0) {
                tables.forEach(tableId => {
                  const tbody = document.querySelector(`#${tableId} tbody`);
                  if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No grade items found for this quarter</td></tr>';
                  }
                });
              } else {
                // Populate tables by category
                gradeItems.forEach(item => {
                  const categoryName = gradeCategories.find(cat => cat.id === item.category_id)?.name;
                  let tableId;
                  
                  if (categoryName === 'Performance Task') tableId = 'ptTable';
                  else if (categoryName === 'Written Works') tableId = 'wwTable';
                  else if (categoryName === 'Periodical Exam') tableId = 'peTable';
                  else return;
                  
                  const tbody = document.querySelector(`#${tableId} tbody`);
                  if (!tbody) return;
                  
                  // Clear empty state if this is the first item for this table
                  if (tbody.querySelector('.empty-state')) {
                    tbody.innerHTML = '';
                  }
                  
                  const row = document.createElement('tr');
                  const dateAssigned = item.date_assigned ? new Date(item.date_assigned).toLocaleDateString() : 'N/A';
                  
                  row.innerHTML = `
                    <td>${item.title || 'Untitled'}</td>
                    <td>${item.topic || 'N/A'}</td>
                    <td>${item.max_score || 0}</td>
                    <td>${dateAssigned}</td>
                    <td>${categoryName || 'N/A'}</td>
                    <td class="action-buttons">
                      <button class="btn-edit" onclick="editGradeItem(${item.id})">Edit</button>
                      <button class="btn-delete" onclick="deleteGradeItem(${item.id})">Delete</button>
                    </td>
                  `;
                  
                  tbody.appendChild(row);
                });
                
                // Set empty state for tables that have no items
                tables.forEach(tableId => {
                  const tbody = document.querySelector(`#${tableId} tbody`);
                  if (tbody && tbody.children.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No items in this category</td></tr>';
                  }
                });
              }
              
              // Update grade item select for student scoring
              updateGradeItemSelect();
              return; // Success, exit
            }
          } catch (err) {
            lastError = err;
            console.warn(`Failed to load from ${url}:`, err);
          }
        }
        
        throw lastError || new Error('All grade items endpoints failed');
      }
      
      tryLoadGradeItems().catch(err => {
        console.error('Error loading grade items:', err);
        tables.forEach(tableId => {
          const tbody = document.querySelector(`#${tableId} tbody`);
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="6" class="error-state">Failed to load grade items. Please refresh the page.</td></tr>';
          }
        });
        showErrorMessage('Unable to load grade items. Please refresh the page or contact support.');
      });
    }
    
    function loadStudentGrades() {
      selectedStudentId = document.getElementById('studentSelect').value;
      updateSelectedStudentDisplay();
      
      const tbody = document.querySelector('#studentGradesTable tbody');
      if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="loading-text">Loading student grades...</td></tr>';

      if (!selectedStudentId) {
        document.getElementById('studentGradesSection').classList.add('hidden');
        updateSelectedStudentDisplay();
        return;
      }
      
      // Try multiple endpoints
      const urls = [
        `${window.API_BASE}/api/subjects/${subjectId}/scores?student_id=${selectedStudentId}&quarter=${currentQuarter}`,
        `${window.API_BASE}/api/student-grades?subject_id=${subjectId}&student_id=${selectedStudentId}&quarter=${currentQuarter}`,
        `${window.API_BASE}/api/grades?subject=${subjectId}&student=${selectedStudentId}&quarter=${currentQuarter}`
      ];
      
      async function tryLoadStudentGrades() {
        let lastError;
        
        for (const url of urls) {
          try {
            const res = await fetch(url);
            if (res.ok) {
              const data = await res.json();
              const scores = Array.isArray(data) ? data : data.scores || [];
              
              const tbody = document.querySelector('#studentGradesTable tbody');
              if (!tbody) return;
              
              tbody.innerHTML = '';
              
              if (scores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No grades recorded for this student</td></tr>';
              } else {
                scores.forEach(score => {
                  const item = gradeItems.find(item => item.id === score.grade_item_id);
                  if (!item) return;
                  
                  // Filter by view mode if specified
                  const included = !!item.included_in_final;
                  if (viewMode === 'final' && !included) return;
                  if (viewMode === 'assessment' && included) return;
                  
                  const row = document.createElement('tr');
                  const percentage = item.max_score > 0 ? ((score.score / item.max_score) * 100).toFixed(1) : '0.0';
                  
                  row.innerHTML = `
                    <td>${item.title || 'Untitled'}</td>
                    <td>${score.score || 0}</td>
                    <td>${item.max_score || 0}</td>
                    <td>${percentage}%</td>
                    <td>${score.comments || ''}</td>
                    <td class="action-buttons">
                      <button class="btn-edit" onclick="editStudentScore(${score.id}, ${score.grade_item_id}, ${score.score}, \`${(score.comments || '').replace(/`/g, '\\`')}\`)">Edit</button>
                      <button class="btn-delete" onclick="deleteStudentScore(${score.id})">Delete</button>
                    </td>
                  `;
                  
                  tbody.appendChild(row);
                });
              }
              
              document.getElementById('studentGradesSection').classList.remove('hidden');
              document.dispatchEvent(new Event('grades:loaded'));
              return; // Success
            }
          } catch (err) {
            lastError = err;
            console.warn(`Failed to load from ${url}:`, err);
          }
        }
        
        throw lastError || new Error('All student grades endpoints failed');
      }
      
      tryLoadStudentGrades().catch(err => {
        console.error('Error loading student grades:', err);
        const tbody = document.querySelector('#studentGradesTable tbody');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="6" class="error-state">Failed to load student grades. Please try again.</td></tr>';
        }
        showErrorMessage('Unable to load student grades. Please refresh the page or contact support.');
      });
    }
    
    // --- Form handling functions ---
    function toggleAddForm(show) {
      const form = document.getElementById('addGradeForm');
      if (show) {
        form.style.display = 'block';
        editingItemId = null;
        
        // Reset form
        document.getElementById('itemTitle').value = '';
        document.getElementById('itemTopic').value = '';
        document.getElementById('itemType').value = 'Quiz';
        document.getElementById('maxScore').value = '100';
        document.getElementById('includedInFinal').value = 'true';
        
        // Set today's date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateAssigned').value = today;
      } else {
        form.style.display = 'none';
      }
    }
    
    function toggleScoreForm(show) {
      const form = document.getElementById('addScoreForm');
      if (show) {
        form.style.display = 'block';
        editingScoreId = null;
        
        // Reset form
        document.getElementById('scoreValue').value = '';
        document.getElementById('scoreComments').value = '';
        
        // Update max score based on selected item
        updateMaxScore();
      } else {
        form.style.display = 'none';
      }
    }
    
    function updateGradeItemSelect() {
      const select = document.getElementById('gradeItemSelect');
      select.innerHTML = '';
      
      gradeItems.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.title;
        option.dataset.maxScore = item.max_score;
        select.appendChild(option);
      });
      
      updateMaxScore();
    }
    
    function updateMaxScore() {
      const select = document.getElementById('gradeItemSelect');
      const maxScoreInput = document.getElementById('scoreMaxValue');
      
      if (select.options.length > 0) {
        const selectedOption = select.options[select.selectedIndex];
        maxScoreInput.value = selectedOption.dataset.maxScore;
      }
    }
    
    // --- Save/update functions ---
    function saveWeights() {
      const ptWeight = parseFloat(document.getElementById('weightPT').value);
      const wwWeight = parseFloat(document.getElementById('weightWW').value);
      const peWeight = parseFloat(document.getElementById('weightPE').value);
      
      // Validate weights add up to 100%
      const totalWeight = ptWeight + wwWeight + peWeight;
      if (Math.abs(totalWeight - 100) > 0.01) {
        alert('Weights must add up to 100%');
        return;
      }
      
      const categories = [
        { name: 'Performance Task', weight: ptWeight, quarter: currentQuarter },
        { name: 'Written Works', weight: wwWeight, quarter: currentQuarter },
        { name: 'Periodical Exam', weight: peWeight, quarter: currentQuarter }
      ];
      
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/categories`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ categories })
      })
      .then(res => {
        if (!res.ok) throw new Error('Failed to save weights');
        return res.json();
      })
      .then(() => {
        alert('Grade weights saved successfully');
        loadGradeCategories();
      })
      .catch(err => {
        console.error('Error saving weights:', err);
        alert('Failed to save weights. Please try again.');
      });
    }
    
    function saveGradeItem() {
      const title = document.getElementById('itemTitle').value.trim();
      const topic = document.getElementById('itemTopic').value.trim();
      const itemType = document.getElementById('itemType').value;
      const maxScore = parseFloat(document.getElementById('maxScore').value);
      const dateAssigned = document.getElementById('dateAssigned').value;
      const includedInFinal = document.getElementById('includedInFinal').value === 'true';
      
      if (!title) {
        alert('Title is required');
        return;
      }
      
      if (isNaN(maxScore) || maxScore <= 0) {
        alert('Max score must be a positive number');
        return;
      }
      
      // Determine category ID based on current tab
      let categoryId;
      if (currentCategory === 'pt') {
        categoryId = gradeCategories.find(cat => cat.name === 'Performance Task')?.id;
      } else if (currentCategory === 'ww') {
        categoryId = gradeCategories.find(cat => cat.name === 'Written Works')?.id;
      } else if (currentCategory === 'pe') {
        categoryId = gradeCategories.find(cat => cat.name === 'Periodical Exam')?.id;
      }
      
      if (!categoryId) {
        alert('Please set up grade categories first');
        return;
      }
      
      const item = {
        title,
        topic,
        item_type: itemType,
        max_score: maxScore,
        date_assigned: dateAssigned,
        included_in_final: includedInFinal,
        category_id: categoryId
      };
      
      const items = [item];
      
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/items`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items })
      })
      .then(res => {
        if (!res.ok) throw new Error('Failed to save grade item');
        return res.json();
      })
      .then(() => {
        alert('Grade item saved successfully');
        toggleAddForm(false);
        loadGradeItems();
      })
      .catch(err => {
        console.error('Error saving grade item:', err);
        alert('Failed to save grade item. Please try again.');
      });
    }
    
    function saveStudentScore() {
      const gradeItemId = document.getElementById('gradeItemSelect').value;
      const score = parseFloat(document.getElementById('scoreValue').value);
      const maxScore = parseFloat(document.getElementById('scoreMaxValue').value);
      const comments = document.getElementById('scoreComments').value.trim();
      
      if (isNaN(score)) {
        alert('Score is required and must be a number');
        return;
      }
      
      if (score < 0 || score > maxScore) {
        alert(`Score must be between 0 and ${maxScore}`);
        return;
      }
      
      const scoreData = {
        grade_item_id: gradeItemId,
        student_id: selectedStudentId,
        score,
        comments
      };
      
      if (!confirm('Save this score?')) return;
      
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/scores`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(scoreData)
      })
      .then(res => {
        if (!res.ok) throw new Error('Failed to save score');
        return res.json();
      })
      .then(() => {
        alert('Score saved successfully');
        toggleScoreForm(false);
        loadStudentGrades();
      })
      .catch(err => {
        console.error('Error saving score:', err);
        alert('Failed to save score. Please try again.');
      });
    }
    
    // --- Edit/delete functions ---
    function editGradeItem(id) {
      const item = gradeItems.find(item => item.id === id);
      if (!item) return;
      
      editingItemId = id;
      
      document.getElementById('itemTitle').value = item.title;
      document.getElementById('itemTopic').value = item.topic || '';
      document.getElementById('itemType').value = item.item_type || 'Quiz';
      document.getElementById('maxScore').value = item.max_score;
      document.getElementById('includedInFinal').value = item.included_in_final ? 'true' : 'false';
      
      if (item.date_assigned) {
        document.getElementById('dateAssigned').value = item.date_assigned.split('T')[0];
      }
      
      toggleAddForm(true);
    }
    
    function deleteGradeItem(id) {
      if (!confirm('Are you sure you want to delete this grade item? This will also delete all associated scores.')) {
        return;
      }
      
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/items/${id}`, { method: 'DELETE' })
      .then(res => {
        if (!res.ok) throw new Error('Failed to delete grade item');
        return res.json();
      })
      .then(() => {
        alert('Grade item deleted successfully');
        loadGradeItems();
      })
      .catch(err => {
        console.error('Error deleting grade item:', err);
        alert('Failed to delete grade item. Please try again.');
      });
    }
    
    function editStudentScore(id, gradeItemId, scoreValue, comments) {
      editingScoreId = id;
      
      document.getElementById('gradeItemSelect').value = gradeItemId;
      document.getElementById('scoreValue').value = scoreValue;
      document.getElementById('scoreComments').value = comments;
      
      updateMaxScore();
      toggleScoreForm(true);
    }
    
    function deleteStudentScore(id) {
      if (!confirm('Are you sure you want to delete this score?')) {
        return;
      }
      
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/scores/${id}`, { method: 'DELETE' })
      .then(res => {
        if (!res.ok) throw new Error('Failed to delete score');
        return res.json();
      })
      .then(() => {
        alert('Score deleted successfully');
        loadStudentGrades();
      })
      .catch(err => {
        console.error('Error deleting score:', err);
        alert('Failed to delete score. Please try again.');
      });
    }
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Add event listeners for weight inputs
      const weightInputs = ['weightPT', 'weightWW', 'weightPE'];
      weightInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          input.addEventListener('input', updateTotalWeight);
          input.addEventListener('change', updateTotalWeight);
        }
      });
      
      // Add event listener for student selection
      const studentSelect = document.getElementById('studentSelect');
      if (studentSelect) {
        studentSelect.addEventListener('change', function() {
          loadStudentGrades();
          updateSelectedStudentDisplay();
        });
      }
      
      // Add event listener for grade item select
      const gradeItemSelect = document.getElementById('gradeItemSelect');
      if (gradeItemSelect) {
        gradeItemSelect.addEventListener('change', updateMaxScore);
      }
      
      // Apply read-only mode if requested
      if (readOnlyMode) {
        document.querySelectorAll('.action-buttons').forEach(el => el.style.display = 'none');
        const addItemBtn = document.getElementById('addItemBtn'); if (addItemBtn) addItemBtn.style.display = 'none';
        const addScoreBtn = document.getElementById('addScoreBtn'); if (addScoreBtn) addScoreBtn.style.display = 'none';
        const saveWeightsBtn = document.getElementById('saveWeightsBtn'); if (saveWeightsBtn) saveWeightsBtn.style.display = 'none';
        weightInputs.forEach(id => {
          const input = document.getElementById(id);
          if (input) input.readOnly = true;
        });
      }
      
      // Initialize page data
      init();
      
      // Update total weight on page load
      updateTotalWeight();
    });
  </script>
  <script>
    // Lazy-load Chart.js and render based on table data
    (function(){
      const canvas = document.getElementById('performanceChart');
      if (!canvas) return;
      let loaded = false;
      async function loadLib(){
        if (loaded) return; loaded = true;
        await new Promise(res=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js'; s.onload=res; s.onerror=res; document.head.appendChild(s); });
        try { renderChartFromState(); } catch {}
      }
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{ if (e.isIntersecting) { loadLib(); io.disconnect(); } });
      }, { root: null, threshold: 0.1 });
      io.observe(canvas);

      let chart;
      window.renderChartFromState = function(){
        try{
          if (!window.Chart) return;
          const tbody = document.querySelector('#studentGradesTable tbody');
          if (!tbody) return;
          const labels = [];
          const series = [];
          document.querySelectorAll('#studentGradesTable tbody tr').forEach((tr)=>{
            const tds = tr.querySelectorAll('td');
            if (tds.length >= 4){
              labels.push(tds[0].textContent.trim());
              const pct = (tds[3].textContent||'0').replace('%','').trim();
              const v = Number(pct) || 0; series.push(v);
            }
          });
          const ctx = canvas.getContext('2d');
          const data = { labels, datasets: [{ label:'Student Score %', data: series, borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,0.2)', tension:0.25, fill:true }] };
          const options = { scales: { y: { min:0, max:100, title:{ display:true, text:'%' } } } };
          if (chart){ chart.data=data; chart.options=options; chart.update(); }
          else { chart = new Chart(ctx, { type:'line', data, options }); }
          const avgLegend = document.querySelector('.chart-legend .legend-item:nth-child(2)');
          if (avgLegend) avgLegend.style.display='none';
        }catch{}
      }

      document.addEventListener('grades:loaded', ()=>{ try{ renderChartFromState(); }catch{} });
    })();
  </script>
  
  <style>
    /* Enhanced styling for teacher grades page */
    .control-card {
      background: var(--card);
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }
    
    .control-card:hover {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }
    
    .control-card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
    }
    
    .control-card-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: var(--primary);
      border-radius: 2px;
      margin-right: 12px;
    }
    
    .student-selector {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .selector-label {
      font-weight: 500;
      color: var(--text);
      min-width: 120px;
    }
    
    .student-select {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }
    
    .student-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .quarter-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .quarter-tab {
      padding: 10px 18px;
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .quarter-tab:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }
    
    .quarter-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 12px 20px;
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .tab:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }
    
    .tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .grade-section {
      margin-bottom: 32px;
    }
    
    .category-header {
      margin-bottom: 16px;
    }
    
    .category-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text);
      margin: 0;
      padding: 16px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px 8px 0 0;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .table-container {
      border: 1px solid #e2e8f0;
      border-radius: 0 0 8px 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .grades-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
    }
    
    .grades-table th {
      background: #f8fafc;
      padding: 14px 16px;
      text-align: left;
      font-weight: 600;
      color: var(--text);
      border-bottom: 2px solid #e2e8f0;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .grades-table td {
      padding: 14px 16px;
      border-bottom: 1px solid #f1f5f9;
      color: var(--text);
      vertical-align: middle;
    }
    
    .grades-table tbody tr:hover {
      background: #f8fafc;
    }
    
    .grades-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .control-card {
        padding: 16px;
      }
      
      .student-selector {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .selector-label {
        min-width: auto;
      }
      
      .quarter-tabs, .tabs {
        justify-content: center;
      }
      
      .quarter-tab, .tab {
        flex: 1;
        text-align: center;
        min-width: 80px;
      }
      
      .grades-table {
        font-size: 0.85rem;
      }
      
      .grades-table th, .grades-table td {
        padding: 10px 8px;
      }
    }
  </style>
</body>
</html>
