<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Grade Management ‚Äî GradeTracker</title>
  <link rel="icon" href="../favicon.ico" type="image/x-icon" sizes="any">
  <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&display=swap" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.5.0/remixicon.min.css">
  <link rel="stylesheet" href="styles.css">
  <script src="config.js" defer></script>
  <script src="chatbot.js" defer></script>
  <script src="app.js" defer></script>
</head>
<body class="teacher-grades-page">
  <header class="header">
    <div class="header-title" id="subjectTitle">Subject Grades</div>
    <div class="account-menu" style="display:flex; align-items:center; gap:10px;">
      <span id="teacherName"></span>
      <button class="account-btn" id="accountBtnT"><span id="accountInitial">T</span></button>
      <div class="account-dropdown" id="accountDropdown" aria-hidden="true">
        <div class="account-info">
          <div id="userFullName">User Name</div>
          <div id="userEmail"></div>
        </div>
        <button id="logoutBtnT" class="logout-btn">Log Out</button>
      </div>
    </div>
  </header>
  
  <div class="main" style="padding: 20px; max-width: 1200px; margin: 0 auto;">
    <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 0 0 24px 0;">
    <button class="back-btn" onclick="goBack()">‚Üê Back to Subjects</button>
    
    <!-- Quarter Selection Card -->
    <div class="control-card">
      <h3 class="control-card-title">Academic Quarter</h3>
      <div class="quarter-tabs" id="quarterTabs">
        <button class="tab-button active" data-quarter="1" onclick="switchQuarter(1)">Quarter 1</button>
        <button class="tab-button" data-quarter="2" onclick="switchQuarter(2)">Quarter 2</button>
        <button class="tab-button" data-quarter="3" onclick="switchQuarter(3)">Quarter 3</button>
        <button class="tab-button" data-quarter="4" onclick="switchQuarter(4)">Quarter 4</button>
      </div>
    </div>
    
    <!-- Content Type Selection -->
    <div class="control-card">
      <h3 class="control-card-title">Grade Categories</h3>
      <div class="tabs">
        <div class="tab active" data-tab="graded">Graded Components</div>
        <div class="tab" data-tab="assessment">Formative Assessments</div>
      </div>
    </div>
    
    <div id="gradedContent" class="tab-content active">
      <!-- Performance Tasks Section -->
      <div class="grade-section">
        <div class="category-header">
          <h4 class="category-title">Performance Tasks (<span id="ptWeight">0</span>%)</h4>
        </div>
        <div class="table-container">
          <table class="grades-table" id="ptTable">
            <thead>
              <tr>
                <th>Title</th>
                <th>Topic(s)</th>
                <th>Score</th>
                <th>Max Score</th>
                <th>Date Assigned</th>
                <th>Category</th>
                <th>Comment</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="8">No items in this category</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Written Works Section -->
      <div class="grade-section">
        <div class="category-header">
          <h4 class="category-title">Written Works (<span id="wwWeight">0</span>%)</h4>
        </div>
        <div class="table-container">
          <table class="grades-table" id="wwTable">
            <thead>
              <tr>
                <th>Title</th>
                <th>Topic(s)</th>
                <th>Score</th>
                <th>Max Score</th>
                <th>Date Assigned</th>
                <th>Category</th>
                <th>Comment</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="8">No items in this category</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Periodical Exam Section -->
      <div class="grade-section">
        <div class="category-header">
          <h4 class="category-title">Periodical Exam (<span id="peWeight">0</span>%)</h4>
        </div>
        <div class="table-container">
          <table class="grades-table" id="peTable">
            <thead>
              <tr>
                <th>Title</th>
                <th>Topic(s)</th>
                <th>Score</th>
                <th>Max Score</th>
                <th>Date Assigned</th>
                <th>Category</th>
                <th>Comment</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="8">No items in this category</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div id="assessmentContent" class="tab-content">
      <div class="grade-section">
        <div class="category-header">
          <h4 class="category-title">Formative Assessments</h4>
        </div>
        <div class="table-container">
          <table class="grades-table">
            <thead>
              <tr>
                <th>Name of Activity</th>
                <th>Topic(s) of Task</th>
                <th>Score</th>
                <th>Highest Possible Score</th>
                <th>Comments</th>
              </tr>
            </thead>
            <tbody id="assessmentTable">
              <tr><td colspan="5">No data available</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Chatbot Toggle Button -->
    <button id="chatbotToggle" style="position: fixed; right: 24px; bottom: 24px; width: 56px; height: 56px; border-radius: 50%; background:#1976d2; color:#fff; border:none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor:pointer; font-size:24px; display: flex; align-items: center; justify-content: center;">üí¨</button>
    <!-- Chatbot Sidebar -->
    <div id="chatbotSidebar" style="position: fixed; right: -360px; top: 0; width: 360px; height: 100%; background: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease; z-index: 1000; display:flex; flex-direction:column;">
      <div style="padding: 12px 16px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:600;">Assistant</div>
        <button id="closeChatbot" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
      </div>
      <div id="chatLog" style="flex:1; padding: 12px; overflow:auto;">
        <div style="color:#666;">I can help you draft comments and estimate student progress. Ask me something like "Create a comment for Maria in Algebra, score 82" or "Average of 78, 85, 90".</div>
      </div>
      <div style="padding: 12px; border-top:1px solid #eee; display:flex; gap:8px;">
        <input id="chatInput" placeholder="Type a message..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px;">
        <button id="sendChat" style="padding:10px 14px; background:#1976d2; color:#fff; border:none; border-radius:6px; cursor:pointer;">Send</button>
      </div>
    </div>
    
    <!-- Grade Category Weights Section -->
    <div class="grade-weights-card">
      <h2>Grade Category Weights</h2>
      <div class="weights-grid">
        <div class="weight-input-group">
          <label for="weightPT">Performance Task (%):</label>
          <input type="number" id="weightPT" min="0" max="100" value="50">
        </div>
        <div class="weight-input-group">
          <label for="weightWW">Written Works (%):</label>
          <input type="number" id="weightWW" min="0" max="100" value="30">
        </div>
        <div class="weight-input-group">
          <label for="weightPE">Periodical Exam (%):</label>
          <input type="number" id="weightPE" min="0" max="100" value="20">
        </div>
      </div>
      <div class="weights-footer">
        <div class="total-weight">
          <span>Total: <strong id="totalWeight">100%</strong></span>
        </div>
        <button class="btn-primary save-weights" onclick="saveWeights()" id="saveWeightsBtn">Save Weights</button>
      </div>
    </div>
    
    <!-- Grade Tables Section -->
    <div class="grade-tables-section">
      <h2>Grade Items</h2>
      
      <!-- Add New Grade Item Form -->
      <div class="add-grade-form-card" id="addGradeForm" style="display: none;">
        <h3>Add New Grade Item</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="itemTitle">Title</label>
            <input type="text" id="itemTitle" placeholder="e.g. Quiz 1">
          </div>
          <div class="form-group">
            <label for="itemTopic">Topic</label>
            <input type="text" id="itemTopic" placeholder="e.g. Algebra">
          </div>
          <div class="form-group">
            <label for="itemType">Type</label>
            <select id="itemType">
              <option value="Performance Task">Performance Task</option>
              <option value="Written Works">Written Works</option>
              <option value="Periodical Exam">Periodical Exam</option>
            </select>
          </div>
          <div class="form-group">
            <label for="maxScore">Highest Possible Score</label>
            <input type="number" id="maxScore" placeholder="e.g. 100">
          </div>
          <div class="form-group">
            <label for="dateAssigned">Date Assigned</label>
            <input type="date" id="dateAssigned">
          </div>
          <div class="form-group">
            <label for="itemScore">Score</label>
            <input type="number" id="itemScore" placeholder="e.g. 85">
          </div>
          <div class="form-group">
            <label for="itemComment">Comment</label>
            <input type="text" id="itemComment" placeholder="Short comment">
          </div>
        </div>
        <div class="form-actions">
          <button class="btn-cancel" onclick="toggleAddForm(false)">Cancel</button>
          <button class="btn-primary" onclick="saveGradeItem()">Save Grade Item</button>
        </div>
      </div>
      
      <div class="add-item-controls">
        <button class="btn-primary" onclick="toggleAddForm(true)" id="addItemBtn">+ Add New Grade Item</button>
        <button class="btn-primary" onclick="toggleAssessmentForm(true)" id="addAssessmentBtn" style="margin-left:12px;">+ Add Assessment Item</button>
      </div>
      
      <!-- Add Assessment Item Form -->
      <div class="add-grade-form-card" id="addAssessmentForm" style="display:none;">
        <h3>Add Assessment Item</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="assessTitle">Title</label>
            <input type="text" id="assessTitle" placeholder="e.g. Practice Quiz 1">
          </div>
          <div class="form-group">
            <label for="assessTopic">Topic</label>
            <input type="text" id="assessTopic" placeholder="e.g. Algebra">
          </div>
          <div class="form-group">
            <label for="assessDate">Date Assigned</label>
            <input type="date" id="assessDate">
          </div>
          <div class="form-group">
            <label for="assessScore">Score</label>
            <input type="number" id="assessScore" placeholder="e.g. 18">
          </div>
          <div class="form-group">
            <label for="assessMax">Highest Possible Score</label>
            <input type="number" id="assessMax" placeholder="e.g. 20" value="100">
          </div>
          <div class="form-group">
            <label for="assessComment">Comment</label>
            <input type="text" id="assessComment" placeholder="Short comment">
          </div>
        </div>
        <div class="form-actions">
          <button class="btn-cancel" onclick="toggleAssessmentForm(false)">Cancel</button>
          <button class="btn-primary" onclick="saveAssessmentItem()">Save Assessment Item</button>
        </div>
      </div>

    </div>
    
    <div id="studentGradesSection" class="hidden">
      <h3>Student Grades</h3>
      <table class="grade-table" id="studentGradesTable">
        <thead>
          <tr>
            <th>Grade Item</th>
            <th>Score</th>
            <th>Max Score</th>
            <th>Percentage</th>
            <th>Comments</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Will be populated by JavaScript -->
        </tbody>
      </table>
      
      <div class="add-grade-form" id="addScoreForm" style="display: none;">
        <h3>Add Student Score</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="gradeItemSelect">Grade Item</label>
            <select id="gradeItemSelect">
              <!-- Will be populated by JavaScript -->
            </select>
          </div>
          <div class="form-group">
            <label for="scoreValue">Score</label>
            <input type="number" id="scoreValue">
          </div>
          <div class="form-group">
            <label for="scoreMaxValue">Max Score</label>
            <input type="number" id="scoreMaxValue" disabled>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="scoreComments">Comments</label>
            <textarea id="scoreComments" rows="3"></textarea>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn-cancel" onclick="toggleScoreForm(false)">Cancel</button>
          <button class="btn-submit" onclick="saveStudentScore()">Save Score</button>
        </div>
      </div>
      
      <button class="action-btn" onclick="toggleScoreForm(true)" id="addScoreBtn">Add New Score</button>
    </div>
    
  
  </div>
  
  <script>
    // --- Routing: Only allow logged-in teachers ---
    const role = localStorage.getItem('role');
    const token = localStorage.getItem('token');
    const userName = localStorage.getItem('userName');
    const urlParamsAll = new URLSearchParams(window.location.search);
    const readOnlyMode = urlParamsAll.get('readonly') === '1';
    
    if (!role) {
      window.location.href = 'login.html';
    } else if (role !== 'teacher') {
      window.location.href = 'homepage1.html';
    }

    // Ensure Add Grade Item popup can be toggled even if a previous definition is missing
    if (typeof toggleAddForm !== 'function'){
      function toggleAddForm(show){
        const form = document.getElementById('addGradeForm');
        if (!form) return;
        form.style.display = show ? 'block' : 'none';
      }
    }
    // Assessment form handlers (front-end only for now)
    function clearAssessmentForm(){
      const ids = ['assessTitle','assessTopic','assessDate','assessScore','assessMax','assessComment'];
      ids.forEach(id=>{ const el=document.getElementById(id); if (!el) return; el.value = ''; });
      const max = document.getElementById('assessMax'); if (max) max.value = 100;
      const dt = document.getElementById('assessDate'); if (dt) dt.value = new Date().toISOString().split('T')[0];
    }
    function toggleAssessmentForm(show){
      const form = document.getElementById('addAssessmentForm');
      if (!form) return;
      if (show){ clearAssessmentForm(); }
      form.style.display = show ? 'block' : 'none';
    }
    function saveAssessmentItem(){
      const subjectId = urlParams.get('id') || localStorage.getItem('currentSubjectId');
      const title = document.getElementById('assessTitle').value.trim();
      const topic = document.getElementById('assessTopic').value.trim();
      const dateAssigned = document.getElementById('assessDate').value;
      const score = parseFloat(document.getElementById('assessScore').value);
      const max = parseFloat(document.getElementById('assessMax').value);
      const comment = (document.getElementById('assessComment')?.value || '').trim();
      if (!title || !topic || !dateAssigned || isNaN(score) || isNaN(max)){
        alert('Please fill out all assessment fields');
        return;
      }
      
      // Get existing assessments and add new one
      const assessments = getAssessmentMap();
      const newAssessment = {
        id: Date.now(), // Simple unique ID
        title,
        topic,
        dateAssigned,
        score,
        max,
        comment,
        subjectId,
        quarter: currentQuarter
      };
      assessments.push(newAssessment);
      setAssessmentMap(assessments);
      
      const tbody = document.getElementById('assessmentTable');
      if (tbody){
        const tr = document.createElement('tr');
        tr.dataset.assessmentId = String(newAssessment.id);
        tr.innerHTML = `<td>${title}</td><td>${topic}</td><td>${score}</td><td>${max}</td><td>${comment}</td>`;
        if (tbody.querySelector('td[colspan]')) tbody.innerHTML = '';
        tbody.appendChild(tr);
      }
      clearAssessmentForm();
      toggleAssessmentForm(false);
    }
    
    // Populate account dropdown with latest cached values
    (function(){
      try{
        const full = localStorage.getItem('fullName') || localStorage.getItem('userName') || 'Teacher';
        const email = localStorage.getItem('email') || '';
        const init = (full.charAt(0)||'T').toUpperCase();
        const iEl = document.getElementById('accountInitial'); if (iEl) iEl.textContent = init;
        const nEl = document.getElementById('userFullName'); if (nEl) nEl.textContent = full;
        const eEl = document.getElementById('userEmail'); if (eEl) eEl.textContent = email;
      }catch{}
    })();
    
    // --- Get subject from URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const subjectId = urlParams.get('id');
    const subjectName = urlParams.get('name') || "Subject";
document.getElementById('subjectTitle').textContent = subjectName;
    // Fetch subject details to show section/grade level
    (function fetchSubjectMeta(){
      if (!window.API_BASE || !subjectId) {
        console.error('Missing API_BASE or subjectId. Aborting loadGradeItems.');
        return;
      }

      fetch(`${window.API_BASE}/api/subjects?title=${encodeURIComponent(subjectName)}`)
        .then(r=>r.json())
        .then(list=>{
          const subj = Array.isArray(list) ? list.find(s=> (s.title||'')===subjectName) : null;
          if (subj){
            const sec = subj.section || subj.grade_level || '';
            if (sec){ const el=document.getElementById('sectionCode'); if (el) el.textContent = `Section: ${sec}`; }
          }
        }).catch(()=>{});
    })();
    
    // Global variables
    let currentQuarter = 1;
    let currentCategory = 'pt';
    let gradeCategories = [];
    let gradeItems = [];
    let students = [];
    let selectedStudentId = '';
    let editingItemId = null;
    let editingScoreId = null;
    const initialStudentId = urlParams.get('student_id') || '';
    const viewMode = urlParams.get('view') === 'assessment' ? 'assessment' : 'final';
    
    // Helper function to get current student ID
    function getCurrentStudentId() {
      return selectedStudentId || initialStudentId || '';
    }
    
    // --- Initialize page ---
    function init() {
      loadStudents();
      loadGradeCategories();
      loadGradeItems();
      loadFormativeAssessments();
      
      // Set today's date as default for new items
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateAssigned').value = today;
    }
    
    // --- Navigation functions ---
    function goBack() {
      try{
        const id = urlParams.get('id') || subjectId || '';
        const name = urlParams.get('name') || subjectName || '';
        window.location.href = `subject.html?id=${encodeURIComponent(String(id))}&name=${encodeURIComponent(String(name))}`;
      }catch{
        window.location.href = 'subject.html';
      }
    }
    
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('role');
      localStorage.removeItem('userId');
      localStorage.removeItem('userName');
      window.location.href = 'login.html';
    }
    
    // --- Tab switching functions ---
    function switchQuarter(quarter) {
      currentQuarter = quarter;
      
      // Update active tab
      document.querySelectorAll('.quarter-tabs .tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.quarter-tabs .tab-button[data-quarter="${quarter}"]`).classList.add('active');
      
      // Reload data for the new quarter
      loadGradeCategories();
      loadGradeItems();
      loadFormativeAssessments();
      
      if (selectedStudentId) {
        loadStudentGrades();
      }
    }
    
    // Helper functions for the new layout
    function showErrorMessage(message) {
      // Create or update error banner
      let errorBanner = document.getElementById('errorBanner');
      if (!errorBanner) {
        errorBanner = document.createElement('div');
        errorBanner.id = 'errorBanner';
        errorBanner.className = 'error-banner';
        errorBanner.style.cssText = 'background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px; border-radius: 8px; margin: 16px 0; display: flex; align-items: center; justify-content: space-between;';
        
        // Use main content area as container
        const mainContent = document.querySelector('.main') || document.body;
        const firstElement = mainContent.querySelector('hr, .control-card, .back-btn');
        if (firstElement) {
          mainContent.insertBefore(errorBanner, firstElement);
        } else {
          mainContent.appendChild(errorBanner);
        }
      }
      
      errorBanner.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.style.display='none'" style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 18px;">&times;</button>
      `;
      errorBanner.style.display = 'flex';
    }
    
    function updateSelectedStudentDisplay() {
      const selectedStudentName = document.getElementById('selectedStudentName');
      const select = document.getElementById('studentSelect');
      if (selectedStudentName && select) {
        const selectedOption = select.options[select.selectedIndex];
        if (select.value && selectedOption) {
          selectedStudentName.textContent = selectedOption.textContent;
        } else {
          selectedStudentName.textContent = 'Select a student to view details';
        }
      }
    }
    
    function showAddFormForCategory(category) {
      currentCategory = category;
      toggleAddForm(true);
    }

    // --- UI-only score persistence (per grade item) ---
    function getUIScoreMap(){
      try{ return JSON.parse(localStorage.getItem('itemUIScores')||'{}'); }catch{ return {}; }
    }
    function setUIScoreMap(m){
      try{ localStorage.setItem('itemUIScores', JSON.stringify(m||{})); }catch{}
    }
    function getUIScore(itemId){ const m=getUIScoreMap(); return m && m[itemId]!=null ? m[itemId] : null; }
    function setUIScore(itemId, val){ const m=getUIScoreMap(); m[itemId]=val; setUIScoreMap(m); }
    // UI-only comment persistence (per grade item)
    function getUICommentMap(){
      try{ return JSON.parse(localStorage.getItem('itemUIComments')||'{}'); }catch{ return {}; }
    }
    function setUICommentMap(m){
      try{ localStorage.setItem('itemUIComments', JSON.stringify(m||{})); }catch{}
    }
    function getUIComment(itemId){ const m=getUICommentMap(); return m && m[itemId]!=null ? m[itemId] : ''; }
    function setUIComment(itemId, val){ const m=getUICommentMap(); m[itemId]=val||''; setUICommentMap(m); }
    
    // Formative assessment persistence
    function getAssessmentMap(){
      try{ return JSON.parse(localStorage.getItem('formativeAssessments')||'[]'); }catch{ return []; }
    }
    function setAssessmentMap(arr){
      try{ localStorage.setItem('formativeAssessments', JSON.stringify(arr||[])); }catch{}
    }
    
    function loadFormativeAssessments(){
      const tbody = document.getElementById('assessmentTable');
      if (!tbody) return;
      
      const assessments = getAssessmentMap();
      const filteredAssessments = assessments.filter(a => 
        a.subjectId === subjectId && a.quarter === currentQuarter
      );
      
      if (filteredAssessments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No items in this category</td></tr>';
        return;
      }
      
      tbody.innerHTML = '';
      filteredAssessments.forEach(assessment => {
        const tr = document.createElement('tr');
        tr.dataset.assessmentId = String(assessment.id);
        tr.innerHTML = `<td>${assessment.title}</td><td>${assessment.topic}</td><td>${assessment.score}</td><td>${assessment.max}</td><td>${assessment.comment}</td>`;
        tbody.appendChild(tr);
      });
    }
    
    // Optimistically render or update a graded item row (shows Score immediately)
    function renderOrUpdateItemRow({ id, title, topic, itemType, maxScore, dateAssigned, categoryName, comment }, uiScore){
      const tableId = itemType === 'Written Works' ? 'wwTable' : (itemType === 'Periodical Exam' ? 'peTable' : 'ptTable');
      const tbody = document.querySelector(`#${tableId} tbody`);
      if (!tbody) return;
      if (tbody.querySelector('.empty-state') || tbody.querySelector('td[colspan]')) tbody.innerHTML='';
      let row = id ? tbody.querySelector(`tr[data-item-id="${id}"]`) : null;
      if (!row){ row = document.createElement('tr'); if (id!=null) row.dataset.itemId = String(id); tbody.appendChild(row); }
      const dateText = dateAssigned ? new Date(dateAssigned).toLocaleDateString() : 'N/A';
      row.dataset.title = title || '';
      row.dataset.topic = topic || '';
      row.dataset.maxScore = String(maxScore || 0);
      row.dataset.dateAssigned = dateAssigned || '';
      row.dataset.categoryName = categoryName || itemType || '';
      row.dataset.comment = (comment || '').toString();
      if (uiScore!=null && uiScore!=='') { row.dataset.score = String(uiScore); } else { delete row.dataset.score; }
      row.innerHTML = `
        <td>${title || 'Untitled'}</td>
        <td>${topic || 'N/A'}</td>
        <td>${(uiScore!=null && uiScore!=='') ? uiScore : (row.dataset.score && row.dataset.score !== 'undefined' ? row.dataset.score : '-')}</td>
        <td>${maxScore || 0}</td>
        <td>${dateText}</td>
        <td>${categoryName || itemType || 'N/A'}</td>
        <td>${(comment || '').toString().slice(0,140)}</td>
        <td class="action-buttons">
          <button class="btn-delete" onclick="deleteGradeItem(${Number(id)||0})">Delete</button>
        </td>`;
    }
    
    function updateTotalWeight() {
      const ptWeight = parseFloat(document.getElementById('weightPT').value) || 0;
      const wwWeight = parseFloat(document.getElementById('weightWW').value) || 0;
      const peWeight = parseFloat(document.getElementById('weightPE').value) || 0;
      const total = ptWeight + wwWeight + peWeight;
      
      const totalElement = document.getElementById('totalWeight');
      if (totalElement) {
        totalElement.textContent = `${total}%`;
        totalElement.style.color = total === 100 ? '#059669' : '#dc2626';
      }
    }
    
    // --- Data loading functions ---
    function loadStudents() {
      const select = document.getElementById('studentSelect');
      if (!select) { return; }
      select.innerHTML = '<option value="">Loading students...</option>';
      
      // Use fallback URLs if primary fails
      const urls = [
        `${window.API_BASE}/api/subjects/${subjectId}/students`,
        `${window.API_BASE}/api/classes/${subjectId}/students`,
        `${window.API_BASE}/api/enrollments?subject_id=${subjectId}`
      ];
      
      async function tryLoadStudents() {
        let lastError;
        
        for (const url of urls) {
          try {
            const res = await fetch(url);
            if (res.ok) {
              const data = await res.json();
              if (!data || (Array.isArray(data) && data.length === 0)) {
                console.warn(`Empty data returned from ${url}`);
                continue; // try next fallback URL
              }
              students = Array.isArray(data) ? data : data.students || [];
              
              // Clear and populate select
              select.innerHTML = '<option value="">All Students</option>';
              
              if (students.length === 0) {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = 'No students enrolled';
                select.appendChild(option);
              } else {
                students.forEach(student => {
                  const option = document.createElement('option');
                  option.value = student.id;
                  option.textContent = student.full_name || student.name || 'Unknown Student';
                  select.appendChild(option);
                });
                
                // Preselect from URL if provided
                if (initialStudentId) {
                  select.value = initialStudentId;
                  selectedStudentId = initialStudentId;
                  loadStudentGrades();
                  loadGradeItems();
                }
              }
              
              updateSelectedStudentDisplay();
              return; // Success, exit
            }
          } catch (err) {
            lastError = err;
            console.warn(`Failed to load from ${url}:`, err);
          }
        }
        
        // All URLs failed
        throw lastError || new Error('All student loading endpoints failed');
      }
      
      tryLoadStudents().catch(err => {
        console.error('Error loading students:', err);
        select.innerHTML = '<option value="">Failed to load students</option>';
        showErrorMessage('Unable to load students. Please refresh the page or contact support.');
      });
    }
    
    function loadGradeCategories() {
      if (!window.API_BASE || !subjectId) {
        console.error('Missing API_BASE or subjectId. Aborting loadGradeItems.');
        return;
      }

      fetch(`${window.API_BASE}/api/subjects/${subjectId}/categories?quarter=${currentQuarter}`, { headers: (typeof authHeaders==='function'? authHeaders() : {}) })
      .then(res => {
        if (!res.ok) throw new Error('Failed to load grade categories');
        return res.json();
      })
      .then(data => {
        gradeCategories = data;
        
        // Update weight inputs
        const ptCategory = gradeCategories.find(cat => cat.name === 'Performance Task');
        const wwCategory = gradeCategories.find(cat => cat.name === 'Written Works');
        const peCategory = gradeCategories.find(cat => cat.name === 'Periodical Exam');
        
        if (ptCategory) document.getElementById('weightPT').value = ptCategory.weight;
        if (wwCategory) document.getElementById('weightWW').value = wwCategory.weight;
        if (peCategory) document.getElementById('weightPE').value = peCategory.weight;

        // Update displayed category weight labels in headers
        const ptW = document.getElementById('ptWeight');
        const wwW = document.getElementById('wwWeight');
        const peW = document.getElementById('peWeight');
        if (ptW && ptCategory) ptW.textContent = ptCategory.weight;
        if (wwW && wwCategory) wwW.textContent = wwCategory.weight;
        if (peW && peCategory) peW.textContent = peCategory.weight;
      })
      .catch(err => {
        console.error('Error loading grade categories:', err);
      });
    }
    
    function loadGradeItems() {
      // Show loading state in all tables
      const tables = ['ptTable', 'wwTable', 'peTable'];
      tables.forEach(tableId => {
        const tbody = document.querySelector(`#${tableId} tbody`);
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="8" class="loading-text">Loading grade items...</td></tr>';
        }
      });
      
      // Try multiple endpoints
      const urls = [
        `${window.API_BASE}/api/subjects/${subjectId}/items?quarter=${currentQuarter}`,
        `${window.API_BASE}/api/classes/${subjectId}/items?quarter=${currentQuarter}`,
        `${window.API_BASE}/api/grade-items?subject_id=${subjectId}&quarter=${currentQuarter}`
      ];
      
      async function tryLoadGradeItems() {
        let lastError;
        let hasData = false;
        
        for (const url of urls) {
          try {
            const res = await fetch(url, { headers: (typeof authHeaders==='function'? authHeaders() : {}) });
            if (res.ok) {
              const data = await res.json();
              if (!data || (Array.isArray(data) && data.length === 0)) {
                console.warn(`Empty data returned from ${url}`);
                // Treat empty response as valid (no items) rather than trying fallback URLs
                gradeItems = [];
                hasData = true;
                break; // Exit the loop, we have valid data (even if empty)
              }
              gradeItems = Array.isArray(data) ? data : data.items || [];
              hasData = true;
              
              // Clear all tables first
              tables.forEach(tableId => {
                const tbody = document.querySelector(`#${tableId} tbody`);
                if (tbody) tbody.innerHTML = '';
              });
              
              if (gradeItems.length === 0) {
                tables.forEach(tableId => {
                  const tbody = document.querySelector(`#${tableId} tbody`);
                  if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No grade items found for this quarter</td></tr>';
                  }
                });
              } else {
                // Populate tables by category
                gradeItems.forEach(item => {
                  const categoryName = gradeCategories.find(cat => cat.id === item.category_id)?.name;
                  let tableId;
                  
                  if (categoryName === 'Performance Task') tableId = 'ptTable';
                  else if (categoryName === 'Written Works') tableId = 'wwTable';
                  else if (categoryName === 'Periodical Exam') tableId = 'peTable';
                  else return;
                  
                  const tbody = document.querySelector(`#${tableId} tbody`);
                  if (!tbody) return;
                  
                  // Clear empty state if this is the first item for this table
                  if (tbody.querySelector('.empty-state')) {
                    tbody.innerHTML = '';
                  }
                  
                  const row = document.createElement('tr');
                  const dateAssigned = item.date_assigned ? new Date(item.date_assigned).toLocaleDateString() : 'N/A';
                  
                  const uiScore = getUIScore(item.id);
                  const uiComment = getUIComment(item.id);
                  row.dataset.itemId = String(item.id || '');
                  row.dataset.title = item.title || '';
                  row.dataset.topic = item.topic || '';
                  row.dataset.score = String(item.score);
                  row.dataset.maxScore = String(item.max_score || 0);
                  row.dataset.dateAssigned = item.date_assigned || '';
                  row.dataset.categoryName = categoryName || '';
                  row.dataset.comment = (item.comment || item.comments || uiComment || '').toString();
                  if (uiScore!=null && uiScore!=='') { row.dataset.score = String(uiScore); }
                  row.innerHTML = `
                    <td>${item.title || 'Untitled'}</td>
                    <td>${item.topic || 'N/A'}</td>
                    <td>${(uiScore!=null && uiScore!=='') ? uiScore : (item.score != null && item.score !== '' ? item.score : '-')}</td>
                    <td>${item.max_score || 0}</td>
                    <td>${dateAssigned}</td>
                    <td>${categoryName || 'N/A'}</td>
                    <td>${(item.comment || item.comments || uiComment || '').toString().slice(0,140)}</td>
                    <td class="action-buttons">
                      <button class="btn-delete" onclick="deleteGradeItem(${item.id})">Delete</button>
                    </td>
                  `;
                  
                  tbody.appendChild(row);
                });
                
                // Set empty state for tables that have no items
                tables.forEach(tableId => {
                  const tbody = document.querySelector(`#${tableId} tbody`);
                  if (tbody && tbody.children.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No items in this category</td></tr>';
                  }
                });

                // If a student is present in URL, load their scores and populate the Score/Comment columns
                if (getCurrentStudentId() || role === 'teacher') {
                  loadStudentScoresForItems().catch(e => console.warn('Non-fatal: failed to load student scores', e));
                }

                async function loadStudentScoresForItems() {
                  if (!window.API_BASE || !subjectId || !getCurrentStudentId()) return;
                          
                  const res = await fetch(
                    `${window.API_BASE}/api/subjects/${subjectId}/scores?student_id=${getCurrentStudentId()}&quarter=${currentQuarter}`,
                    { headers: (typeof authHeaders==='function'? authHeaders() : {}) }
                  );
                          
                  if (!res.ok) throw new Error('Failed to load student scores');
                          
                  const data = await res.json();
                  if (!data || (!Array.isArray(data) && !data.scores)) throw new Error('Invalid or empty scores data');
                          
                  const scores = Array.isArray(data) ? data : (data.scores || []);
                  const byItem = {};
                          
                  scores.forEach(sc => {
                    const gid = Number(sc.grade_item_id ?? sc.item_id);
                    const score =
                      sc.score ?? sc.value ?? sc.points ?? sc.grade ?? null; // fallback for API variations
                    const comment =
                      sc.comments ?? sc.comment ?? sc.remark ?? ''; // common fallback keys
                    if (!isNaN(gid)) byItem[gid] = { score, comment };
                  });
                
                  ['ptTable', 'wwTable', 'peTable'].forEach(tid => {
                    const tb = document.querySelector(`#${tid} tbody`);
                    if (!tb) return;

                    tb.querySelectorAll('tr[data-item-id]').forEach(tr => {
                      const iid = Number(tr.dataset.itemId);
                      if (!isNaN(iid) && byItem[iid]) {
                        const { score, comments } = byItem[iid];
                        const tds = tr.querySelectorAll('td');
                        if (tds[2]) tds[2].textContent = score ?? '-';
                        if (tds[6]) {
                          const cleanComment = (comments || '')
                            .toString()
                            .replace(/^"|"$/g, ''); // remove surrounding quotes
                          tds[6].textContent = cleanComment && cleanComment.trim() !== '' ? cleanComment : '-';
                        }
                      }
                    });
                  });
              }

              }
              
              // Update grade item select for student scoring
              updateGradeItemSelect();
              return; // Success, exit
            }
          } catch (err) {
            lastError = err;
            console.warn(`Failed to load from ${url}:`, err);
          }
        }
        
        // Only throw error if we didn't get any valid response
        if (!hasData) {
          throw lastError || new Error('All grade items endpoints failed');
        } else {
          // Render empty state if we have valid data but no items
          if (gradeItems.length === 0) {
            tables.forEach(tableId => {
              const tbody = document.querySelector(`#${tableId} tbody`);
              if (tbody) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No items in this category</td></tr>';
              }
            });
          }
        }
      }
      
      tryLoadGradeItems().catch(err => {
        console.error('Error loading grade items:', err);

        // Only show error if nothing was rendered
        const hasAnyRow = ['ptTable','wwTable','peTable'].some(id => {
          const tb = document.querySelector(`#${id} tbody`);
          return tb && tb.querySelector('tr[data-item-id]');
        });

        if (!hasAnyRow) {
          ['ptTable','wwTable','peTable'].forEach(tableId => {
            const tbody = document.querySelector(`#${tableId} tbody`);
            if (tbody) {
              tbody.innerHTML = '<tr><td colspan="8" class="error-state">Failed to load grade items. Please refresh the page.</td></tr>';
            }
          });
          showErrorMessage('Unable to load grade items. Please refresh the page or contact support.');
        } else {
          console.warn('Suppressed error UI because data was already loaded.');
        }
      });
    }
    
    function loadStudentGrades() {
      const selEl = document.getElementById('studentSelect');
      selectedStudentId = (selEl ? selEl.value : '') || getCurrentStudentId();
      updateSelectedStudentDisplay();
      
      const tbody = document.querySelector('#studentGradesTable tbody');
      if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="loading-text">Loading student grades...</td></tr>';

      if (!selectedStudentId) {
        document.getElementById('studentGradesSection').classList.add('hidden');
        updateSelectedStudentDisplay();
        return;
      }
      
      // Try multiple endpoints
      const urls = [
        `${window.API_BASE}/api/subjects/${subjectId}/scores?student_id=${getCurrentStudentId()}&quarter=${currentQuarter}`,
        `${window.API_BASE}/api/student-grades?subject_id=${subjectId}&student_id=${selectedStudentId}&quarter=${currentQuarter}`,
        `${window.API_BASE}/api/grades?subject=${subjectId}&student=${selectedStudentId}&quarter=${currentQuarter}`
      ];
      
      async function tryLoadStudentGrades() {
        let lastError;
        
        for (const url of urls) {
          try {
            const res = await fetch(url);
            if (res.ok) {
              const data = await res.json();
              if (!data || (Array.isArray(data) && data.length === 0)) {
                console.warn(`Empty data returned from ${url}`);
                continue; // try next fallback URL
              }
              const scores = Array.isArray(data) ? data : data.scores || [];
              
              const tbody = document.querySelector('#studentGradesTable tbody');
              if (!tbody) return;
              
              tbody.innerHTML = '';
              
              if (scores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No grades recorded for this student</td></tr>';
              } else {
                scores.forEach(score => {
                  const item = gradeItems.find(item => item.id === score.grade_item_id);
                  if (!item) return;
                  
                  // Filter by view mode if specified
                  const included = !!item.included_in_final;
                  if (viewMode === 'final' && !included) return;
                  if (viewMode === 'assessment' && included) return;
                  
                  const row = document.createElement('tr');
                  const percentage = item.max_score > 0 ? ((score.score / item.max_score) * 100).toFixed(1) : '0.0';
                  
                  row.innerHTML = `
                    <td>${item.title || 'Untitled'}</td>
                    <td>${score.score || 0}</td>
                    <td>${item.max_score || 0}</td>
                    <td>${percentage}%</td>
                    <td>${score.comments || ''}</td>
                    <td class="action-buttons">
                      <button class="btn-edit" onclick="editStudentScore(${score.id}, ${score.grade_item_id}, ${score.score}, \`${(score.comments || '').replace(/`/g, '\\`')}\`)">Edit</button>
                      <button class="btn-delete" onclick="deleteStudentScore(${score.id})">Delete</button>
                    </td>
                  `;
                  
                  tbody.appendChild(row);
                });
              }
              
              document.getElementById('studentGradesSection').classList.remove('hidden');
              document.dispatchEvent(new Event('grades:loaded'));
              return; // Success
            }
          } catch (err) {
            lastError = err;
            console.warn(`Failed to load from ${url}:`, err);
          }
        }
        
        throw lastError || new Error('All student grades endpoints failed');
      }
      
      tryLoadStudentGrades().catch(err => {
        console.error('Error loading student grades:', err);
        const tbody = document.querySelector('#studentGradesTable tbody');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="6" class="error-state">Failed to load student grades. Please try again.</td></tr>';
        }
      });
    }
    
    function toggleScoreForm(show) {
      const form = document.getElementById('addScoreForm');
      if (show) {
        form.style.display = 'block';
        editingScoreId = null;
        
        // Reset form
        document.getElementById('scoreValue').value = '';
        document.getElementById('scoreComments').value = '';
        
        // Update max score based on selected item
        updateMaxScore();
      } else {
        form.style.display = 'none';
      }
    }
    
    function updateGradeItemSelect() {
      const select = document.getElementById('gradeItemSelect');
      select.innerHTML = '';
      
      gradeItems.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.title;
        option.dataset.maxScore = item.max_score;
        select.appendChild(option);
      });
      
      updateMaxScore();
    }
    
    function updateMaxScore() {
      const select = document.getElementById('gradeItemSelect');
      const maxScoreInput = document.getElementById('scoreMaxValue');
      
      if (select.options.length > 0) {
        const selectedOption = select.options[select.selectedIndex];
        maxScoreInput.value = selectedOption.dataset.maxScore;
      }
    }
    
    // --- Save/update functions ---
    function saveWeights() {
      const ptWeight = parseFloat(document.getElementById('weightPT').value);
      const wwWeight = parseFloat(document.getElementById('weightWW').value);
      const peWeight = parseFloat(document.getElementById('weightPE').value);
      
      // Validate weights add up to 100%
      const totalWeight = ptWeight + wwWeight + peWeight;
      if (Math.abs(totalWeight - 100) > 0.01) {
        alert('Weights must add up to 100%');
        return;
      }
      
      const categories = [
        { name: 'Performance Task', weight: ptWeight, quarter: currentQuarter },
        { name: 'Written Works', weight: wwWeight, quarter: currentQuarter },
        { name: 'Periodical Exam', weight: peWeight, quarter: currentQuarter }
      ];
      if (!window.API_BASE || !subjectId) {
        console.error('Missing API_BASE or subjectId. Aborting loadGradeItems.');
        return;
      }

      fetch(`${window.API_BASE}/api/subjects/${subjectId}/categories`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ categories })
      })
      .then(res => {
        if (!res.ok) throw new Error('Failed to save weights');
        return res.json();
      })
      .then(() => {
        alert('Grade weights saved successfully');
        loadGradeCategories();
      })
      .catch(err => {
        console.error('Error saving weights:', err);
        alert('Failed to save weights. Please try again.');
      });
    }
    
    async function ensureCategoriesForItemType(itemType){
      try{
        const required = ['Performance Task','Written Works','Periodical Exam'];
        const haveAll = Array.isArray(gradeCategories) && required.every(n => gradeCategories.some(c => c && c.name === n));
        if (!haveAll){
          const ptWeight = parseFloat(document.getElementById('weightPT').value) || 0;
          const wwWeight = parseFloat(document.getElementById('weightWW').value) || 0;
          const peWeight = parseFloat(document.getElementById('weightPE').value) || 0;
          const total = ptWeight + wwWeight + peWeight;
          if (Math.abs(total - 100) > 0.01){
            alert('Weights must add up to 100%');
            return null;
          }
          const categories = [
            { name:'Performance Task', weight: ptWeight, quarter: currentQuarter },
            { name:'Written Works', weight: wwWeight, quarter: currentQuarter },
            { name:'Periodical Exam', weight: peWeight, quarter: currentQuarter }
          ];
          const res = await fetch(`${window.API_BASE}/api/subjects/${subjectId}/categories`, {
            method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ categories })
          });
          if (!res.ok) throw new Error('Failed to save weights');
          // Refresh local categories
          const getRes = await fetch(`${window.API_BASE}/api/subjects/${subjectId}/categories?quarter=${currentQuarter}`);
          if (getRes.ok){ gradeCategories = await getRes.json(); }
          // Update headers with latest weights
          (function(){
            try{
              const ptCategory = gradeCategories.find(cat => cat.name === 'Performance Task');
              const wwCategory = gradeCategories.find(cat => cat.name === 'Written Works');
              const peCategory = gradeCategories.find(cat => cat.name === 'Periodical Exam');
              const ptW = document.getElementById('ptWeight');
              const wwW = document.getElementById('wwWeight');
              const peW = document.getElementById('peWeight');
              if (ptW && ptCategory) ptW.textContent = ptCategory.weight;
              if (wwW && wwCategory) wwW.textContent = wwCategory.weight;
              if (peW && peCategory) peW.textContent = peCategory.weight;
            }catch{}
          })();
        }
        const c = gradeCategories.find(cat => cat && cat.name === itemType);
        return c ? c.id : null;
      }catch(err){ console.error('ensureCategoriesForItemType error:', err); return null; }
    }
    
    async function saveGradeItem() {
      const title = document.getElementById('itemTitle').value.trim();
      const topic = document.getElementById('itemTopic').value.trim();
      const itemType = document.getElementById('itemType').value;
      const maxScore = parseFloat(document.getElementById('maxScore').value);
      const dateAssigned = document.getElementById('dateAssigned').value;
      const scoreValue = parseFloat(document.getElementById('itemScore').value);
      const comment = document.getElementById('itemComment').value.trim();
      const includedInFinal = true;
      
      if (!title) { alert('Title is required'); return; }
      if (isNaN(maxScore) || maxScore <= 0) { alert('Max score must be a positive number'); return; }
      
      // Determine or create category id
      let categoryId;
      if (itemType === 'Performance Task') {
        categoryId = gradeCategories.find(cat => cat.name === 'Performance Task')?.id;
      } else if (itemType === 'Written Works') {
        categoryId = gradeCategories.find(cat => cat.name === 'Written Works')?.id;
      } else if (itemType === 'Periodical Exam') {
        categoryId = gradeCategories.find(cat => cat.name === 'Periodical Exam')?.id;
      }
      if (!categoryId) {
        categoryId = await ensureCategoriesForItemType(itemType);
      }
      if (!categoryId) { return; }
      
      const item = {
        title,
        topic,
        item_type: itemType,
        max_score: maxScore,
        date_assigned: dateAssigned,
        included_in_final: includedInFinal,
        category_id: categoryId,
        comment
      };
      if (editingItemId) { item.id = editingItemId; }
      
      // No optimistic item row creation to avoid duplicates; rely on reload after save
      if (!isNaN(scoreValue) && editingItemId){ setUIScore(editingItemId, Number(scoreValue)); }
      if (editingItemId){ setUIComment(editingItemId, comment); }
      
      const isEditing = !!editingItemId;
      const url = isEditing ? `${window.API_BASE}/api/subjects/${subjectId}/items/${editingItemId}` : `${window.API_BASE}/api/subjects/${subjectId}/items`;
      const method = isEditing ? 'PUT' : 'POST';
      const payload = isEditing ? item : { items: [item] };
      
      if (!window.API_BASE || !subjectId) {
        console.error('Missing API_BASE or subjectId. Aborting loadGradeItems.');
        return;
      }


      fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
      .then(res => { if (!res.ok) throw new Error('Failed to save grade item'); return res.json().catch(()=>({})); })
      .then(async (_saved) => {
        alert('Grade item saved successfully');
        // Reload items to get authoritative list with IDs
        await loadGradeItems();
        toggleAddForm(false);
        editingItemId = null;

        // If a student is selected and an initial score/comment was provided, resolve the new item's id and post the score
        if (getCurrentStudentId() && !isNaN(scoreValue)){
          try{
            const listRes = await fetch(`${window.API_BASE}/api/subjects/${subjectId}/items?quarter=${currentQuarter}`);
            if (listRes.ok){
              const data = await listRes.json();
              const itemsList = Array.isArray(data) ? data : (data.items || []);
              // Find the most recent item matching the submitted fields
              const match = itemsList
                .filter(i => (i.title||'')===title && (i.topic||'')===topic && Number(i.max_score)===Number(maxScore))
                .sort((a,b)=> new Date(b.date_assigned||0) - new Date(a.date_assigned||0))[0];
              const resolvedId = match?.id;
              if (resolvedId){
                await fetch(`${window.API_BASE}/api/subjects/${subjectId}/scores`, {
                  method: 'POST', headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ grade_item_id: resolvedId, student_id: getCurrentStudentId(), score: scoreValue, comments: comment })
                });
                // Update UI caches for immediate reflect
                setUIScore(resolvedId, scoreValue);
                setUIComment(resolvedId, comment);
                await loadStudentGrades();
              }
            }
          }catch(err){ console.warn('Failed to resolve new item id or save initial score:', err); }
        }
      })
      .catch(err => { console.error('Error saving grade item:', err); alert('Failed to save grade item. Please try again.'); });
    }
    
    function saveStudentScore() {
      const gradeItemId = document.getElementById('gradeItemSelect').value;
      const score = parseFloat(document.getElementById('scoreValue').value);
      const maxScore = parseFloat(document.getElementById('scoreMaxValue').value);
      const comments = document.getElementById('scoreComments').value.trim();
      
      if (isNaN(score)) {
        alert('Score is required and must be a number');
        return;
      }
      
      if (score < 0 || score > maxScore) {
        alert(`Score must be between 0 and ${maxScore}`);
        return;
      }
      
      const scoreData = {
        grade_item_id: gradeItemId,
        student_id: selectedStudentId,
        score,
        comments
      };
      
      if (!confirm('Save this score?')) return;
      if (!window.API_BASE || !subjectId) {
        console.error('Missing API_BASE or subjectId. Aborting loadGradeItems.');
        return;
      }
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/scores`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(scoreData)
      })
      .then(res => {
        if (!res.ok) throw new Error('Failed to save score');
        return res.json();
      })
      .then(() => {
        alert('Score saved successfully');
        toggleScoreForm(false);
        loadStudentGrades();
        loadGradeItems();
      })
      .catch(err => {
        console.error('Error saving score:', err);
        alert('Failed to save score. Please try again.');
      });
    }
    
    // --- Edit/delete functions ---
    function editGradeItem(id, el) {
      let item = gradeItems.find(item => item.id === id);
      // DOM fallback if not found (optimistic rows before reload)
      if (!item && el){
        const tr = el.closest('tr');
        if (tr){
          item = {
            id: Number(tr.dataset.itemId) || id,
            title: tr.dataset.title || '',
            topic: tr.dataset.topic || '',
            item_type: tr.dataset.categoryName || 'Performance Task',
            max_score: Number(tr.dataset.maxScore) || 0,
            date_assigned: tr.dataset.dateAssigned || '',
            included_in_final: true,
            category_id: (function(){ const c=gradeCategories.find(cat=>cat.name===(tr.dataset.categoryName||'Performance Task')); return c?c.id:null; })(),
            comment: tr.dataset.comment || ''
          };
        }
      }
      if (!item) return;
      
      editingItemId = id;
      
      document.getElementById('itemTitle').value = item.title;
      document.getElementById('itemTopic').value = item.topic || '';
      // Map category_id to select value (Performance Task, Written Works, Periodical Exam)
      (function(){
        try{
          const cat = item.category_id ? gradeCategories.find(c=> c.id === item.category_id) : gradeCategories.find(c=> c.name === (item.item_type || item.itemType));
          const name = cat ? cat.name : (item.item_type || 'Performance Task');
          document.getElementById('itemType').value = name;
        }catch{ document.getElementById('itemType').value = 'Performance Task'; }
      })();
      document.getElementById('maxScore').value = item.max_score;
      // includedInFinal field may not exist in the form; guard it
      try{ const inc=document.getElementById('includedInFinal'); if (inc) inc.value = item.included_in_final ? 'true' : 'false'; }catch{}
      
      if (item.date_assigned) {
        document.getElementById('dateAssigned').value = item.date_assigned.split('T')[0];
      }
      // Load UI-only score into the form if present
      const us = getUIScore(id);
      const sEl = document.getElementById('itemScore'); if (sEl) sEl.value = (us!=null? us : '');
      
      toggleAddForm(true);
    }
    
    function deleteGradeItem(id) {
      if (!confirm('Are you sure you want to delete this grade item? This will also delete all associated scores.')) {
        return;
      }
      if (!window.API_BASE || !subjectId) {
        console.error('Missing API_BASE or subjectId. Aborting loadGradeItems.');
        return;
      }
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/items/${id}`, { method: 'DELETE' })
      .then(res => {
        if (!res.ok) throw new Error('Failed to delete grade item');
        return res.json();
      })
      .then(() => {
        alert('Grade item deleted successfully');
        loadGradeItems();
      })
      .catch(err => {
        console.error('Error deleting grade item:', err);
        alert('Failed to delete grade item. Please try again.');
      });
    }
    
    function editStudentScore(id, gradeItemId, scoreValue, comments) {
      editingScoreId = id;
      
      document.getElementById('gradeItemSelect').value = gradeItemId;
      document.getElementById('scoreValue').value = scoreValue;
      document.getElementById('scoreComments').value = comments;
      
      updateMaxScore();
      toggleScoreForm(true);
    }
    
    function deleteStudentScore(id) {
      if (!confirm('Are you sure you want to delete this score?')) {
        return;
      }
      if (!window.API_BASE || !subjectId) {
        console.error('Missing API_BASE or subjectId. Aborting loadGradeItems.');
        return;
      }
      fetch(`${window.API_BASE}/api/subjects/${subjectId}/scores/${id}`, { method: 'DELETE' })
      .then(res => {
        if (!res.ok) throw new Error('Failed to delete score');
        return res.json();
      })
      .then(() => {
        alert('Score deleted successfully');
        loadStudentGrades();
      })
      .catch(err => {
        console.error('Error deleting score:', err);
      });
    }
    
    // Initialize the page
  document.addEventListener('DOMContentLoaded', function() {
      // Add event listeners for weight inputs
      const weightInputs = ['weightPT', 'weightWW', 'weightPE'];
      weightInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
          input.addEventListener('input', updateTotalWeight);
          input.addEventListener('change', updateTotalWeight);
        }
      });
      
      // Add event listener for student selection
      const studentSelect = document.getElementById('studentSelect');
      if (studentSelect) {
        studentSelect.addEventListener('change', function() {
          selectedStudentId = this.value;
          loadGradeItems();   // reload main table with correct scores
          loadStudentGrades();
          updateSelectedStudentDisplay();
        });
      }
      
      // Add event listener for grade item select
      const gradeItemSelect = document.getElementById('gradeItemSelect');
      if (gradeItemSelect) {
        gradeItemSelect.addEventListener('change', updateMaxScore);
      }
      
      // Apply read-only mode if requested
      if (readOnlyMode) {
        document.querySelectorAll('.action-buttons').forEach(el => el.style.display = 'none');
        const addItemBtn = document.getElementById('addItemBtn'); if (addItemBtn) addItemBtn.style.display = 'none';
        const addScoreBtn = document.getElementById('addScoreBtn'); if (addScoreBtn) addScoreBtn.style.display = 'none';
        const saveWeightsBtn = document.getElementById('saveWeightsBtn'); if (saveWeightsBtn) saveWeightsBtn.style.display = 'none';
        weightInputs.forEach(id => {
          const input = document.getElementById(id);
          if (input) input.readOnly = true;
        });
      }
      
      // Initialize page data
      init();
      
      // Update total weight on page load
      updateTotalWeight();

      // Initialize tab switching for graded vs assessment
      const tabs = document.querySelectorAll('.tabs .tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          const which = tab.getAttribute('data-tab');
          const graded = document.getElementById('gradedContent');
          const assess = document.getElementById('assessmentContent');
          if (graded && assess){
            graded.classList.toggle('active', which === 'graded');
            assess.classList.toggle('active', which === 'assessment');
          }
        });
      });
    });
  </script>  
  <style>
    /* Enhanced styling for teacher grades page */
    .control-card {
      background: var(--card);
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }
    
    .control-card:hover {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }
    
    .control-card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text);
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
    }
    
    .control-card-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: var(--primary);
      border-radius: 2px;
      margin-right: 12px;
    }
    
    .student-selector {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .selector-label {
      font-weight: 500;
      color: var(--text);
      min-width: 120px;
    }
    
    .student-select {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }
    
    .student-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .quarter-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .quarter-tab {
      padding: 10px 18px;
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .quarter-tab:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }
    
    .quarter-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 12px 20px;
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .tab:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }
    
    .tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .grade-section {
      margin-bottom: 32px;
    }
    
    .category-header {
      margin-bottom: 16px;
    }
    
    .category-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text);
      margin: 0;
      padding: 16px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px 8px 0 0;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .table-container {
      border: 1px solid #e2e8f0;
      border-radius: 0 0 8px 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .grades-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
    }
    
    .grades-table th {
      background: #f8fafc;
      padding: 14px 16px;
      text-align: left;
      font-weight: 600;
      color: var(--text);
      border-bottom: 2px solid #e2e8f0;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .grades-table td {
      padding: 14px 16px;
      border-bottom: 1px solid #f1f5f9;
      color: var(--text);
      vertical-align: middle;
    }
    
    .grades-table tbody tr:hover {
      background: #f8fafc;
    }
    
    .grades-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .control-card {
        padding: 16px;
      }
      
      .student-selector {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .selector-label {
        min-width: auto;
      }
      
      .quarter-tabs, .tabs {
        justify-content: center;
      }
      
      .quarter-tab, .tab {
        flex: 1;
        text-align: center;
        min-width: 80px;
      }
      
      .grades-table {
        font-size: 0.85rem;
      }
      
      .grades-table th, .grades-table td {
        padding: 10px 8px;
      }
    }
  </style>
</body>
</html>
