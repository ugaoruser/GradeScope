<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login - GradeTracker</title>
  <link rel="icon" href="../favicon.ico" type="image/x-icon" sizes="any">
  <link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&display=swap" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.5.0/remixicon.min.css">
  <link rel="stylesheet" href="styles.css">
  <script src="config.js" defer></script>
</head>
<body class="login-page">

  <div class="auth-container">
    <div class="auth-header">
      <h1>GradeTracker</h1>
      <p>Sign in to your account</p>
    </div>
    
    <div id="error-message" class="error-message" style="display: none;"></div>
    <div id="success-message" class="success-message" style="display: none;"></div>
    
    <form id="login-form" method="post" action="javascript:void(0)" novalidate>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required>
      </div>
      
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" required>
      </div>

      <br>
      
      <button type="submit" class="btn-login" id="login-btn">Log In</button>
    </form>
    
    <div class="auth-footer">
      <p>Don't have an account? <a href="signup.html">Sign up</a></p>
    </div>
  </div>

  <!-- Parent selection modal -->
  <div id="parent-modal" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:100;">
    <div style="background:#fff;border-radius:12px;padding:2rem;max-width:500px;width:90%;">
      <h2 style="text-align:center;margin-bottom:1rem;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Select Your Child</h2>
      <p style="text-align:center;color:#666;margin-bottom:1.5rem;">Choose which child's grades you'd like to view:</p>
      <div id="child-selector" style="display:grid;gap:1rem;margin:1rem 0;"></div>
      <div style="margin-top:1.5rem;display:flex;justify-content:space-between;align-items:center;">
        <button id="link-child-btn" style="background:#10b981;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:0.9rem;">+ Link Child</button>
        <button id="continue-btn" class="btn-login" style="flex:1;margin-left:1rem;" disabled>Continue</button>
      </div>
    </div>
  </div>

  <!-- Link child modal -->
  <div id="link-child-modal" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:110;">
    <div style="background:#fff;border-radius:12px;padding:2rem;max-width:400px;width:90%;">
      <h3 style="text-align:center;margin-bottom:1rem;">Link Child Account</h3>
      <p style="color:#666;margin-bottom:1rem;font-size:0.9rem;">Enter your child's email address to link their account:</p>
      <input type="email" id="child-email" placeholder="child@example.com" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;margin-bottom:1rem;">
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="cancel-link" style="background:#e5e7eb;color:#374151;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Cancel</button>
        <button id="confirm-link" style="background:#2563eb;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Link Child</button>
      </div>
    </div>
  </div>

  <script>
    // Rely on config.js initLogin(); provide a minimal fallback if it didn't bind.
    (function(){
      function ensureApiBase(){
        try{
          if (location.protocol === 'file:' && !window.ENV_API_BASE) {
            window.ENV_API_BASE = 'https://gradescope-a4hw.onrender.com';
          }
        }catch(e){}
      }

      // Function to handle child selection
      function showChildSelection(children) {
        const modal = document.getElementById('parent-modal');
        const childSelector = document.getElementById('child-selector');
        const continueBtn = document.getElementById('continue-btn');
        
        // Clear previous children
        childSelector.innerHTML = '';
        
        // Add each child as a selectable option
        children.forEach(child => {
          const childEl = document.createElement('div');
          childEl.className = 'child-option';
          childEl.innerHTML = `
            <input type="radio" name="child" id="child-${child.id}" value="${child.id}">
            <label for="child-${child.id}">${child.name} (${child.email})</label>
          `;
          childEl.addEventListener('click', () => {
            childEl.querySelector('input').checked = true;
            continueBtn.disabled = false;
          });
          childSelector.appendChild(childEl);
        });
        
        // Show the modal
        modal.style.display = 'flex';
        
        // Handle continue button
        continueBtn.onclick = () => {
          const selectedChild = document.querySelector('input[name="child"]:checked');
          if (selectedChild) {
            const child = children.find(c => c.id === selectedChild.value);
            if (child) {
              localStorage.setItem('selectedChildId', child.id);
              localStorage.setItem('selectedChildName', child.name);
              modal.style.display = 'none';
              window.location.href = 'homepage1.html';
            }
          }
        };
      }

      // Function to handle linking a new child
      function setupLinkChildModal() {
        const linkModal = document.getElementById('link-child-modal');
        const linkBtn = document.getElementById('link-child-btn');
        const cancelLink = document.getElementById('cancel-link');
        const confirmLink = document.getElementById('confirm-link');
        
        linkBtn?.addEventListener('click', () => {
          linkModal.style.display = 'flex';
        });
        
        cancelLink?.addEventListener('click', () => {
          linkModal.style.display = 'none';
        });
        
        confirmLink?.addEventListener('click', async () => {
          const childEmail = document.getElementById('child-email').value.trim();
          if (!childEmail) {
            alert('Please enter a valid email address');
            return;
          }
          
          try {
            const base = (window.API_BASE || window.ENV_API_BASE || `${location.protocol}//${location.host}`);
            const token = localStorage.getItem('token');
            const res = await fetch(`${base}/api/parent/link-child`, {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({ childEmail })
            });
            
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || 'Failed to link child account');
            
            // Refresh the child list
            const childrenRes = await fetch(`${base}/api/parent/children`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            const childrenData = await childrenRes.json();
            
            if (childrenRes.ok) {
              showChildSelection(childrenData);
              linkModal.style.display = 'none';
              document.getElementById('child-email').value = '';
            } else {
              throw new Error('Failed to fetch updated child list');
            }
          } catch (error) {
            alert(error.message || 'An error occurred while linking child account');
          }
        });
      }

      async function fallbackLogin(e) {
        e && e.preventDefault();
        try {
          const email = document.getElementById('email')?.value?.trim();
          const password = document.getElementById('password')?.value;
          if (!email || !password) { 
            alert('Please fill in all fields'); 
            return; 
          }
          
          const base = (window.API_BASE || window.ENV_API_BASE || `${location.protocol}//${location.host}`);
          const res = await fetch(`${base}/api/login`, {
            method: 'POST', 
            headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
            body: JSON.stringify({ email, password })
          });
          
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.message || `Login failed (${res.status})`);
          
          // Persist session data
          localStorage.setItem('token', data.token || '');
          localStorage.setItem('role', data.role || '');
          localStorage.setItem('userId', data.userId || '');
          localStorage.setItem('fullName', data.fullName || '');
          localStorage.setItem('email', email);
          
          // If parent, fetch and show children
          if (data.role === 'parent') {
            try {
              const childrenRes = await fetch(`${base}/api/parent/children`, {
                headers: { 'Authorization': `Bearer ${data.token}` }
              });
              const childrenData = await childrenRes.json();
              
              if (childrenRes.ok && childrenData.length > 0) {
                setupLinkChildModal();
                showChildSelection(childrenData);
                return; // Don't redirect yet, wait for child selection
              } else if (childrenRes.ok) {
                // No children linked yet, show option to link one
                setupLinkChildModal();
                document.getElementById('parent-modal').style.display = 'flex';
                return;
              }
            } catch (error) {
              console.error('Error fetching children:', error);
              // Continue to homepage even if there's an error
            }
          }
          
          // For non-parents or if there was an error, redirect to appropriate page
          window.location.href = data.role === 'teacher' ? 'homepage2.html' : 'homepage1.html';
        }catch(err){ alert(err.message || 'Login error'); }
      }
      document.addEventListener('DOMContentLoaded', function(){
        ensureApiBase();
        const form = document.getElementById('login-form');
        const btn = document.getElementById('login-btn');
        // If config.js didn't attach, ensure we have working handlers
        if (form) {
          let bound = false;
          try { bound = !!form._loginBound; } catch {}
          if (!bound) {
            form.addEventListener('submit', fallbackLogin);
            btn && btn.addEventListener('click', fallbackLogin);
            try{ form._loginBound = true; }catch{}
          }
        }
      });
    })();
  </script>
</body>
</html>
