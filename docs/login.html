<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login - GradeTracker</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&display=swap" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.5.0/remixicon.min.css">
  <link rel="stylesheet" href="styles.css">
  <script src="config.js" defer></script>
</head>
<body class="login-page">

  <div class="auth-container">
    <div class="auth-header">
      <h1>GradeTracker</h1>
      <p>Sign in to your account</p>
    </div>
    
    <div id="error-message" class="error-message" style="display: none;"></div>
    <div id="success-message" class="success-message" style="display: none;"></div>
    
    <form id="login-form" method="post" onsubmit="event.preventDefault();">
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required>
      </div>
      
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" required>
      </div>

      <br>
      
      <button type="submit" class="btn-login" id="login-btn">Log In</button>
      <div class="loading" id="loading">
        <div class="spinner"></div>
      </div>
    </form>
    
    <div class="auth-footer">
      <p>Don't have an account? <a href="signup.html">Sign up</a></p>
    </div>
  </div>

  <!-- Parent selection modal -->
  <div id="parent-modal" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:100;">
    <div style="background:#fff;border-radius:12px;padding:2rem;max-width:500px;width:90%;">
      <h2 style="text-align:center;margin-bottom:1rem;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Select Your Child</h2>
      <p style="text-align:center;color:#666;margin-bottom:1.5rem;">Choose which child's grades you'd like to view:</p>
      <div id="child-selector" style="display:grid;gap:1rem;margin:1rem 0;"></div>
      <div style="margin-top:1.5rem;display:flex;justify-content:space-between;align-items:center;">
        <button id="link-child-btn" style="background:#10b981;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:0.9rem;">+ Link Child</button>
        <button id="continue-btn" class="btn-login" style="flex:1;margin-left:1rem;" disabled>Continue</button>
      </div>
    </div>
  </div>

  <!-- Link child modal -->
  <div id="link-child-modal" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:110;">
    <div style="background:#fff;border-radius:12px;padding:2rem;max-width:400px;width:90%;">
      <h3 style="text-align:center;margin-bottom:1rem;">Link Child Account</h3>
      <p style="color:#666;margin-bottom:1rem;font-size:0.9rem;">Enter your child's email address to link their account:</p>
      <input type="email" id="child-email" placeholder="child@example.com" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;margin-bottom:1rem;">
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="cancel-link" style="background:#e5e7eb;color:#374151;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Cancel</button>
        <button id="confirm-link" style="background:#2563eb;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Link Child</button>
      </div>
    </div>
  </div>

  <script>
    // Immediate feedback for login button
    document.addEventListener('DOMContentLoaded', function() {
      const loginForm = document.getElementById('login-form');
      const loginBtn = document.getElementById('login-btn');
      const loading = document.getElementById('loading');
      const errorMessage = document.getElementById('error-message');
      const successMessage = document.getElementById('success-message');
      
      // Add immediate visual feedback on button click
      if (loginBtn) {
        loginBtn.addEventListener('click', function(e) {
          // Only show loading if form is valid
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          
          if (email && password) {
            // Show loading immediately
            this.disabled = true;
            this.textContent = 'Logging in...';
            loading.style.display = 'block';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
          }
        });
      }
      
      if (loginForm) {
        loginForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // Show loading immediately
          loginBtn.disabled = true;
          loginBtn.textContent = 'Logging in...';
          loading.style.display = 'block';
          errorMessage.style.display = 'none';
          successMessage.style.display = 'none';
          
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          
          try {
            const response = await fetch(`${window.API_BASE}/api/login`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, password })
            });
            
            const data = await response.json();
            
            if (response.ok) {
              // Success
              successMessage.textContent = 'Login successful! Redirecting...';
              successMessage.style.display = 'block';
              
              // Store auth data
              localStorage.setItem('token', data.token);
              localStorage.setItem('role', data.role);
              localStorage.setItem('firstName', data.firstName || '');
              localStorage.setItem('lastName', data.lastName || '');
              localStorage.setItem('email', data.email || email);
              
              // Handle role-based redirection
              if (data.role === 'parent' && data.children && data.children.length > 1) {
                // Show parent modal for multiple children
                showParentModal(data.children);
              } else {
                // Redirect based on role
                setTimeout(() => {
                  if (data.role === 'parent') {
                    window.location.href = 'homepage1.html';
                  } else if (data.role === 'student') {
                    window.location.href = 'homepage1.html';
                  } else if (data.role === 'teacher') {
                    window.location.href = 'homepage2.html';
                  } else {
                    window.location.href = 'index.html';
                  }
                }, 500);
              }
            } else {
              // Error
              errorMessage.textContent = data.message || 'Login failed. Please try again.';
              errorMessage.style.display = 'block';
            }
          } catch (error) {
            console.error('Login error:', error);
            errorMessage.textContent = 'Network error. Please check your connection and try again.';
            errorMessage.style.display = 'block';
          } finally {
            // Reset button state
            loginBtn.disabled = false;
            loginBtn.textContent = 'Log In';
            loading.style.display = 'none';
          }
        });
      }
      
      function showParentModal(children) {
        const modal = document.getElementById('parent-modal');
        const childSelector = document.getElementById('child-selector');
        const continueBtn = document.getElementById('continue-btn');
        
        if (!modal || !childSelector) return;
        
        // Clear previous options
        childSelector.innerHTML = '';
        
        // Add child options
        children.forEach((child, index) => {
          const childDiv = document.createElement('div');
          childDiv.style.cssText = 'padding:1rem;border:2px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all 0.2s;text-align:center;';
          childDiv.innerHTML = `
            <div style="font-size:2rem;margin-bottom:0.5rem;">${child.gender === 'female' ? 'üëß' : 'üë¶'}</div>
            <div style="font-weight:600;">${child.full_name}</div>
            <div style="color:#666;font-size:0.9rem;">${child.email}</div>
          `;
          
          childDiv.addEventListener('click', function() {
            document.querySelectorAll('#child-selector > div').forEach(d => {
              d.style.borderColor = '#e5e7eb';
              d.style.background = '#fff';
            });
            this.style.borderColor = '#2563eb';
            this.style.background = '#f0f8ff';
            
            localStorage.setItem('selectedChildId', child.id);
            localStorage.setItem('selectedChildName', child.full_name);
            continueBtn.disabled = false;
          });
          
          childSelector.appendChild(childDiv);
        });
        
        modal.style.display = 'flex';
        
        // Continue button handler
        continueBtn.onclick = function() {
          modal.style.display = 'none';
          window.location.href = 'homepage1.html';
        };
      }
      
      // Handle parent modal buttons
      const linkChildBtn = document.getElementById('link-child-btn');
      const linkChildModal = document.getElementById('link-child-modal');
      const cancelLinkBtn = document.getElementById('cancel-link');
      const confirmLinkBtn = document.getElementById('confirm-link');
      
      if (linkChildBtn) {
        linkChildBtn.addEventListener('click', () => {
          linkChildModal.style.display = 'flex';
        });
      }
      
      if (cancelLinkBtn) {
        cancelLinkBtn.addEventListener('click', () => {
          linkChildModal.style.display = 'none';
          document.getElementById('child-email').value = '';
        });
      }
      
      if (confirmLinkBtn) {
        confirmLinkBtn.addEventListener('click', async () => {
          const childEmail = document.getElementById('child-email').value;
          if (!childEmail) return;
          
          try {
            const response = await fetch(`${window.API_BASE}/api/link-child`, {
              method: 'POST',
              headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
              },
              body: JSON.stringify({ childEmail })
            });
            
            const result = await response.json();
            
            if (response.ok) {
              linkChildModal.style.display = 'none';
              document.getElementById('child-email').value = '';
              // Refresh parent modal with updated children list
              location.reload();
            } else {
              alert(result.message || 'Failed to link child');
            }
          } catch (error) {
            alert('Error linking child. Please try again.');
          }
        });
      }
    });
  </script>
</body>
</html>
