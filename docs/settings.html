<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GradeTracker â€” Settings</title>
  <link rel="icon" href="../favicon.ico" type="image/x-icon">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="styles.css">
  <script src="config.js" defer></script>
  <script src="app.js" defer></script>
</head>
<body class="settings-page">
  <div class="sidebar" data-shared="sidebar">
    <div class="top">
      <ul class="nav">
        <li id="goHome">Home</li>
        <li class="active">Settings</li>
        <li id="aboutBtn">About</li>
      </ul>
    </div>
    <div class="bottom">
      <div class="app-version">Grade Tracker v1.0</div>
    </div>
  </div>
  
  <div class="main">
    <header class="header" data-shared="header" style="margin-bottom:16px;">
      <div class="header-title">Settings</div>
      <div class="account-menu">
        <button class="account-btn" id="accountBtn"><span id="accountInitial">A</span></button>
        <div class="account-dropdown" id="accountDropdown" aria-hidden="true">
          <div class="account-info">
            <div id="userFullName">User Name</div>
            <div id="userEmail"></div>
          </div>
          <button id="logoutBtn" class="logout-btn">Log Out</button>
        </div>
      </div>
    </header>
    
    <div class="settings-container">
      <div class="settings-title">Account Settings</div>
      
      <div class="settings-grid">
        <div class="settings-card">
          <div class="settings-section-title">Profile Information</div>
          <ul style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:12px;">
            <li style="display:flex; align-items:center;"><strong style="min-width:100px;">First Name:</strong> <span id="displayFirstName" class="field-display" style="margin-left:8px; color:var(--text); background:#f8fafc; padding:8px 12px; border-radius:6px; flex:1;">Loading...</span></li>
            <li style="display:flex; align-items:center;"><strong style="min-width:100px;">Last Name:</strong> <span id="displayLastName" class="field-display" style="margin-left:8px; color:var(--text); background:#f8fafc; padding:8px 12px; border-radius:6px; flex:1;">Loading...</span></li>
            <li style="display:flex; align-items:center;"><strong style="min-width:100px;">Email:</strong> <span id="displayEmail" class="field-display" style="margin-left:8px; color:var(--text); background:#f8fafc; padding:8px 12px; border-radius:6px; flex:1;">Loading...</span></li>
          </ul>
          <div id="profileMsg" class="small" style="margin-top:6px;color:#64748b;font-style:italic;">Profile information is synced from your account</div>
        </div>

        <div class="settings-card" id="themeCard">
          <div class="settings-section-title">Appearance</div>
          <button id="toggleThemeBtn" class="btn btn-primary">Toggle Dark Mode</button>
        </div>

        <div class="settings-card" id="parentLinkCard" style="display:none;">
          <div class="settings-section-title">Link a Child (Parent)</div>
          <div class="form-group">
            <label for="childEmail">Child's Email</label>
            <input type="email" id="childEmail" placeholder="student@example.com">
          </div>
          <button id="linkChildBtn" class="btn btn-primary">Link Child</button>
          <div id="linkMsg" class="small" style="margin-top:8px;"></div>
          <div style="margin-top:12px;">
            <div style="font-weight:700;margin-bottom:6px;">Linked Children</div>
            <ul id="childrenList" style="list-style:disc;padding-left:20px;"></ul>
          </div>
        </div>

        <div class="settings-card danger">
          <div class="settings-section-title">Danger Zone</div>
          <p>Once you delete your account, there is no going back. Please be certain.</p>
          <button class="btn btn-danger" id="deleteAccountBtn">Delete Account</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="toast" style="position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#111827;color:#fff;padding:10px 14px;border-radius:8px;display:none;z-index:500;"></div>
  
  <!-- About Modal -->
<div id="aboutModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" tabindex="-1" style="display:none;">
    <div class="modal-panel">
      <div class="modal-header">
        <div class="modal-title">About GradeTracker</div>
        <button class="modal-close" id="closeAboutBtn" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <p>This website acts as a Grade Tracker to track the quizzes and scores of students in a faster way. It can be used by students, teachers, and parents.</p>
        <p><strong>Version:</strong> V1.0</p>
        <p><strong>Developed by:</strong> Group 4 Practical Research Group [12-Lovelace]</p>
      </div>
    </div>
  </div>
  
  
  <script>
    // Auth
    const token = localStorage.getItem('token');
    if (!token) { window.location.href = 'login.html'; }

    // Theme init
    (function(){
      const t = localStorage.getItem('theme') || 'light';
      document.documentElement.dataset.theme = t;
    })();

    // Load profile and populate fields
    async function loadUserProfile() {
      try {
        const response = await fetch(`${window.API_BASE}/api/me`);
        const userData = await response.json();
        
        if (response.ok) {
          // Update profile display fields
          const firstName = userData.firstName || localStorage.getItem('firstName') || 'N/A';
          const lastName = userData.lastName || localStorage.getItem('lastName') || 'N/A';
          const email = userData.email || localStorage.getItem('email') || 'N/A';
          
          document.getElementById('displayFirstName').textContent = firstName;
          document.getElementById('displayLastName').textContent = lastName;
          document.getElementById('displayEmail').textContent = email;
          
          // Update localStorage for future use
          localStorage.setItem('firstName', firstName);
          localStorage.setItem('lastName', lastName);
          localStorage.setItem('email', email);
          
          // Update account dropdown
          const fullName = userData.fullName || `${firstName} ${lastName}`.replace(/N\/A/g, '').trim() || 'User';
          const initial = (fullName.charAt(0) || 'U').toUpperCase();
          
          const initialEl = document.getElementById('accountInitial');
          const nameEl = document.getElementById('userFullName');
          const emailEl = document.getElementById('userEmail');
          
          if (initialEl) initialEl.textContent = initial;
          if (nameEl) nameEl.textContent = fullName;
          if (emailEl) emailEl.textContent = email;
          
          // Show parent card if user is a parent
          if (userData.role === 'parent') {
            document.getElementById('parentLinkCard').style.display = 'block';
            loadChildren();
          }
        } else {
          throw new Error('Failed to load profile');
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        // Fallback to localStorage if API fails
        const firstName = localStorage.getItem('firstName') || 'N/A';
        const lastName = localStorage.getItem('lastName') || 'N/A';
        const email = localStorage.getItem('email') || 'N/A';
        
        document.getElementById('displayFirstName').textContent = firstName;
        document.getElementById('displayLastName').textContent = lastName;
        document.getElementById('displayEmail').textContent = email;
      }
    }
    
    // Load profile on page load
    loadUserProfile();

    // About modal
    const aboutBtn = document.getElementById('aboutBtn');
    const aboutModal = document.getElementById('aboutModal');
    function showAbout(){ aboutModal.style.display = 'flex'; requestAnimationFrame(()=> aboutModal.classList.add('show')); }
    function closeAbout(){ aboutModal.classList.remove('show'); setTimeout(()=> aboutModal.style.display='none', 180); }
    aboutBtn.addEventListener('click', showAbout);

    // Sidebar navigation (Home)
    document.getElementById('goHome')?.addEventListener('click', ()=>{
      const role = localStorage.getItem('role');
      window.location.href = role === 'teacher' ? 'homepage2.html' : 'homepage1.html';
    });

    // Fast logout binding for settings page (use App.logout if available)
    document.getElementById('logoutBtn')?.addEventListener('click', ()=>{
      if (window.App && typeof window.App.logout === 'function') return window.App.logout();
      // Fallback if App.logout is not available
      ['token','role','user','fullName','email','selectedChildId','selectedChildName','firstName','lastName','userId'].forEach(k=> localStorage.removeItem(k));
      window.location.href = 'login.html';
    });

    // Save profile button removed - profile is read-only

    // Theme toggle
    document.getElementById('toggleThemeBtn').addEventListener('click', ()=>{
      const cur = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
      document.documentElement.dataset.theme = cur;
      localStorage.setItem('theme', cur);
      showToast(`Theme set to ${cur}`);
    });

    // Parent link actions
    function showToast(msg){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.style.display='block'; setTimeout(()=> t.style.display='none', 1600); }
    async function loadChildren(){
      try{ const r=await fetch(`${window.API_BASE}/api/children`); if(!r.ok) return; const children=await r.json(); const ul=document.getElementById('childrenList'); ul.innerHTML=''; children.forEach(c=>{ const li=document.createElement('li'); li.textContent=c.full_name; ul.appendChild(li); }); }catch{}
    }
    // Live refresh when a child is linked from another device
    (function(){
      try{
        const es = new EventSource(`${window.API_BASE}/api/events`);
        es.addEventListener('parentLinkUpdated', ()=>{ try{ loadChildren(); }catch{} });
        es.onerror = ()=>{ try{ es.close(); }catch{} };
      }catch{}
    })();
    document.getElementById('linkChildBtn').addEventListener('click', async()=>{
      const email = document.getElementById('childEmail').value.trim();
      const msg = document.getElementById('linkMsg'); msg.textContent='';
      if (!email) { msg.textContent='Please enter a child email.'; return; }
      try{
        const r = await fetch(`${window.API_BASE}/api/parent/link`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ childEmail: email }) });
        const d = await r.json(); if(!r.ok) throw new Error(d.message||'Failed');
        showToast('Linked successfully'); document.getElementById('childEmail').value=''; loadChildren();
      }catch(e){ msg.textContent = e.message; }
    });

    // Danger zone
    document.getElementById('deleteAccountBtn').addEventListener('click', () => {
      alert('Account deletion is not enabled in this demo.');
    });
    // Removed undefined element handlers
    
    // Profile editing disabled - display only
    
    // Password change disabled
    
    // Account deletion handled above with demo message
    
    // Close modals when clicking outside
    window.addEventListener('click', (event) => {
      if (event.target === aboutModal) {
        closeAbout();
      }
    });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAbout(); });
    // Dynamic home routing based on role
    document.getElementById('goHome').addEventListener('click', ()=>{
      const r = localStorage.getItem('role');
      location.href = r === 'teacher' ? 'homepage2.html' : 'homepage1.html';
    });
  </script>
</body>
</html>
